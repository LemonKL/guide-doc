<div>
<h2>（1）定义</h2>
<p>Java 中区分 API 和 SPI，通俗的讲：API 和 SPI 都是相对的概念，他们的差别只在语义上，API 直接被应用开发人员使用，SPI 被框架扩展人员使用</p>
<p><strong>API <code>Application Programming Interface</code></strong></p>
<p>大多数情况下，都是<code>实现方</code>来制定接口并完成对接口的不同实现，<code>调用方</code>仅仅依赖却无权选择不同实现。</p>
<p><strong>SPI <code>Service Provider Interface</code></strong></p>
<p>而如果是<code>调用方</code>来制定接口，<code>实现方</code>来针对接口来实现不同的实现。<code>调用方</code>来选择自己需要的<code>实现方</code>。</p>
<blockquote>
<p>More specifically, for Java libraries, what makes them an API and/or SPI?</p>
</blockquote>
<blockquote>
<p>the API is the description of classes/interfaces/methods/... that you call and use to achieve a goal</p>
</blockquote>
<blockquote>
<p>the SPI is the description of classes/interfaces/methods/... that you extend and implement to achieve a goal</p>
</blockquote>
<blockquote>
<p>Put differently, the API tells you what a specific class/method does for you and the SPI tells you what you must do to conform.</p>
</blockquote>
<p>从面向接口编程说起</p>
<div class="image-package">
<div class="image-container">
<div class="image-container-fill">&nbsp;</div>
<div class="image-view" data-width="602" data-height="172"><img class="" src="//upload-images.jianshu.io/upload_images/2183782-05b1f9011272dea6.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/602/format/webp" data-original-src="//upload-images.jianshu.io/upload_images/2183782-05b1f9011272dea6.jpg" data-original-width="602" data-original-height="172" data-original-format="image/jpeg" data-original-filesize="10017" /></div>
</div>
<div class="image-caption">接口调用.jpg</div>
</div>
<p>当我们选择在<code>调用方</code> 和 <code>实现方</code> 中间引入 <code>接口</code>。上图没有给出&ldquo;接口&rdquo;应该位于哪个&ldquo;包&rdquo;中，从纯粹的可能性上考虑，我们有三种选择：</p>
<ol>
<li><code>接口</code>位于<code>实现方</code>所在的包中</li>
<li><code>接口</code>位于<code>调用方</code>所在的包中</li>
<li><code>接口</code>位于独立的包中</li>
</ol>
<p>对于类似这种情况下接口，我们将其称为 <code>SPI</code>, <code>SPI</code>的规则如下：</p>
<ul>
<li>概念上更依赖调用方。</li>
<li>组织上位于调用方所在的包中。</li>
<li>实现位于独立的包中。</li>
</ul>
<p>常见的例子是：插件模式的插件。如：</p>
<ol>
<li>数据库驱动 Driver</li>
<li>日志 Log</li>
<li>dubbo扩展点开发</li>
</ol>
<h2><code>接口</code>位于<code>实现方</code>所在的包中</h2>
<p>对于类似这种情况下的接口，我们将其称作为<code>API</code>，<code>API</code>的规则如下：</p>
<ul>
<li>概念上更接近实现方。</li>
<li>组织上位于实现方所在的包中。</li>
</ul>
<h2><code>接口</code>位于独立的包中</h2>
<p>如果一个&ldquo;接口&rdquo;在一个上下文是<code>API</code>，在另一个上下文是<code>SPI</code>，那么你就可以这么组织</p>
<h2>需要注意的事项</h2>
<p><code>SPI</code> 和 <code>API</code> 也不一定是接口，我这里都是指狭义的具体的接口。</p>
<h2>另外一张图</h2>
<div class="image-package">
<div class="image-container">
<div class="image-container-fill">&nbsp;</div>
<div class="image-view" data-width="765" data-height="409"><img src="//upload-images.jianshu.io/upload_images/2183782-17f5411ca8f9e145.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/765/format/webp" width="300" height="200" data-original-src="//upload-images.jianshu.io/upload_images/2183782-17f5411ca8f9e145.png" data-original-width="765" data-original-height="409" data-original-format="image/png" data-original-filesize="101803" /></div>
</div>
<div class="image-caption">SPI和API区别.png</div>
</div>
</div>
<div class="image-caption">
<h2>（2）SPI实现</h2>
</div>
<div class="image-caption">
<p><strong>一、SPI</strong><strong>机制</strong></p>
<p>这里先说下SPI的一个概念，SPI英文为Service Provider Interface单从字面可以理解为Service提供者接口，正如从SPI的名字去理解SPI就是Service提供者接口；我对SPI的定义：提供给服务提供厂商与扩展框架功能的开发者使用的接口。</p>
<p>在我们日常开发的时候都是对问题进行抽象成Api然后就提供各种Api的实现，这些Api的实现都是封装与我们的Jar中或框架中的虽然当我们想要提供一种Api新实现时可以不修改原来代码只需实现该Api就可以提供Api的新实现，但我们还是生成新Jar或框架（虽然可以通过在代码里扫描某个目录已加载Api的新实现，但这不是Java的机制，只是hack方法），而通过Java SPI机制我们就可以在不修改Jar包或框架的时候为Api提供新实现。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; 很多框架都使用了java的SPI机制，如java.sql.Driver的SPI实现（mysql驱动、oracle驱动等）、common-logging的日志接口实现、dubbo的扩展实现等等框架；</p>
<p>&nbsp;</p>
<p><strong>SPI</strong><strong>机制的约定：</strong></p>
<p>1)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 在META-INF/services/目录中创建以接口全限定名命名的文件该文件内容为Api具体实现类的全限定名</p>
<p>2)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 使用ServiceLoader类动态加载META-INF中的实现类</p>
<p>3)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 如SPI的实现类为Jar则需要放在主程序classPath中</p>
<p>4)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Api具体实现类必须有一个不带参数的构造方法</p>
<p><img src="https://images0.cnblogs.com/blog2015/84976/201503/081719062588772.jpg" alt="" /></p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<strong>SPI机制结构图</strong></p>
<p><strong>二、SPI</strong><strong>机制示例</strong></p>
<p><strong><img src="https://images0.cnblogs.com/blog2015/84976/201503/081720341494423.png" alt="" /></strong></p>
<p>&nbsp;</p>
<p><strong>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 实例结构图</strong></p>
<p><strong>IOperation</strong><strong>接口：</strong></p>
<div class="cnblogs_Highlighter sh-gutter">
<div>
<div id="highlighter_749959" class="syntaxhighlighter  java">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>

<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="java preprocessor">/**</code></div>
<div class="line number2 index1 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* Created by LX on 2015/3/8.</code></div>
<div class="line number3 index2 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">*/</code></div>
<div class="line number4 index3 alt1"><code class="java keyword">public</code>&nbsp;<code class="java keyword">interface</code>&nbsp;<code class="java plain">IOperation {</code></div>
<div class="line number5 index4 alt2">&nbsp;</div>
<div class="line number6 index5 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code>&nbsp;<code class="java keyword">int</code>&nbsp;<code class="java plain">operation(</code><code class="java keyword">int</code>&nbsp;<code class="java plain">numberA,&nbsp;</code><code class="java keyword">int</code>&nbsp;<code class="java plain">numberB);</code></div>
<div class="line number7 index6 alt2">&nbsp;</div>
<div class="line number8 index7 alt1"><code class="java plain">}</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><strong>PlusOperationImpl</strong><strong>实现：</strong></p>
<div class="cnblogs_Highlighter sh-gutter">
<div>
<div id="highlighter_311611" class="syntaxhighlighter  java">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>

<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="java keyword">import</code>&nbsp;<code class="java plain">co.solinx.demo.api.IOperation;</code></div>
<div class="line number2 index1 alt1">&nbsp;</div>
<div class="line number3 index2 alt2"><code class="java preprocessor">/**</code></div>
<div class="line number4 index3 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* Created by LX on 2015/3/8.</code></div>
<div class="line number5 index4 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">*/</code></div>
<div class="line number6 index5 alt1"><code class="java keyword">public</code>&nbsp;<code class="java keyword">class</code>&nbsp;<code class="java plain">PlusOperationImpl&nbsp;</code><code class="java keyword">implements</code>&nbsp;<code class="java plain">IOperation {</code></div>
<div class="line number7 index6 alt2">&nbsp;</div>
<div class="line number8 index7 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java color1">@Override</code></div>
<div class="line number9 index8 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code>&nbsp;<code class="java keyword">int</code>&nbsp;<code class="java plain">operation(</code><code class="java keyword">int</code>&nbsp;<code class="java plain">numberA,&nbsp;</code><code class="java keyword">int</code>&nbsp;<code class="java plain">numberB) {</code></div>
<div class="line number10 index9 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code>&nbsp;<code class="java plain">numberA + numberB;</code></div>
<div class="line number11 index10 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div>
<div class="line number12 index11 alt1"><code class="java plain">}</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><strong>SPI</strong><strong>接口的实现类：DivisionOperationImpl</strong></p>
<div class="cnblogs_Highlighter sh-gutter">
<div>
<div id="highlighter_656042" class="syntaxhighlighter  java">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>

<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="java keyword">import</code>&nbsp;<code class="java plain">co.solinx.demo.api.IOperation;</code></div>
<div class="line number2 index1 alt1">&nbsp;</div>
<div class="line number3 index2 alt2"><code class="java preprocessor">/**</code></div>
<div class="line number4 index3 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* Created by LX on 2015/3/8.</code></div>
<div class="line number5 index4 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">*/</code></div>
<div class="line number6 index5 alt1"><code class="java keyword">public</code>&nbsp;<code class="java keyword">class</code>&nbsp;<code class="java plain">DivisionOperationImpl&nbsp;</code><code class="java keyword">implements</code>&nbsp;<code class="java plain">IOperation {</code></div>
<div class="line number7 index6 alt2">&nbsp;</div>
<div class="line number8 index7 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java color1">@Override</code></div>
<div class="line number9 index8 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code>&nbsp;<code class="java keyword">int</code>&nbsp;<code class="java plain">operation(</code><code class="java keyword">int</code>&nbsp;<code class="java plain">numberA,&nbsp;</code><code class="java keyword">int</code>&nbsp;<code class="java plain">numberB) {</code></div>
<div class="line number10 index9 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code>&nbsp;<code class="java plain">numberA / numberB;</code></div>
<div class="line number11 index10 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div>
<div class="line number12 index11 alt1"><code class="java plain">}</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><strong>META-INF/Services</strong><strong>目录中的文件：</strong></p>
<p>文件名：co.solinx.demo.api.IOperation，内容：co.solinx.demo.spi.DivisionOperationImpl</p>
<p><img src="https://images0.cnblogs.com/blog2015/84976/201503/081724207116906.png" alt="" /></p>
<p><strong>Main</strong><strong>类：</strong></p>
<div class="cnblogs_Highlighter sh-gutter">
<div>
<div id="highlighter_169893" class="syntaxhighlighter  java">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>

<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="java keyword">import</code>&nbsp;<code class="java plain">co.solinx.demo.api.IOperation;</code></div>
<div class="line number2 index1 alt1"><code class="java keyword">import</code>&nbsp;<code class="java plain">co.solinx.demo.impl.PlusOperationImpl;</code></div>
<div class="line number3 index2 alt2"><code class="java keyword">import</code>&nbsp;<code class="java plain">co.solinx.demo.spi.DivisionOperationImpl;</code></div>
<div class="line number4 index3 alt1">&nbsp;</div>
<div class="line number5 index4 alt2"><code class="java keyword">import</code>&nbsp;<code class="java plain">java.util.Iterator;</code></div>
<div class="line number6 index5 alt1"><code class="java keyword">import</code>&nbsp;<code class="java plain">java.util.ServiceLoader;</code></div>
<div class="line number7 index6 alt2">&nbsp;</div>
<div class="line number8 index7 alt1"><code class="java preprocessor">/**</code></div>
<div class="line number9 index8 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* Created by LX on 2015/3/8.</code></div>
<div class="line number10 index9 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">*/</code></div>
<div class="line number11 index10 alt2"><code class="java keyword">public</code>&nbsp;<code class="java keyword">class</code>&nbsp;<code class="java plain">main {</code></div>
<div class="line number12 index11 alt1">&nbsp;</div>
<div class="line number13 index12 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code>&nbsp;<code class="java keyword">static</code>&nbsp;<code class="java keyword">void</code>&nbsp;<code class="java plain">main(String[] args) {</code></div>
<div class="line number14 index13 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">IOperation plus =&nbsp;</code><code class="java keyword">new</code>&nbsp;<code class="java plain">PlusOperationImpl();</code></div>
<div class="line number15 index14 alt2">&nbsp;</div>
<div class="line number16 index15 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">IOperation division =&nbsp;</code><code class="java keyword">new</code>&nbsp;<code class="java plain">DivisionOperationImpl();</code></div>
<div class="line number17 index16 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">System.out.println(plus.operation(</code><code class="java value">5</code><code class="java plain">,&nbsp;</code><code class="java value">3</code><code class="java plain">));</code></div>
<div class="line number18 index17 alt1">&nbsp;</div>
<div class="line number19 index18 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">System.out.println(division.operation(</code><code class="java value">9</code><code class="java plain">,&nbsp;</code><code class="java value">3</code><code class="java plain">));</code></div>
<div class="line number20 index19 alt1">&nbsp;</div>
<div class="line number21 index20 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">ServiceLoader&lt;IOperation&gt; operations = ServiceLoader.load(IOperation.</code><code class="java keyword">class</code><code class="java plain">);</code></div>
<div class="line number22 index21 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Iterator&lt;IOperation&gt; operationIterator = operations.iterator();</code></div>
<div class="line number23 index22 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">System.out.println(</code><code class="java string">"classPath:"</code><code class="java plain">+System.getProperty(</code><code class="java string">"java.class.path"</code><code class="java plain">));</code></div>
<div class="line number24 index23 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">while</code>&nbsp;<code class="java plain">(operationIterator.hasNext()) {</code></div>
<div class="line number25 index24 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">IOperation operation = operationIterator.next();</code></div>
<div class="line number26 index25 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">System.out.println(operation.operation(</code><code class="java value">6</code><code class="java plain">,&nbsp;</code><code class="java value">3</code><code class="java plain">));</code></div>
<div class="line number27 index26 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div>
<div class="line number28 index27 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div>
<div class="line number29 index28 alt2"><code class="java plain">}</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><strong>运行结果：</strong></p>
<p><strong><img src="https://images0.cnblogs.com/blog2015/84976/201503/081724487274498.png" alt="" /></strong></p>
<p>&nbsp;</p>
<p><strong>如把SPI</strong><strong>实现打包为jar</strong><strong>需要把jar</strong><strong>放在classpath</strong><strong>目录中，SPI jar</strong><strong>包运行结果：</strong></p>
<p><strong><img src="https://images0.cnblogs.com/blog2015/84976/201503/081725137586046.png" alt="" /></strong></p>
</div>
<div>&nbsp;</div>
<div>&nbsp;</div>
<div>参考：</div>
<div>&nbsp;</div>
<div><a href="https://www.jianshu.com/p/7e85b8ed00e2" target="_blank" rel="noopener">https://www.jianshu.com/p/7e85b8ed00e2</a><br /><br /></div>
<div>http://www.solinx.co/archives/142</div>