<header class="article-header">
<h1 class="article-title">注册中心(三)之Redis</h1>
</header>
<div class="article-entry">
<blockquote>
<p>本文基于 Dubbo 2.6.1 版本，望知悉。</p>
</blockquote>
<h1 id="1-概述">1. 概述</h1>
<p>前置阅读文章：</p>
<ul>
<li><a href="http://svip.iocoder.cn/Dubbo/registry-api/?self">《精尽 Dubbo 源码分析 &mdash;&mdash; 注册中心（一）之抽象 API》</a></li>
<li><a href="http://svip.iocoder.cn/Dubbo/registry-zookeeper/?self">《精尽 Dubbo 源码分析 &mdash;&mdash; 注册中心（二）之 Zookeeper》</a></li>
</ul>
<p>我们先来看下&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/references/registry/redis.html" target="_blank" rel="external nofollow noopener noreferrer">《Dubbo 用户指南 &mdash;&mdash; Redis 注册中心》</a>&nbsp;文档，内容如下：</p>
<blockquote>
<p>基于 Redis 实现的注册中心。</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_08_07/01.png" alt="流程" /></p>
<p>使用 Redis 的 Key/Map 结构存储数据结构：</p>
<ul>
<li>主 Key 为服务名和类型</li>
<li>Map 中的 Key 为 URL 地址</li>
<li>Map 中的 Value 为过期时间，用于判断脏数据，脏数据由监控中心删除</li>
</ul>
</blockquote>
<ul>
<li><strong>横向</strong>来看，和基于 Zookeeper 实现的注册中心，也是分成&nbsp;<strong>Root</strong>、<strong>Service</strong>、<strong>Type</strong>、<strong>URL</strong>&nbsp;四层。</li>
<li>使用&nbsp;<strong>Redis Map</strong>&nbsp;的数据结构，聚合相同服务和类型( Root + Service + Type )。</li>
<li>不使用 Redis 的<strong>自动过期</strong>机制，而是通过<strong>监控中心</strong>，实现过期机制。因为，Redis Key 自动过期时，不存在相应的事件通知。</li>
<li>服务提供者和消费者，定时延长其注册的 URL 地址的过期时间。</li>
</ul>
<p>使用 Redis 的&nbsp;<strong>Publish/Subscribe</strong>&nbsp;事件通知数据变更：</p>
<blockquote>
<ul>
<li>通过事件的值区分事件类型：<code>register</code>,&nbsp;<code>unregister</code></li>
<li>普通消费者直接订阅指定服务提供者的 Key，只会收到<strong>指定服务</strong>的变更事件</li>
<li>监控中心通过 psubscribe 功能订阅&nbsp;<code>/dubbo/*</code>，会收到<strong>所有服务</strong>的所有变更事件</li>
</ul>
</blockquote>
<ul>
<li>服务实例的启动或关闭，会写入或删除对应的 Redis Map 中，并发起对应的&nbsp;<code>register</code>,&nbsp;<code>unregister</code>&nbsp;事件，从而保证<strong>实时性</strong>。</li>
<li>通过监控中心，轮询 Key 过期，保证<strong>未正常关闭</strong>的服务实例的 URL 的删除，并发起对应的&nbsp;<code>unregister</code>&nbsp;事件，从而保证<strong>最终一致性</strong>。</li>
</ul>
<p><strong>调用过程</strong>：</p>
<blockquote>
<p>【一】服务提供方</p>
<ul>
<li>1、服务提供方启动时，向&nbsp;<code>Key:/dubbo/com.foo.BarService/providers</code>&nbsp;下，添加当前提供者的地址</li>
<li>2、并向&nbsp;<code>Channel:/dubbo/com.foo.BarService/providers</code>&nbsp;发送&nbsp;<code>register</code>&nbsp;事件</li>
</ul>
<p>【二】服务消费方</p>
<ul>
<li>3、服务消费方启动时，从&nbsp;<code>Channel:/dubbo/com.foo.BarService/providers</code>&nbsp;订阅&nbsp;<code>register</code>&nbsp;和&nbsp;<code>unregister</code>&nbsp;事件</li>
<li>4、并向&nbsp;<code>Key:/dubbo/com.foo.BarService/providers</code>&nbsp;下，添加当前消费者的地址<br />服务消费方收到&nbsp;<code>register</code>&nbsp;和&nbsp;<code>unregister</code>&nbsp;事件后，从&nbsp;<code>Key:/dubbo/com.foo.BarService/providers</code>&nbsp;下获取提供者地址列表</li>
</ul>
<p>【三】服务监控中心</p>
<ul>
<li>5、服务监控中心启动时，从&nbsp;<code>Channel:/dubbo/*</code>&nbsp;订阅&nbsp;<code>register</code>&nbsp;和&nbsp;<code>unregister</code>，以及&nbsp;<code>subscribe</code>&nbsp;和&nbsp;<code>unsubsribe</code>&nbsp;事件</li>
<li>6、服务监控中心收到&nbsp;<code>register</code>&nbsp;和&nbsp;<code>unregister</code>&nbsp;事件后，从&nbsp;<code>Key:/dubbo/com.foo.BarService/providers</code>&nbsp;下获取提供者地址列表</li>
<li>7、服务监控中心收到&nbsp;<code>subscribe</code>&nbsp;和&nbsp;<code>unsubsribe</code>&nbsp;事件后，从&nbsp;<code>Key:/dubbo/com.foo.BarService/consumers</code>&nbsp;下获取消费者地址列表</li>
</ul>
</blockquote>
<p>本文涉及仅有 RedisRegistry 一个类，类图如下：</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_08_07/02.png" alt="类图" /></p>
<h1 id="2-RedisRegistry">2. RedisRegistry</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-registry/dubbo-registry-redis/src/main/java/com/alibaba/dubbo/registry/redis/RedisRegistry.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.registry.redis.RedisRegistry</code></a>&nbsp;，实现 FailbackRegistry 抽象类，基于 Redis 实现的注册中心实现类。</p>
<h2 id="2-1-构造方法">2.1 构造方法</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">  <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">  2:  * 默认端口</span></span><br /><span class="line"><span class="comment">  3:  */</span></span><br /><span class="line">  <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_REDIS_PORT = <span class="number">6379</span>;</span><br /><span class="line">  <span class="number">5</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">  6:  * 默认 Redis 根节点</span></span><br /><span class="line"><span class="comment">  7:  */</span></span><br /><span class="line">  <span class="number">8</span>: <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String DEFAULT_ROOT = <span class="string">"dubbo"</span>;</span><br /><span class="line">  <span class="number">9</span>: </span><br /><span class="line"> <span class="number">10</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 11:  * Redis Key 过期机制执行器</span></span><br /><span class="line"><span class="comment"> 12:  */</span></span><br /><span class="line"> <span class="number">13</span>: <span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService expireExecutor = Executors.newScheduledThreadPool(<span class="number">1</span>, <span class="keyword">new</span> NamedThreadFactory(<span class="string">"DubboRegistryExpireTimer"</span>, <span class="keyword">true</span>));</span><br /><span class="line"> <span class="number">14</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 15:  * Redis Key 过期机制 Future</span></span><br /><span class="line"><span class="comment"> 16:  */</span></span><br /><span class="line"> <span class="number">17</span>: <span class="keyword">private</span> <span class="keyword">final</span> ScheduledFuture&lt;?&gt; expireFuture;</span><br /><span class="line"> <span class="number">18</span>: </span><br /><span class="line"> <span class="number">19</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 20:  * Redis 根节点</span></span><br /><span class="line"><span class="comment"> 21:  */</span></span><br /><span class="line"> <span class="number">22</span>: <span class="keyword">private</span> <span class="keyword">final</span> String root;</span><br /><span class="line"> <span class="number">23</span>: </span><br /><span class="line"> <span class="number">24</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 25:  * JedisPool 集合</span></span><br /><span class="line"><span class="comment"> 26:  *</span></span><br /><span class="line"><span class="comment"> 27:  * key：ip:port</span></span><br /><span class="line"><span class="comment"> 28:  */</span></span><br /><span class="line"> <span class="number">29</span>: <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, JedisPool&gt; jedisPools = <span class="keyword">new</span> ConcurrentHashMap&lt;String, JedisPool&gt;();</span><br /><span class="line"> <span class="number">30</span>: </span><br /><span class="line"> <span class="number">31</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 32:  * 通知器集合</span></span><br /><span class="line"><span class="comment"> 33:  *</span></span><br /><span class="line"><span class="comment"> 34:  * key：Root + Service ，例如 `/dubbo/com.alibaba.dubbo.demo.DemoService`</span></span><br /><span class="line"><span class="comment"> 35:  */</span></span><br /><span class="line"> <span class="number">36</span>: <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, Notifier&gt; notifiers = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Notifier&gt;();</span><br /><span class="line"> <span class="number">37</span>: </span><br /><span class="line"> <span class="number">38</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 39:  * 重连周期，单位：毫秒</span></span><br /><span class="line"><span class="comment"> 40:  */</span></span><br /><span class="line"> <span class="number">41</span>: <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> reconnectPeriod;</span><br /><span class="line"> <span class="number">42</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 43:  * 过期周期，单位：毫秒</span></span><br /><span class="line"><span class="comment"> 44:  */</span></span><br /><span class="line"> <span class="number">45</span>: <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> expirePeriod;</span><br /><span class="line"> <span class="number">46</span>: </span><br /><span class="line"> <span class="number">47</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 48:  * 是否监控中心</span></span><br /><span class="line"><span class="comment"> 49:  *</span></span><br /><span class="line"><span class="comment"> 50:  * 用于判断脏数据，脏数据由监控中心删除 {<span class="doctag">@link</span> #clean(Jedis)}</span></span><br /><span class="line"><span class="comment"> 51:  */</span></span><br /><span class="line"> <span class="number">52</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> admin = <span class="keyword">false</span>;</span><br /><span class="line"> <span class="number">53</span>: </span><br /><span class="line"> <span class="number">54</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 55:  * 是否复制模式</span></span><br /><span class="line"><span class="comment"> 56:  */</span></span><br /><span class="line"> <span class="number">57</span>: <span class="keyword">private</span> <span class="keyword">boolean</span> replicate;</span><br /><span class="line"> <span class="number">58</span>: </span><br /><span class="line"> <span class="number">59</span>: <span class="function"><span class="keyword">public</span> <span class="title">RedisRegistry</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line"> <span class="number">60</span>:     <span class="keyword">super</span>(url);</span><br /><span class="line"> <span class="number">61</span>:     <span class="keyword">if</span> (url.isAnyHost()) {</span><br /><span class="line"> <span class="number">62</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"registry address == null"</span>);</span><br /><span class="line"> <span class="number">63</span>:     }</span><br /><span class="line"> <span class="number">64</span>:     <span class="comment">// 创建 GenericObjectPoolConfig 对象</span></span><br /><span class="line"> <span class="number">65</span>:     GenericObjectPoolConfig config = <span class="keyword">new</span> GenericObjectPoolConfig();</span><br /><span class="line"> <span class="number">66</span>:     config.setTestOnBorrow(url.getParameter(<span class="string">"test.on.borrow"</span>, <span class="keyword">true</span>));</span><br /><span class="line"> <span class="number">67</span>:     config.setTestOnReturn(url.getParameter(<span class="string">"test.on.return"</span>, <span class="keyword">false</span>));</span><br /><span class="line"> <span class="number">68</span>:     config.setTestWhileIdle(url.getParameter(<span class="string">"test.while.idle"</span>, <span class="keyword">false</span>));</span><br /><span class="line"> <span class="number">69</span>:     <span class="keyword">if</span> (url.getParameter(<span class="string">"max.idle"</span>, <span class="number">0</span>) &gt; <span class="number">0</span>)</span><br /><span class="line"> <span class="number">70</span>:         config.setMaxIdle(url.getParameter(<span class="string">"max.idle"</span>, <span class="number">0</span>));</span><br /><span class="line"> <span class="number">71</span>:     <span class="keyword">if</span> (url.getParameter(<span class="string">"min.idle"</span>, <span class="number">0</span>) &gt; <span class="number">0</span>)</span><br /><span class="line"> <span class="number">72</span>:         config.setMinIdle(url.getParameter(<span class="string">"min.idle"</span>, <span class="number">0</span>));</span><br /><span class="line"> <span class="number">73</span>:     <span class="keyword">if</span> (url.getParameter(<span class="string">"max.active"</span>, <span class="number">0</span>) &gt; <span class="number">0</span>)</span><br /><span class="line"> <span class="number">74</span>:         config.setMaxTotal(url.getParameter(<span class="string">"max.active"</span>, <span class="number">0</span>));</span><br /><span class="line"> <span class="number">75</span>:     <span class="keyword">if</span> (url.getParameter(<span class="string">"max.total"</span>, <span class="number">0</span>) &gt; <span class="number">0</span>)</span><br /><span class="line"> <span class="number">76</span>:         config.setMaxTotal(url.getParameter(<span class="string">"max.total"</span>, <span class="number">0</span>));</span><br /><span class="line"> <span class="number">77</span>:     <span class="keyword">if</span> (url.getParameter(<span class="string">"max.wait"</span>, url.getParameter(<span class="string">"timeout"</span>, <span class="number">0</span>)) &gt; <span class="number">0</span>)</span><br /><span class="line"> <span class="number">78</span>:         config.setMaxWaitMillis(url.getParameter(<span class="string">"max.wait"</span>, url.getParameter(<span class="string">"timeout"</span>, <span class="number">0</span>)));</span><br /><span class="line"> <span class="number">79</span>:     <span class="keyword">if</span> (url.getParameter(<span class="string">"num.tests.per.eviction.run"</span>, <span class="number">0</span>) &gt; <span class="number">0</span>)</span><br /><span class="line"> <span class="number">80</span>:         config.setNumTestsPerEvictionRun(url.getParameter(<span class="string">"num.tests.per.eviction.run"</span>, <span class="number">0</span>));</span><br /><span class="line"> <span class="number">81</span>:     <span class="keyword">if</span> (url.getParameter(<span class="string">"time.between.eviction.runs.millis"</span>, <span class="number">0</span>) &gt; <span class="number">0</span>)</span><br /><span class="line"> <span class="number">82</span>:         config.setTimeBetweenEvictionRunsMillis(url.getParameter(<span class="string">"time.between.eviction.runs.millis"</span>, <span class="number">0</span>));</span><br /><span class="line"> <span class="number">83</span>:     <span class="keyword">if</span> (url.getParameter(<span class="string">"min.evictable.idle.time.millis"</span>, <span class="number">0</span>) &gt; <span class="number">0</span>)</span><br /><span class="line"> <span class="number">84</span>:         config.setMinEvictableIdleTimeMillis(url.getParameter(<span class="string">"min.evictable.idle.time.millis"</span>, <span class="number">0</span>));</span><br /><span class="line"> <span class="number">85</span>: </span><br /><span class="line"> <span class="number">86</span>:     <span class="comment">// 是否复制模式</span></span><br /><span class="line"> <span class="number">87</span>:     String cluster = url.getParameter(<span class="string">"cluster"</span>, <span class="string">"failover"</span>);</span><br /><span class="line"> <span class="number">88</span>:     <span class="keyword">if</span> (!<span class="string">"failover"</span>.equals(cluster) &amp;&amp; !<span class="string">"replicate"</span>.equals(cluster)) {</span><br /><span class="line"> <span class="number">89</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unsupported redis cluster: "</span> + cluster + <span class="string">". The redis cluster only supported failover or replicate."</span>);</span><br /><span class="line"> <span class="number">90</span>:     }</span><br /><span class="line"> <span class="number">91</span>:     replicate = <span class="string">"replicate"</span>.equals(cluster);</span><br /><span class="line"> <span class="number">92</span>: </span><br /><span class="line"> <span class="number">93</span>:     <span class="comment">// 解析</span></span><br /><span class="line"> <span class="number">94</span>:     List&lt;String&gt; addresses = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br /><span class="line"> <span class="number">95</span>:     addresses.add(url.getAddress());</span><br /><span class="line"> <span class="number">96</span>:     String[] backups = url.getParameter(Constants.BACKUP_KEY, <span class="keyword">new</span> String[<span class="number">0</span>]);</span><br /><span class="line"> <span class="number">97</span>:     <span class="keyword">if</span> (backups != <span class="keyword">null</span> &amp;&amp; backups.length &gt; <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">98</span>:         addresses.addAll(Arrays.asList(backups));</span><br /><span class="line"> <span class="number">99</span>:     }</span><br /><span class="line"><span class="number">100</span>: </span><br /><span class="line"><span class="number">101</span>:     <span class="comment">// 创建 JedisPool 对象</span></span><br /><span class="line"><span class="number">102</span>:     String password = url.getPassword();</span><br /><span class="line"><span class="number">103</span>:     <span class="keyword">for</span> (String address : addresses) {</span><br /><span class="line"><span class="number">104</span>:         <span class="keyword">int</span> i = address.indexOf(<span class="string">':'</span>);</span><br /><span class="line"><span class="number">105</span>:         String host;</span><br /><span class="line"><span class="number">106</span>:         <span class="keyword">int</span> port;</span><br /><span class="line"><span class="number">107</span>:         <span class="keyword">if</span> (i &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">108</span>:             host = address.substring(<span class="number">0</span>, i);</span><br /><span class="line"><span class="number">109</span>:             port = Integer.parseInt(address.substring(i + <span class="number">1</span>));</span><br /><span class="line"><span class="number">110</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">111</span>:             host = address;</span><br /><span class="line"><span class="number">112</span>:             port = DEFAULT_REDIS_PORT;</span><br /><span class="line"><span class="number">113</span>:         }</span><br /><span class="line"><span class="number">114</span>:         <span class="keyword">if</span> (StringUtils.isEmpty(password)) { <span class="comment">// 无密码连接</span></span><br /><span class="line"><span class="number">115</span>:             <span class="keyword">this</span>.jedisPools.put(address, <span class="keyword">new</span> JedisPool(config, host, port,</span><br /><span class="line"><span class="number">116</span>:                     url.getParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT)));</span><br /><span class="line"><span class="number">117</span>:         } <span class="keyword">else</span> { <span class="comment">// 有密码连接</span></span><br /><span class="line"><span class="number">118</span>:             <span class="keyword">this</span>.jedisPools.put(address, <span class="keyword">new</span> JedisPool(config, host, port,</span><br /><span class="line"><span class="number">119</span>:                     url.getParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT), password));</span><br /><span class="line"><span class="number">120</span>:         }</span><br /><span class="line"><span class="number">121</span>:     }</span><br /><span class="line"><span class="number">122</span>: </span><br /><span class="line"><span class="number">123</span>:     <span class="comment">// 解析重连周期</span></span><br /><span class="line"><span class="number">124</span>:     <span class="keyword">this</span>.reconnectPeriod = url.getParameter(Constants.REGISTRY_RECONNECT_PERIOD_KEY, Constants.DEFAULT_REGISTRY_RECONNECT_PERIOD);</span><br /><span class="line"><span class="number">125</span>: </span><br /><span class="line"><span class="number">126</span>:     <span class="comment">// 获得 Redis 根节点</span></span><br /><span class="line"><span class="number">127</span>:     String group = url.getParameter(Constants.GROUP_KEY, DEFAULT_ROOT);</span><br /><span class="line"><span class="number">128</span>:     <span class="keyword">if</span> (!group.startsWith(Constants.PATH_SEPARATOR)) { <span class="comment">// 头 `/`</span></span><br /><span class="line"><span class="number">129</span>:         group = Constants.PATH_SEPARATOR + group;</span><br /><span class="line"><span class="number">130</span>:     }</span><br /><span class="line"><span class="number">131</span>:     <span class="keyword">if</span> (!group.endsWith(Constants.PATH_SEPARATOR)) { <span class="comment">// 尾 `/`</span></span><br /><span class="line"><span class="number">132</span>:         group = group + Constants.PATH_SEPARATOR;</span><br /><span class="line"><span class="number">133</span>:     }</span><br /><span class="line"><span class="number">134</span>:     <span class="keyword">this</span>.root = group;</span><br /><span class="line"><span class="number">135</span>: </span><br /><span class="line"><span class="number">136</span>:     <span class="comment">// 创建实现 Redis Key 过期机制的任务</span></span><br /><span class="line"><span class="number">137</span>:     <span class="keyword">this</span>.expirePeriod = url.getParameter(Constants.SESSION_TIMEOUT_KEY, Constants.DEFAULT_SESSION_TIMEOUT);</span><br /><span class="line"><span class="number">138</span>:     <span class="keyword">this</span>.expireFuture = expireExecutor.scheduleWithFixedDelay(<span class="keyword">new</span> Runnable() {</span><br /><span class="line"><span class="number">139</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br /><span class="line"><span class="number">140</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">141</span>:                 deferExpired(); <span class="comment">// Extend the expiration time</span></span><br /><span class="line"><span class="number">142</span>:             } <span class="keyword">catch</span> (Throwable t) { <span class="comment">// Defensive fault tolerance</span></span><br /><span class="line"><span class="number">143</span>:                 logger.error(<span class="string">"Unexpected exception occur at defer expire time, cause: "</span> + t.getMessage(), t);</span><br /><span class="line"><span class="number">144</span>:             }</span><br /><span class="line"><span class="number">145</span>:         }</span><br /><span class="line"><span class="number">146</span>:     }, expirePeriod / <span class="number">2</span>, expirePeriod / <span class="number">2</span>, TimeUnit.MILLISECONDS);</span><br /><span class="line"><span class="number">147</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><code>jedisPools</code>&nbsp;属性，JedisPool 集合，其中键为&nbsp;<code>ip:port</code>&nbsp;。在【第 64 至 84 行】和【第 93 至 99 行】和【101 至 121 行】初始化。</p>
<ul>
<li><code>root</code>&nbsp;属性，Redis 根节点，即首图的&nbsp;<strong>Root</strong>&nbsp;层。在【第 126 至 134 行】初始化。</li>
<li>
<p><code>replicate</code>&nbsp;属性，是否复制模式。在【第 86 至 90 行】文档说明如下：</p>
<blockquote>
<p>可通过&nbsp;<code>&lt;dubbo:registry cluster="replicate" /&gt;</code>&nbsp;设置 redis 集群策略，缺省为&nbsp;<code>failover</code>：</p>
<ul>
<li><code>failover</code>: 只写入和读取任意一台，失败时重试另一台，需要服务器端自行配置数据同步。</li>
<li><code>replicate</code>: 在客户端同时写入所有服务器，只读取单台，服务器端不需要同步，注册中心集群增大，性能压力也会更大。</li>
</ul>
</blockquote>
</li>
</ul>
</li>
<li>
<p><code>notifiers</code>&nbsp;属性，通知器集合，其中键为 Root + Service 。Notifier ，用于 Redis Publish/Subscribe 机制中的订阅，实时监听数据的变化。</p>
<ul>
<li><code>reconnectPeriod</code>&nbsp;属性，重连周期，单位：毫秒。在【第 91 行】初始化。用于订阅发生 Redis 连接异常时，Notifier&nbsp;<strong>sleep</strong>&nbsp;，等待重连上。</li>
</ul>
</li>
<li><code>expireExecutor</code>&nbsp;属性，Redis Key 过期机制执行器。
<ul>
<li><code>expirePeriod</code>&nbsp;属性，Redis Key 过期周期，单位：毫秒。在【第 137 行】初始化。</li>
<li><code>expireFuture</code>&nbsp;属性，Redis Key 过期机制任务的 Future 。在【第 138 至 146 行】初始化。
<ul>
<li>该任务主要有两个逻辑：1）延长未过期的 Key ；2）删除过期的 Key 。</li>
<li>任务间隔为&nbsp;<code>expirePeriod</code>&nbsp;的<strong>一半</strong>，避免过于频繁，对 Redis 的压力过大；同时，避免过于不频繁，每次执行时，都过期了。</li>
</ul>
</li>
<li><code>admin</code>&nbsp;属性，是否监控中心，在&nbsp;<code>#clean(Jedis)</code>&nbsp;方法，看到具体的使用。</li>
</ul>
</li>
</ul>
<h2 id="2-2-doRegister">2.2 doRegister</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doRegister</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     String key = toCategoryPath(url);</span><br /><span class="line"> <span class="number">4</span>:     String value = url.toFullString();</span><br /><span class="line"> <span class="number">5</span>:     <span class="comment">// 计算过期时间</span></span><br /><span class="line"> <span class="number">6</span>:     String expire = String.valueOf(System.currentTimeMillis() + expirePeriod);</span><br /><span class="line"> <span class="number">7</span>:     <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br /><span class="line"> <span class="number">8</span>:     RpcException exception = <span class="keyword">null</span>;</span><br /><span class="line"> <span class="number">9</span>:     <span class="comment">// 向 Redis 注册</span></span><br /><span class="line"><span class="number">10</span>:     <span class="keyword">for</span> (Map.Entry&lt;String, JedisPool&gt; entry : jedisPools.entrySet()) {</span><br /><span class="line"><span class="number">11</span>:         JedisPool jedisPool = entry.getValue();</span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">13</span>:             Jedis jedis = jedisPool.getResource();</span><br /><span class="line"><span class="number">14</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">15</span>:                 <span class="comment">// 写入 Redis Map 键</span></span><br /><span class="line"><span class="number">16</span>:                 jedis.hset(key, value, expire);</span><br /><span class="line"><span class="number">17</span>:                 <span class="comment">// 发布 Redis 注册事件</span></span><br /><span class="line"><span class="number">18</span>:                 jedis.publish(key, Constants.REGISTER);</span><br /><span class="line"><span class="number">19</span>:                 success = <span class="keyword">true</span>;</span><br /><span class="line"><span class="number">20</span>:                 <span class="comment">// &nbsp;如果服务器端已同步数据，只需写入单台机器</span></span><br /><span class="line"><span class="number">21</span>:                 <span class="keyword">if</span> (!replicate) {</span><br /><span class="line"><span class="number">22</span>:                     <span class="keyword">break</span>; <span class="comment">// &nbsp;If the server side has synchronized data, just write a single machine</span></span><br /><span class="line"><span class="number">23</span>:                 }</span><br /><span class="line"><span class="number">24</span>:             } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">25</span>:                 jedisPool.returnResource(jedis);</span><br /><span class="line"><span class="number">26</span>:             }</span><br /><span class="line"><span class="number">27</span>:         } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">28</span>:             exception = <span class="keyword">new</span> RpcException(<span class="string">"Failed to register service to redis registry. registry: "</span> + entry.getKey() + <span class="string">", service: "</span> + url + <span class="string">", cause: "</span> + t.getMessage(), t);</span><br /><span class="line"><span class="number">29</span>:         }</span><br /><span class="line"><span class="number">30</span>:     }</span><br /><span class="line"><span class="number">31</span>:     <span class="comment">// 处理异常</span></span><br /><span class="line"><span class="number">32</span>:     <span class="keyword">if</span> (exception != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">33</span>:         <span class="keyword">if</span> (success) { <span class="comment">// 虽然发生异常，但是结果成功</span></span><br /><span class="line"><span class="number">34</span>:             logger.warn(exception.getMessage(), exception);</span><br /><span class="line"><span class="number">35</span>:         } <span class="keyword">else</span> { <span class="comment">// 最终未成功</span></span><br /><span class="line"><span class="number">36</span>:             <span class="keyword">throw</span> exception;</span><br /><span class="line"><span class="number">37</span>:         }</span><br /><span class="line"><span class="number">38</span>:     }</span><br /><span class="line"><span class="number">39</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>第 3 行：调用&nbsp;<code>#toCategoryPath(url)</code>&nbsp;方法，获得<strong>分类路径</strong>作为 Key 。</li>
<li>第 4 行：调用&nbsp;<code>URL#toFullString()</code>&nbsp;方法，获得&nbsp;<strong>URL 字符串</strong>作为 Value 。</li>
<li>第 6 行：计算过期时间，当前时间 +&nbsp;<code>expirePeriod</code>&nbsp;。</li>
<li>第 9 至 30 行：向 Redis 注册。
<ul>
<li>第 16 行：调用&nbsp;<code>Jedis#hset(key, value, expire)</code>&nbsp;方法，写入 Redis Map 中。<strong>注意，过期时间，作为 Map 的值</strong>。</li>
<li>第 18 行：调用&nbsp;<code>Jedis#publish(channel, message)</code>&nbsp;方法，发布&nbsp;<code>register</code>&nbsp;事件。这样订阅该 Key 的服务消费者和监控中心，就会实时从 Redis 读取<strong>该服务</strong>的最新数据。</li>
<li>第 21 至 23 行：如果非&nbsp;<code>replicate</code>&nbsp;，意味着 Redis 服务器端已同步数据，只需写入单台机器。因此，结束循环。否则，满足&nbsp;<code>replicate</code>&nbsp;，向所有 Redis 写入。</li>
</ul>
</li>
<li>第 31 至 38 行：处理异常。这块代码胖友自己看下，注意下&nbsp;<code>exception</code>&nbsp;和&nbsp;<code>success</code>&nbsp;赋值的地方。这块的打印告警日志的处理方式，也适用于多次重试某个操作，结果发生异常，但是最终成功。例如，HTTP 请求远程服务。</li>
</ul>
<h3 id="2-1-1-toCategoryPath">2.1.1 toCategoryPath</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * 获得分类路径</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * Root + Service + Type</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> url URL</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> 分类路径</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">toCategoryPath</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> toServicePath(url) + Constants.PATH_SEPARATOR + url.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="2-3-doUnregister">2.3 doUnregister</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doUnregister</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    String key = toCategoryPath(url);</span><br /><span class="line">    String value = url.toFullString();</span><br /><span class="line">    RpcException exception = <span class="keyword">null</span>;</span><br /><span class="line">    <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br /><span class="line">    <span class="comment">// 向 Redis 注册</span></span><br /><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, JedisPool&gt; entry : jedisPools.entrySet()) {</span><br /><span class="line">        JedisPool jedisPool = entry.getValue();</span><br /><span class="line">        <span class="keyword">try</span> {</span><br /><span class="line">            Jedis jedis = jedisPool.getResource();</span><br /><span class="line">            <span class="keyword">try</span> {</span><br /><span class="line">                <span class="comment">// 删除 Redis Map 键</span></span><br /><span class="line">                jedis.hdel(key, value);</span><br /><span class="line">                <span class="comment">// 发布 Redis 取消注册事件</span></span><br /><span class="line">                jedis.publish(key, Constants.UNREGISTER);</span><br /><span class="line">                success = <span class="keyword">true</span>;</span><br /><span class="line">                <span class="comment">// &nbsp;如果服务器端已同步数据，只需写入单台机器</span></span><br /><span class="line">                <span class="keyword">if</span> (!replicate) {</span><br /><span class="line">                    <span class="keyword">break</span>; <span class="comment">// &nbsp;If the server side has synchronized data, just write a single machine</span></span><br /><span class="line">                }</span><br /><span class="line">            } <span class="keyword">finally</span> {</span><br /><span class="line">                jedisPool.returnResource(jedis);</span><br /><span class="line">            }</span><br /><span class="line">        } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line">            exception = <span class="keyword">new</span> RpcException(<span class="string">"Failed to unregister service to redis registry. registry: "</span> + entry.getKey() + <span class="string">", service: "</span> + url + <span class="string">", cause: "</span> + t.getMessage(), t);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// 处理异常</span></span><br /><span class="line">    <span class="keyword">if</span> (exception != <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">if</span> (success) { <span class="comment">// 虽然发生异常，但是结果成功</span></span><br /><span class="line">            logger.warn(exception.getMessage(), exception);</span><br /><span class="line">        } <span class="keyword">else</span> { <span class="comment">// 最终未成功</span></span><br /><span class="line">            <span class="keyword">throw</span> exception;</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>当服务消费者或服务提供者，关闭时，会调用&nbsp;<code>#doUnregister(url)</code>&nbsp;方法，取消注册。在该方法中，会删除对应 Map 中的<strong>键</strong>&nbsp;+ 发布&nbsp;<code>unregister</code>&nbsp;事件，从而<strong>实时</strong>通知订阅者们。因此，正常情况下，就无需监控中心，做脏数据删除的工作。</li>
<li>🙂 代码比较简单，和&nbsp;<code>#doRegister()</code>&nbsp;方法，逻辑相反。</li>
</ul>
<h2 id="2-4-doSubscribe">2.4 doSubscribe</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSubscribe</span><span class="params">(<span class="keyword">final</span> URL url, <span class="keyword">final</span> NotifyListener listener)</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// 获得服务路径，例如：`/dubbo/com.alibaba.dubbo.demo.DemoService`</span></span><br /><span class="line"> <span class="number">4</span>:     String service = toServicePath(url);</span><br /><span class="line"> <span class="number">5</span>:     <span class="comment">// 获得通知器 Notifier 对象</span></span><br /><span class="line"> <span class="number">6</span>:     Notifier notifier = notifiers.get(service);</span><br /><span class="line"> <span class="number">7</span>:     <span class="comment">// 不存在，则创建 Notifier 对象</span></span><br /><span class="line"> <span class="number">8</span>:     <span class="keyword">if</span> (notifier == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">9</span>:         Notifier newNotifier = <span class="keyword">new</span> Notifier(service);</span><br /><span class="line"><span class="number">10</span>:         notifiers.putIfAbsent(service, newNotifier);</span><br /><span class="line"><span class="number">11</span>:         notifier = notifiers.get(service);</span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">if</span> (notifier == newNotifier) { <span class="comment">// 保证并发的情况下，有且仅有一个启动</span></span><br /><span class="line"><span class="number">13</span>:             notifier.start();</span><br /><span class="line"><span class="number">14</span>:         }</span><br /><span class="line"><span class="number">15</span>:     }</span><br /><span class="line"><span class="number">16</span>:     <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br /><span class="line"><span class="number">17</span>:     RpcException exception = <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">18</span>:     <span class="comment">// 循环 `jedisPools` ，仅向一个 Redis 发起订阅</span></span><br /><span class="line"><span class="number">19</span>:     <span class="keyword">for</span> (Map.Entry&lt;String, JedisPool&gt; entry : jedisPools.entrySet()) {</span><br /><span class="line"><span class="number">20</span>:         JedisPool jedisPool = entry.getValue();</span><br /><span class="line"><span class="number">21</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">22</span>:             Jedis jedis = jedisPool.getResource();</span><br /><span class="line"><span class="number">23</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">24</span>:                 <span class="comment">// 处理所有 Service 层的发起订阅，例如监控中心的订阅</span></span><br /><span class="line"><span class="number">25</span>:                 <span class="keyword">if</span> (service.endsWith(Constants.ANY_VALUE)) {</span><br /><span class="line"><span class="number">26</span>:                     admin = <span class="keyword">true</span>;</span><br /><span class="line"><span class="number">27</span>:                     <span class="comment">// 获得分类层集合，例如：`/dubbo/com.alibaba.dubbo.demo.DemoService/providers`</span></span><br /><span class="line"><span class="number">28</span>:                     Set&lt;String&gt; keys = jedis.keys(service);</span><br /><span class="line"><span class="number">29</span>:                     <span class="keyword">if</span> (keys != <span class="keyword">null</span> &amp;&amp; !keys.isEmpty()) {</span><br /><span class="line"><span class="number">30</span>:                         <span class="comment">// 按照服务聚合 URL 集合</span></span><br /><span class="line"><span class="number">31</span>:                         Map&lt;String, Set&lt;String&gt;&gt; serviceKeys = <span class="keyword">new</span> HashMap&lt;String, Set&lt;String&gt;&gt;(); <span class="comment">// Key：Root + Service ; Value：URL 。</span></span><br /><span class="line"><span class="number">32</span>:                         <span class="keyword">for</span> (String key : keys) {</span><br /><span class="line"><span class="number">33</span>:                             String serviceKey = toServicePath(key);</span><br /><span class="line"><span class="number">34</span>:                             Set&lt;String&gt; sk = serviceKeys.get(serviceKey);</span><br /><span class="line"><span class="number">35</span>:                             <span class="keyword">if</span> (sk == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">36</span>:                                 sk = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br /><span class="line"><span class="number">37</span>:                                 serviceKeys.put(serviceKey, sk);</span><br /><span class="line"><span class="number">38</span>:                             }</span><br /><span class="line"><span class="number">39</span>:                             sk.add(key);</span><br /><span class="line"><span class="number">40</span>:                         }</span><br /><span class="line"><span class="number">41</span>:                         <span class="comment">// 循环 serviceKeys ，按照每个 Service 层的发起通知</span></span><br /><span class="line"><span class="number">42</span>:                         <span class="keyword">for</span> (Set&lt;String&gt; sk : serviceKeys.values()) {</span><br /><span class="line"><span class="number">43</span>:                             doNotify(jedis, sk, url, Collections.singletonList(listener));</span><br /><span class="line"><span class="number">44</span>:                         }</span><br /><span class="line"><span class="number">45</span>:                     }</span><br /><span class="line"><span class="number">46</span>:                 <span class="comment">// 处理指定 Service 层的发起通知</span></span><br /><span class="line"><span class="number">47</span>:                 } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">48</span>:                     doNotify(jedis, jedis.keys(service + Constants.PATH_SEPARATOR + Constants.ANY_VALUE), url, Collections.singletonList(listener));</span><br /><span class="line"><span class="number">49</span>:                 }</span><br /><span class="line"><span class="number">50</span>:                 <span class="comment">// 标记成功</span></span><br /><span class="line"><span class="number">51</span>:                 success = <span class="keyword">true</span>;</span><br /><span class="line"><span class="number">52</span>:                 <span class="comment">// 结束，仅仅从一台服务器读取数据</span></span><br /><span class="line"><span class="number">53</span>:                 <span class="keyword">break</span>; <span class="comment">// Just read one server's data</span></span><br /><span class="line"><span class="number">54</span>:             } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">55</span>:                 jedisPool.returnResource(jedis);</span><br /><span class="line"><span class="number">56</span>:             }</span><br /><span class="line"><span class="number">57</span>:         } <span class="keyword">catch</span> (Throwable t) { <span class="comment">// Try the next server</span></span><br /><span class="line"><span class="number">58</span>:             exception = <span class="keyword">new</span> RpcException(<span class="string">"Failed to subscribe service from redis registry. registry: "</span> + entry.getKey() + <span class="string">", service: "</span> + url + <span class="string">", cause: "</span> + t.getMessage(), t);</span><br /><span class="line"><span class="number">59</span>:         }</span><br /><span class="line"><span class="number">60</span>:     }</span><br /><span class="line"><span class="number">61</span>:     <span class="comment">// 处理异常</span></span><br /><span class="line"><span class="number">62</span>:     <span class="keyword">if</span> (exception != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">63</span>:         <span class="keyword">if</span> (success) { <span class="comment">// 虽然发生异常，但是结果成功</span></span><br /><span class="line"><span class="number">64</span>:             logger.warn(exception.getMessage(), exception);</span><br /><span class="line"><span class="number">65</span>:         } <span class="keyword">else</span> { <span class="comment">// 最终未成功</span></span><br /><span class="line"><span class="number">66</span>:             <span class="keyword">throw</span> exception;</span><br /><span class="line"><span class="number">67</span>:         }</span><br /><span class="line"><span class="number">68</span>:     }</span><br /><span class="line"><span class="number">69</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>========== 【第一步】Notifier 部分 ==========</li>
<li>第 4 行：调用&nbsp;<code>#toServicePath(url)</code>&nbsp;方法，获得服务路径，例如：<code>/dubbo/com.alibaba.dubbo.demo.DemoService</code>&nbsp;。</li>
<li>第 6 行：获得通知器 Notifier 对象。</li>
<li>第 8 至 15 行：若不存在，则创建 Notifier 对象，并调用&nbsp;<code>Notifier#start()</code>&nbsp;方法。</li>
<li>========== 【第二步】获取初始化数据，并进行通知 ==========</li>
<li>第 19 行：循环&nbsp;<code>jedisPools</code>&nbsp;，向 Redis 发起订阅，<strong>直到一个成功</strong>。我们会看到代码，分成<strong>两个部分</strong>。</li>
<li>【第二部分】第 46 至 49 行，适用服务提供者和服务消费者，处理<strong>指定</strong>&nbsp;Service 层的初始化数据：</li>
<li>第 48 行：调用&nbsp;<code>Jedis#keys(pattern)</code>&nbsp;方法，获得<strong>指定</strong>&nbsp;Service 层下的所有 URL 们。例如&nbsp;<code>/dubbo/com.alibaba.dubbo.demo.DemoService/*</code>&nbsp;。</li>
<li>第 48 行：调用&nbsp;<code>#doNotify(jedis, keys, url, listeners)</code>&nbsp;方法，通知监听器，初始的数据。</li>
<li>【第一部分】第 25 至 45 行，适用注册中心，处理<strong>所有</strong>&nbsp;Service 层的初始化数据：</li>
<li>第 26 行：标记&nbsp;<code>admin = true</code>&nbsp;。因为，只有注册中心，才清理脏数据。</li>
<li>第 28 行：调用&nbsp;<code>Jedis#keys(pattern)</code>&nbsp;方法，获得<strong>所有</strong>&nbsp;Service 层下的所有 URL 们。例如&nbsp;<code>/dubbo/*</code>&nbsp;。</li>
<li>第 31 至 39 行：按照<strong>服务</strong>聚合 URL 集合。</li>
<li>第 42 至 44 行：循环&nbsp;<code>serviceKeys</code>&nbsp;，调用&nbsp;<code>#doNotify(jedis, keys, url, listeners)</code>&nbsp;方法，按照<strong>每个 Service 层</strong>，通知监听器，初始的数据。此处，就和【第 48 行】<strong>类似</strong>。</li>
</ul>
<p>另外，订阅动作（【第一步】）<strong>一定</strong>要在获取初始化数据（【第二步】）<strong>之前</strong>。如果反过来，可能获取数据完后，处理的过程中，有数据的变更，我们就无法收到&nbsp;<code>register</code>&nbsp;<code>unregister</code>&nbsp;的事件。</p>
<h3 id="2-4-1-toServicePath">2.4.1 toServicePath</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * 获得服务路径</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * Root + Type</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> url URL</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> 服务路径</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">toServicePath</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> root + url.getServiceInterface();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="2-4-2-toServicePath">2.4.2 toServicePath</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * 获得服务路径，主要截掉多余的部分</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * Root + Type</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> categoryPath 分类路径</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> 服务路径</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">toServicePath</span><span class="params">(String categoryPath)</span> </span>{</span><br /><span class="line">    <span class="keyword">int</span> i;</span><br /><span class="line">    <span class="keyword">if</span> (categoryPath.startsWith(root)) {</span><br /><span class="line">        i = categoryPath.indexOf(Constants.PATH_SEPARATOR, root.length());</span><br /><span class="line">    } <span class="keyword">else</span> {</span><br /><span class="line">        i = categoryPath.indexOf(Constants.PATH_SEPARATOR);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> i &gt; <span class="number">0</span> ? categoryPath.substring(<span class="number">0</span>, i) : categoryPath;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="2-5-doUnsubscribe">2.5 doUnsubscribe</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doUnsubscribe</span><span class="params">(URL url, NotifyListener listener)</span> </span>{</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>此处目前并未实现，艿艿觉得，此处应该增加取消向 Redis 的订阅( Subscribe ) 。在 ZookeeperRegistry 的该方法中，是移除了对应的监听器。</li>
</ul>
<h2 id="2-6-doNotify">2.6 doNotify</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">// @params key 分类数组，例如：`/dubbo/com.alibaba.dubbo.demo.DemoService/providers`</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doNotify</span><span class="params">(Jedis jedis, String key)</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">for</span> (Map.Entry&lt;URL, Set&lt;NotifyListener&gt;&gt; entry : <span class="keyword">new</span> HashMap&lt;URL, Set&lt;NotifyListener&gt;&gt;(getSubscribed()).entrySet()) {</span><br /><span class="line"> <span class="number">4</span>:         doNotify(jedis, Collections.singletonList(key), entry.getKey(), <span class="keyword">new</span> HashSet&lt;NotifyListener&gt;(entry.getValue()));</span><br /><span class="line"> <span class="number">5</span>:     }</span><br /><span class="line"> <span class="number">6</span>: }</span><br /><span class="line"> <span class="number">7</span>: </span><br /><span class="line"> <span class="number">8</span>: <span class="comment">// @params keys 分类数组，元素例如：`/dubbo/com.alibaba.dubbo.demo.DemoService/providers`</span></span><br /><span class="line"> <span class="number">9</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doNotify</span><span class="params">(Jedis jedis, Collection&lt;String&gt; keys, URL url, Collection&lt;NotifyListener&gt; listeners)</span> </span>{</span><br /><span class="line"><span class="number">10</span>:     <span class="keyword">if</span> (keys == <span class="keyword">null</span> || keys.isEmpty() || listeners == <span class="keyword">null</span> || listeners.isEmpty()) {</span><br /><span class="line"><span class="number">11</span>:         <span class="keyword">return</span>;</span><br /><span class="line"><span class="number">12</span>:     }</span><br /><span class="line"><span class="number">13</span>:     <span class="keyword">long</span> now = System.currentTimeMillis();</span><br /><span class="line"><span class="number">14</span>:     List&lt;URL&gt; result = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br /><span class="line"><span class="number">15</span>:     List&lt;String&gt; categories = Arrays.asList(url.getParameter(Constants.CATEGORY_KEY, <span class="keyword">new</span> String[<span class="number">0</span>])); <span class="comment">// 分类数组</span></span><br /><span class="line"><span class="number">16</span>:     String consumerService = url.getServiceInterface(); <span class="comment">// 服务接口</span></span><br /><span class="line"><span class="number">17</span>:     <span class="comment">// 循环分类层，例如：`/dubbo/com.alibaba.dubbo.demo.DemoService/providers`</span></span><br /><span class="line"><span class="number">18</span>:     <span class="keyword">for</span> (String key : keys) {</span><br /><span class="line"><span class="number">19</span>:         <span class="comment">// 若服务不匹配，返回</span></span><br /><span class="line"><span class="number">20</span>:         <span class="keyword">if</span> (!Constants.ANY_VALUE.equals(consumerService)) {</span><br /><span class="line"><span class="number">21</span>:             String providerService = toServiceName(key);</span><br /><span class="line"><span class="number">22</span>:             <span class="keyword">if</span> (!providerService.equals(consumerService)) {</span><br /><span class="line"><span class="number">23</span>:                 <span class="keyword">continue</span>;</span><br /><span class="line"><span class="number">24</span>:             }</span><br /><span class="line"><span class="number">25</span>:         }</span><br /><span class="line"><span class="number">26</span>:         <span class="comment">// 若订阅的不包含该分类，返回</span></span><br /><span class="line"><span class="number">27</span>:         String category = toCategoryName(key);</span><br /><span class="line"><span class="number">28</span>:         <span class="keyword">if</span> (!categories.contains(Constants.ANY_VALUE) &amp;&amp; !categories.contains(category)) {</span><br /><span class="line"><span class="number">29</span>:             <span class="keyword">continue</span>;</span><br /><span class="line"><span class="number">30</span>:         }</span><br /><span class="line"><span class="number">31</span>:         <span class="comment">// 获得所有 URL 数组</span></span><br /><span class="line"><span class="number">32</span>:         List&lt;URL&gt; urls = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br /><span class="line"><span class="number">33</span>:         Map&lt;String, String&gt; values = jedis.hgetAll(key);</span><br /><span class="line"><span class="number">34</span>:         <span class="keyword">if</span> (values != <span class="keyword">null</span> &amp;&amp; values.size() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">35</span>:             <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : values.entrySet()) {</span><br /><span class="line"><span class="number">36</span>:                 URL u = URL.valueOf(entry.getKey());</span><br /><span class="line"><span class="number">37</span>:                 <span class="keyword">if</span> (!u.getParameter(Constants.DYNAMIC_KEY, <span class="keyword">true</span>) <span class="comment">// 非动态节点，因为动态节点，不受过期的限制</span></span><br /><span class="line"><span class="number">38</span>:                         || Long.parseLong(entry.getValue()) &gt;= now) { <span class="comment">// 未过期</span></span><br /><span class="line"><span class="number">39</span>:                     <span class="keyword">if</span> (UrlUtils.isMatch(url, u)) {</span><br /><span class="line"><span class="number">40</span>:                         urls.add(u);</span><br /><span class="line"><span class="number">41</span>:                     }</span><br /><span class="line"><span class="number">42</span>:                 }</span><br /><span class="line"><span class="number">43</span>:             }</span><br /><span class="line"><span class="number">44</span>:         }</span><br /><span class="line"><span class="number">45</span>:         <span class="comment">// 若不存在匹配，则创建 `empty://` 的 URL返回，用于清空该服务的该分类。</span></span><br /><span class="line"><span class="number">46</span>:         <span class="keyword">if</span> (urls.isEmpty()) {</span><br /><span class="line"><span class="number">47</span>:             urls.add(url.setProtocol(Constants.EMPTY_PROTOCOL)</span><br /><span class="line"><span class="number">48</span>:                     .setAddress(Constants.ANYHOST_VALUE)</span><br /><span class="line"><span class="number">49</span>:                     .setPath(toServiceName(key))</span><br /><span class="line"><span class="number">50</span>:                     .addParameter(Constants.CATEGORY_KEY, category));</span><br /><span class="line"><span class="number">51</span>:         }</span><br /><span class="line"><span class="number">52</span>:         result.addAll(urls);</span><br /><span class="line"><span class="number">53</span>:         <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line"><span class="number">54</span>:             logger.info(<span class="string">"redis notify: "</span> + key + <span class="string">" = "</span> + urls);</span><br /><span class="line"><span class="number">55</span>:         }</span><br /><span class="line"><span class="number">56</span>:     }</span><br /><span class="line"><span class="number">57</span>:     <span class="keyword">if</span> (result.isEmpty()) {</span><br /><span class="line"><span class="number">58</span>:         <span class="keyword">return</span>;</span><br /><span class="line"><span class="number">59</span>:     }</span><br /><span class="line"><span class="number">60</span>:     <span class="comment">// 全量数据获取完成时，调用 `super#notify(...)` 方法，回调 NotifyListener</span></span><br /><span class="line"><span class="number">61</span>:     <span class="keyword">for</span> (NotifyListener listener : listeners) {</span><br /><span class="line"><span class="number">62</span>:         <span class="keyword">super</span>.notify(url, listener, result);</span><br /><span class="line"><span class="number">63</span>:     }</span><br /><span class="line"><span class="number">64</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>两个重载的&nbsp;<code>#doNotify(...)</code>&nbsp;方法，主要差异点在前者少&nbsp;<code>url</code>&nbsp;和&nbsp;<code>listeners</code>&nbsp;方法参数。所以：</p>
<ul>
<li>
<p>第 3 行：我们可以看到调用&nbsp;<code>#getSubscribed()</code>&nbsp;方法，获得<strong>所有</strong>监听器。代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * 订阅 URL 的监听器集合</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * key：订阅者的 URL ，例如消费者的 URL</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;URL, Set&lt;NotifyListener&gt;&gt; subscribed = <span class="keyword">new</span> ConcurrentHashMap&lt;URL, Set&lt;NotifyListener&gt;&gt;();</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>x</li>
</ul>
</li>
<li>第 3 至 5 行：<strong>循环</strong>调用&nbsp;<code>#doNotify(jedis, keys, url, listeners)</code>&nbsp;方法，进行通知。<strong>但是呢</strong>？这样一来，通知的事件(&nbsp;<code>key</code>&nbsp;)和监听器未必匹配，因此在【第 20 至 30 行】的代码，进行匹配。</li>
</ul>
</li>
<li>第 15 行：获得分类层( Category )，即分类数组。在&nbsp;<a href="http://svip.iocoder.cn/Dubbo/registry-zookeeper/?self">《精尽 Dubbo 源码分析 &mdash;&mdash; 注册中心（二）之 Zookeeper》「4. 调用」</a>&nbsp;小节中，我们也看到，不同角色关注不同的分类数据。
<ul>
<li>服务消费者，关注&nbsp;<code>providers</code>&nbsp;<code>configurations</code>&nbsp;<code>routes</code>&nbsp;。</li>
<li>服务提供者，关注&nbsp;<code>consumers</code>&nbsp;。</li>
<li>监控中心，关注所有。</li>
</ul>
</li>
<li>第 18 行：循环分类层，即每个元素为 Root + Service + Type ，例如：<code>/dubbo/com.alibaba.dubbo.demo.DemoService/providers</code>&nbsp;。</li>
<li>第 32 至 44 行：调用&nbsp;<code>Jedis#hgetAll(key)</code>&nbsp;方法，获得所有 URL 数组。并且，获取完成后，会过滤掉<strong>已过期</strong>的<strong>动态</strong>节点。</li>
<li>第 45 至 51 行：若不存在匹配，则创建&nbsp;<code>empty://</code>&nbsp;的 URL返回，用于<strong>清空</strong>该服务的该分类。</li>
<li>第 52 行：添加到&nbsp;<code>result</code>&nbsp;中。</li>
<li>第 60 至 63 行：全量数据获取完成时，调用&nbsp;<code>super#notify(...)</code>&nbsp;方法，回调 NotifyListener 。该方法，在&nbsp;<a href="http://svip.iocoder.cn/Dubbo/registry-api/?self">《精尽 Dubbo 源码分析 &mdash;&mdash; 注册中心（一）之抽象 API》</a>&nbsp;有详细解析。</li>
</ul>
<h3 id="2-6-1-toServiceName">2.6.1 toServiceName</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * 获得服务名，从服务路径上</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * Service</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> categoryPath 服务路径</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> 服务名</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">toServiceName</span><span class="params">(String categoryPath)</span> </span>{</span><br /><span class="line">    String servicePath = toServicePath(categoryPath);</span><br /><span class="line">    <span class="keyword">return</span> servicePath.startsWith(root) ? servicePath.substring(root.length()) : servicePath;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="2-6-2-toCategoryName">2.6.2 toCategoryName</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * 获得分类名，从分类路径上</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * Type</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> categoryPath 分类路径</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> 分类名</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">toCategoryName</span><span class="params">(String categoryPath)</span> </span>{</span><br /><span class="line">    <span class="keyword">int</span> i = categoryPath.lastIndexOf(Constants.PATH_SEPARATOR);</span><br /><span class="line">    <span class="keyword">return</span> i &gt; <span class="number">0</span> ? categoryPath.substring(i + <span class="number">1</span>) : categoryPath;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="2-7-deferExpired">2.7 deferExpired</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">deferExpired</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="keyword">for</span> (Map.Entry&lt;String, JedisPool&gt; entry : jedisPools.entrySet()) {</span><br /><span class="line"> <span class="number">3</span>:         JedisPool jedisPool = entry.getValue();</span><br /><span class="line"> <span class="number">4</span>:         <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">5</span>:             Jedis jedis = jedisPool.getResource();</span><br /><span class="line"> <span class="number">6</span>:             <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">7</span>:                 <span class="comment">// 循环已注册的 URL 集合</span></span><br /><span class="line"> <span class="number">8</span>:                 <span class="keyword">for</span> (URL url : <span class="keyword">new</span> HashSet&lt;URL&gt;(getRegistered())) {</span><br /><span class="line"> <span class="number">9</span>:                     <span class="comment">// 动态节点</span></span><br /><span class="line"><span class="number">10</span>:                     <span class="keyword">if</span> (url.getParameter(Constants.DYNAMIC_KEY, <span class="keyword">true</span>)) {</span><br /><span class="line"><span class="number">11</span>:                         <span class="comment">// 获得分类路径</span></span><br /><span class="line"><span class="number">12</span>:                         String key = toCategoryPath(url);</span><br /><span class="line"><span class="number">13</span>:                         <span class="comment">// 写入 Redis Map 中</span></span><br /><span class="line"><span class="number">14</span>:                         <span class="keyword">if</span> (jedis.hset(key, url.toFullString(), String.valueOf(System.currentTimeMillis() + expirePeriod)) == <span class="number">1</span>) {</span><br /><span class="line"><span class="number">15</span>:                             <span class="comment">// 发布 `register` 事件。</span></span><br /><span class="line"><span class="number">16</span>:                             jedis.publish(key, Constants.REGISTER);</span><br /><span class="line"><span class="number">17</span>:                         }</span><br /><span class="line"><span class="number">18</span>:                     }</span><br /><span class="line"><span class="number">19</span>:                 }</span><br /><span class="line"><span class="number">20</span>:                 <span class="comment">// 监控中心负责删除过期脏数据</span></span><br /><span class="line"><span class="number">21</span>:                 <span class="keyword">if</span> (admin) {</span><br /><span class="line"><span class="number">22</span>:                     clean(jedis);</span><br /><span class="line"><span class="number">23</span>:                 }</span><br /><span class="line"><span class="number">24</span>:                 <span class="comment">// 如果服务器端已同步数据，只需写入单台机器</span></span><br /><span class="line"><span class="number">25</span>:                 <span class="keyword">if</span> (!replicate) {</span><br /><span class="line"><span class="number">26</span>:                     <span class="keyword">break</span>;<span class="comment">// &nbsp;If the server side has synchronized data, just write a single machine</span></span><br /><span class="line"><span class="number">27</span>:                 }</span><br /><span class="line"><span class="number">28</span>:             } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">29</span>:                 jedisPool.returnResource(jedis);</span><br /><span class="line"><span class="number">30</span>:             }</span><br /><span class="line"><span class="number">31</span>:         } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">32</span>:             logger.warn(<span class="string">"Failed to write provider heartbeat to redis registry. registry: "</span> + entry.getKey() + <span class="string">", cause: "</span> + t.getMessage(), t);</span><br /><span class="line"><span class="number">33</span>:         }</span><br /><span class="line"><span class="number">34</span>:     }</span><br /><span class="line"><span class="number">35</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>被&nbsp;<code>expireExecutor</code>&nbsp;中的定时调用，整体逻辑类似&nbsp;<code>#doRegister()</code>&nbsp;方法。</li>
<li>
<p>第 8 行：调用&nbsp;<code>#getRegistered()</code>&nbsp;方法，获得已注册的 URL 集合。代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * 已注册 URL 集合。</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * 注意，注册的 URL 不仅仅可以是服务提供者的，也可以是服务消费者的</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;URL&gt; registered = <span class="keyword">new</span> ConcurrentHashSet&lt;URL&gt;();</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>第 8 行：循环 URL 集合。</p>
</li>
<li>第 10 行：判断是否为<strong>动态</strong>节点，只有动态节点需要延长过期时间。</li>
<li>第 14 行：调用&nbsp;<code>Jedis#hset(key, value, expire)</code>&nbsp;方法，写入 Redis Map 中。<strong>注意，过期时间，作为 Map 的值</strong>。</li>
<li>第 16 行：若【第 14 行】写入返回的值为 1 ，说明 Map 中该键对应的值不存在（例如，多写 Redis 节点时，有个节点写入失败），发布&nbsp;<code>register</code>&nbsp;事件。</li>
<li>第 21 至 23 行：若是注册中心(&nbsp;<code>admin = true</code>&nbsp;) 时，调用&nbsp;<code>#clean(Jedis)</code>&nbsp;方法，清理过期脏数据。</li>
<li>第 25 至 27 行：如果服务器端已同步数据，只需写入单台机器。</li>
</ul>
<h3 id="2-7-1-clean">2.7.1 clean</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clean</span><span class="params">(Jedis jedis)</span> </span>{</span><br /><span class="line">    <span class="comment">// 获得所有服务</span></span><br /><span class="line">    Set&lt;String&gt; keys = jedis.keys(root + Constants.ANY_VALUE);</span><br /><span class="line">    <span class="keyword">if</span> (keys != <span class="keyword">null</span> &amp;&amp; !keys.isEmpty()) {</span><br /><span class="line">        <span class="keyword">for</span> (String key : keys) {</span><br /><span class="line">            <span class="comment">// 获得所有 URL</span></span><br /><span class="line">            Map&lt;String, String&gt; values = jedis.hgetAll(key);</span><br /><span class="line">            <span class="keyword">if</span> (values != <span class="keyword">null</span> &amp;&amp; values.size() &gt; <span class="number">0</span>) {</span><br /><span class="line">                <span class="keyword">boolean</span> delete = <span class="keyword">false</span>;</span><br /><span class="line">                <span class="keyword">long</span> now = System.currentTimeMillis();</span><br /><span class="line">                <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : values.entrySet()) {</span><br /><span class="line">                    URL url = URL.valueOf(entry.getKey());</span><br /><span class="line">                    <span class="comment">// 动态节点</span></span><br /><span class="line">                    <span class="keyword">if</span> (url.getParameter(Constants.DYNAMIC_KEY, <span class="keyword">true</span>)) {</span><br /><span class="line">                        <span class="keyword">long</span> expire = Long.parseLong(entry.getValue());</span><br /><span class="line">                        <span class="comment">// 已经过期</span></span><br /><span class="line">                        <span class="keyword">if</span> (expire &lt; now) {</span><br /><span class="line">                            <span class="comment">//</span></span><br /><span class="line">                            jedis.hdel(key, entry.getKey());</span><br /><span class="line">                            delete = <span class="keyword">true</span>;</span><br /><span class="line">                            <span class="keyword">if</span> (logger.isWarnEnabled()) {</span><br /><span class="line">                                logger.warn(<span class="string">"Delete expired key: "</span> + key + <span class="string">" -&gt; value: "</span> + entry.getKey() + <span class="string">", expire: "</span> + <span class="keyword">new</span> Date(expire) + <span class="string">", now: "</span> + <span class="keyword">new</span> Date(now));</span><br /><span class="line">                            }</span><br /><span class="line">                        }</span><br /><span class="line">                    }</span><br /><span class="line">                }</span><br /><span class="line">                <span class="comment">// 若删除成功，发布 `unregister` 事件</span></span><br /><span class="line">                <span class="keyword">if</span> (delete) {</span><br /><span class="line">                    jedis.publish(key, Constants.UNREGISTER);</span><br /><span class="line">                }</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>整体逻辑类似&nbsp;<code>#doUnregister()</code>&nbsp;方法。</li>
<li>🙂 胖友自己看方法的注释哈。</li>
</ul>
<h2 id="2-8-isAvailable">2.8 isAvailable</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAvailable</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">for</span> (JedisPool jedisPool : jedisPools.values()) {</span><br /><span class="line">        <span class="keyword">try</span> {</span><br /><span class="line">            Jedis jedis = jedisPool.getResource();</span><br /><span class="line">            <span class="keyword">try</span> {</span><br /><span class="line">                <span class="keyword">if</span> (jedis.isConnected()) { <span class="comment">// 至少一个 Redis 节点可用</span></span><br /><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// At least one single machine is available.</span></span><br /><span class="line">                }</span><br /><span class="line">            } <span class="keyword">finally</span> {</span><br /><span class="line">                jedisPool.returnResource(jedis);</span><br /><span class="line">            }</span><br /><span class="line">        } <span class="keyword">catch</span> (Throwable ignored) {</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="2-9-destroy">2.9 destroy</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// 父类关闭</span></span><br /><span class="line">    <span class="keyword">super</span>.destroy();</span><br /><span class="line">    <span class="comment">// 关闭定时任务</span></span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        expireFuture.cancel(<span class="keyword">true</span>);</span><br /><span class="line">    } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line">        logger.warn(t.getMessage(), t);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// 关闭通知器</span></span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        <span class="keyword">for</span> (Notifier notifier : notifiers.values()) {</span><br /><span class="line">            notifier.shutdown();</span><br /><span class="line">        }</span><br /><span class="line">    } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line">        logger.warn(t.getMessage(), t);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// 关闭连接池</span></span><br /><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, JedisPool&gt; entry : jedisPools.entrySet()) {</span><br /><span class="line">        JedisPool jedisPool = entry.getValue();</span><br /><span class="line">        <span class="keyword">try</span> {</span><br /><span class="line">            jedisPool.destroy();</span><br /><span class="line">        } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line">            logger.warn(<span class="string">"Failed to destroy the redis registry client. registry: "</span> + entry.getKey() + <span class="string">", cause: "</span> + t.getMessage(), t);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h1 id="3-Notifier">3. Notifier</h1>
<blockquote>
<p>Notifier 是 RedisRegistry 的内部类。</p>
</blockquote>
<p>Notifier ，继承 Thread 类，负责向 Redis 发起订阅逻辑。</p>
<h2 id="3-1-构造方法">3.1 构造方法</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 2:  * 服务名 Root + Service</span></span><br /><span class="line"><span class="comment"> 3:  */</span></span><br /><span class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">final</span> String service;</span><br /><span class="line"> <span class="number">5</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 6:  * Jedis</span></span><br /><span class="line"><span class="comment"> 7:  */</span></span><br /><span class="line"> <span class="number">8</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> Jedis jedis;</span><br /><span class="line"> <span class="number">9</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">10:  * 是否首次</span></span><br /><span class="line"><span class="comment">11:  */</span></span><br /><span class="line"><span class="number">12</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> first = <span class="keyword">true</span>;</span><br /><span class="line"><span class="number">13</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">14:  * 是否运行中</span></span><br /><span class="line"><span class="comment">15:  */</span></span><br /><span class="line"><span class="number">16</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> running = <span class="keyword">true</span>;</span><br /><span class="line"><span class="number">17</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">18:  * 连接次数随机数</span></span><br /><span class="line"><span class="comment">19:  */</span></span><br /><span class="line"><span class="number">20</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> connectRandom;</span><br /><span class="line"><span class="number">21</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">22:  * 需要忽略连接的次数</span></span><br /><span class="line"><span class="comment">23:  */</span></span><br /><span class="line"><span class="number">24</span>: <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger connectSkip = <span class="keyword">new</span> AtomicInteger();</span><br /><span class="line"><span class="number">25</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">26:  * 已经忽略连接的次数</span></span><br /><span class="line"><span class="comment">27:  */</span></span><br /><span class="line"><span class="number">28</span>: <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger connectSkiped = <span class="keyword">new</span> AtomicInteger();</span><br /><span class="line"><span class="number">29</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">30:  * 随机</span></span><br /><span class="line"><span class="comment">31:  */</span></span><br /><span class="line"><span class="number">32</span>: <span class="keyword">private</span> <span class="keyword">final</span> Random random = <span class="keyword">new</span> Random();</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>service</code>&nbsp;属性，服务名 Root + Service。</li>
<li><code>first</code>&nbsp;属性，是否首次。在&nbsp;<code>#run()</code>&nbsp;方法中，查看。</li>
<li>
<p>【第 13 至 32 行】的属性，相当于<strong>重连策略</strong>，用于和 Redis 断开时，忽略一定次数和 Redis 的连接，避免空跑。涉及方法如下：</p>
<ul>
<li>
<p><code>#isSkip()</code>&nbsp;方法，判断是否忽略本次对 Redis 的连接。代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isSkip</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="comment">// 获得需要忽略连接的总次数。如果超过 10 ，则加上一个 10 以内的随机数。</span></span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">int</span> skip = connectSkip.get(); <span class="comment">// Growth of skipping times</span></span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (skip &gt;= <span class="number">10</span>) { <span class="comment">// If the number of skipping times increases by more than 10, take the random number</span></span><br /><span class="line"> <span class="number">5</span>:         <span class="keyword">if</span> (connectRandom == <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">6</span>:             connectRandom = random.nextInt(<span class="number">10</span>);</span><br /><span class="line"> <span class="number">7</span>:         }</span><br /><span class="line"> <span class="number">8</span>:         skip = <span class="number">10</span> + connectRandom;</span><br /><span class="line"> <span class="number">9</span>:     }</span><br /><span class="line"><span class="number">10</span>:     <span class="comment">// 自增忽略次数。若忽略次数不够，则继续忽略。</span></span><br /><span class="line"><span class="number">11</span>:     <span class="keyword">if</span> (connectSkiped.getAndIncrement() &lt; skip) { <span class="comment">// Check the number of skipping times</span></span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">return</span> <span class="keyword">true</span>;</span><br /><span class="line"><span class="number">13</span>:     }</span><br /><span class="line"><span class="number">14</span>:     <span class="comment">// 增加需要忽略的次数</span></span><br /><span class="line"><span class="number">15</span>:     connectSkip.incrementAndGet();</span><br /><span class="line"><span class="number">16</span>:     <span class="comment">// 重置已忽略次数和随机数</span></span><br /><span class="line"><span class="number">17</span>:     connectSkiped.set(<span class="number">0</span>);</span><br /><span class="line"><span class="number">18</span>:     connectRandom = <span class="number">0</span>;</span><br /><span class="line"><span class="number">19</span>:     <span class="keyword">return</span> <span class="keyword">false</span>;</span><br /><span class="line"><span class="number">20</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>第 2 至 9 行：获得<strong>需要忽略连接的总次数</strong>。如果超过 10 ，则加上一个 10 以内的随机数。思路是，连接失败的次数越多，<strong>每一轮</strong>加大需要忽略的总次数，并且带有一定的随机性。</li>
<li>第 10 至 13 行：自增忽略次数。若忽略次数不够，则继续忽略，即返回&nbsp;<code>true</code>&nbsp;。</li>
<li>
<p>第 15 行：增加需要忽略的次数。也就是说，<strong>下一轮</strong>，不考虑随机数，会多一次。如下是一次模拟：</p>
<blockquote>
<p>第一轮</p>
<ul>
<li>connectSkip: 0; connectSkiped: 0</li>
</ul>
<p>第二轮</p>
<ul>
<li>connectSkip: 1; connectSkiped: 0</li>
<li>connectSkip: 1; connectSkiped: 1</li>
</ul>
<p>第三轮</p>
<ul>
<li>connectSkip: 2; connectSkiped: 0</li>
<li>connectSkip: 2; connectSkiped: 1</li>
<li>connectSkip: 2; connectSkiped: 2</li>
</ul>
</blockquote>
<ul>
<li>当超过十轮后，增加随机数。</li>
</ul>
</li>
<li>
<p>第 16 至 18 行：重置已忽略次数和随机数。</p>
</li>
</ul>
</li>
<li>
<p><code>#resetSkip()</code>&nbsp;方法，重置忽略连接的信息。代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resetSkip</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// 重置需要连接的次数</span></span><br /><span class="line">    connectSkip.set(<span class="number">0</span>);</span><br /><span class="line">    <span class="comment">// 重置已忽略次数和随机数</span></span><br /><span class="line">    connectSkiped.set(<span class="number">0</span>);</span><br /><span class="line">    connectRandom = <span class="number">0</span>;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>x</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="3-2-run">3.2 run</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">while</span> (running) {</span><br /><span class="line"> <span class="number">4</span>:         <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">5</span>:             <span class="comment">// 是否跳过本次 Redis 连接</span></span><br /><span class="line"> <span class="number">6</span>:             <span class="keyword">if</span> (!isSkip()) {</span><br /><span class="line"> <span class="number">7</span>:                 <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">8</span>:                     <span class="keyword">for</span> (Map.Entry&lt;String, JedisPool&gt; entry : jedisPools.entrySet()) {</span><br /><span class="line"> <span class="number">9</span>:                         JedisPool jedisPool = entry.getValue();</span><br /><span class="line"><span class="number">10</span>:                         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">11</span>:                             jedis = jedisPool.getResource();</span><br /><span class="line"><span class="number">12</span>:                             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">13</span>:                                 <span class="comment">// 监控中心</span></span><br /><span class="line"><span class="number">14</span>:                                 <span class="keyword">if</span> (service.endsWith(Constants.ANY_VALUE)) {</span><br /><span class="line"><span class="number">15</span>:                                     <span class="keyword">if</span> (!first) {</span><br /><span class="line"><span class="number">16</span>:                                         first = <span class="keyword">false</span>;</span><br /><span class="line"><span class="number">17</span>:                                         Set&lt;String&gt; keys = jedis.keys(service);</span><br /><span class="line"><span class="number">18</span>:                                         <span class="keyword">if</span> (keys != <span class="keyword">null</span> &amp;&amp; !keys.isEmpty()) {</span><br /><span class="line"><span class="number">19</span>:                                             <span class="keyword">for</span> (String s : keys) {</span><br /><span class="line"><span class="number">20</span>:                                                 doNotify(jedis, s);</span><br /><span class="line"><span class="number">21</span>:                                             }</span><br /><span class="line"><span class="number">22</span>:                                         }</span><br /><span class="line"><span class="number">23</span>:                                         resetSkip();</span><br /><span class="line"><span class="number">24</span>:                                     }</span><br /><span class="line"><span class="number">25</span>:                                     <span class="comment">// 批订阅</span></span><br /><span class="line"><span class="number">26</span>:                                     jedis.psubscribe(<span class="keyword">new</span> NotifySub(jedisPool), service); <span class="comment">// blocking</span></span><br /><span class="line"><span class="number">27</span>:                                 <span class="comment">// 服务提供者或消费者</span></span><br /><span class="line"><span class="number">28</span>:                                 } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">29</span>:                                     <span class="keyword">if</span> (!first) {</span><br /><span class="line"><span class="number">30</span>:                                         first = <span class="keyword">false</span>;</span><br /><span class="line"><span class="number">31</span>:                                         doNotify(jedis, service);</span><br /><span class="line"><span class="number">32</span>:                                         resetSkip();</span><br /><span class="line"><span class="number">33</span>:                                     }</span><br /><span class="line"><span class="number">34</span>:                                     <span class="comment">// 批订阅</span></span><br /><span class="line"><span class="number">35</span>:                                     jedis.psubscribe(<span class="keyword">new</span> NotifySub(jedisPool), service + Constants.PATH_SEPARATOR + Constants.ANY_VALUE); <span class="comment">// blocking</span></span><br /><span class="line"><span class="number">36</span>:                                 }</span><br /><span class="line"><span class="number">37</span>:                                 <span class="keyword">break</span>;</span><br /><span class="line"><span class="number">38</span>:                             } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">39</span>:                                 jedisPool.returnBrokenResource(jedis);</span><br /><span class="line"><span class="number">40</span>:                             }</span><br /><span class="line"><span class="number">41</span>:                         } <span class="keyword">catch</span> (Throwable t) { <span class="comment">// Retry another server</span></span><br /><span class="line"><span class="number">42</span>:                             logger.warn(<span class="string">"Failed to subscribe service from redis registry. registry: "</span> + entry.getKey() + <span class="string">", cause: "</span> + t.getMessage(), t);</span><br /><span class="line"><span class="number">43</span>:                             <span class="comment">// If you only have a single redis, you need to take a rest to avoid overtaking a lot of CPU resources</span></span><br /><span class="line"><span class="number">44</span>:                             sleep(reconnectPeriod);</span><br /><span class="line"><span class="number">45</span>:                         }</span><br /><span class="line"><span class="number">46</span>:                     }</span><br /><span class="line"><span class="number">47</span>:                 } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">48</span>:                     logger.error(t.getMessage(), t);</span><br /><span class="line"><span class="number">49</span>:                     sleep(reconnectPeriod);</span><br /><span class="line"><span class="number">50</span>:                 }</span><br /><span class="line"><span class="number">51</span>:             }</span><br /><span class="line"><span class="number">52</span>:         } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">53</span>:             logger.error(t.getMessage(), t);</span><br /><span class="line"><span class="number">54</span>:         }</span><br /><span class="line"><span class="number">55</span>:     }</span><br /><span class="line"><span class="number">56</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>第 3 行：循环执行，直到关闭。</li>
<li>第 6 行：调用&nbsp;<code>#isSkip()</code>&nbsp;方法，判断是否跳过本次 Redis 连接。But ，即使跳过，也没有执行类似 sleep 的逻辑，有点奇怪。这样，会导致实际即使跳过，也会快速向 Redis 发起订阅。【TODO 8032】Redis 重连逻辑</li>
<li>第 8 行：循环连接池，发起订阅，直到<strong>一个成功</strong>。</li>
<li>======================================================</li>
<li>
<p>【第一种情况】第 14 至 26 行：监控中心</p>
<ul>
<li>
<p>第 15 至 24 行：目前这块代码有一些问题？！初始时&nbsp;<code>first=true</code>&nbsp;，那么这块代码永远无法执行到。笔者猜测这块的意图是，在 ZookeeperRegistry 中，可以实现对连接状态的监听，从而实现断开重连成功后，从 Zookeeper 获取到最新的数据。代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">        zkClient.addStateListener(<span class="keyword">new</span> StateListener() {</span><br /><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stateChanged</span><span class="params">(<span class="keyword">int</span> state)</span> </span>{</span><br /><span class="line">                <span class="keyword">if</span> (state == RECONNECTED) {</span><br /><span class="line">                    <span class="keyword">try</span> {</span><br /><span class="line">                        recover();</span><br /><span class="line">                    } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line">                        logger.error(e.getMessage(), e);</span><br /><span class="line">                    }</span><br /><span class="line">                }</span><br /><span class="line">            }</span><br /><span class="line">        });</span><br /><span class="line">        ``` </span><br /><span class="line">        * 而 JedisPool 中，不提供这样的连接监控机制。那么如果订阅 Redis 发生了异常，我们可以认为 Redis 连接断开了，需要重新发起订阅，并且需要**重新**从 Redis 中获取到最新的数据。</span><br /><span class="line">        * 那么此处的代码可以这样改：</span><br /><span class="line">            * 第 <span class="number">16</span> 行： `first = <span class="keyword">true</span>;`</span><br /><span class="line">            * 第 <span class="number">42</span> 行：增加 `first = <span class="keyword">false</span>;`</span><br /><span class="line">    * 第 26 行：调用 `Jedis#psubscribe(JedisPubSub jedisPubSub, String... patterns)` 方法，订阅**所有 Service 层**。</span><br /><span class="line">* 【第二种情况】第 <span class="number">27</span> 至 <span class="number">36</span> 行：服务提供者或消费者。</span><br /><span class="line">    * 第 <span class="number">29</span> 至 <span class="number">34</span> 行：和【第 <span class="number">15</span> 至 <span class="number">24</span> 行】**类似**。</span><br /><span class="line">    * 第 35 行：调用 `Jedis#psubscribe(JedisPubSub jedisPubSub, String... patterns)` 方法，订阅**指定 Service 层**。</span><br /><span class="line">*  ======================================================</span><br /><span class="line">*  第 37 至 40 行：无法执行到，因为 `Jedis#psubscribe(JedisPubSub jedisPubSub, String... patterns)` 方法，是**阻塞**的。这也是为什么 Notifier 是一个 **Thread** 的原因。</span><br /><span class="line">*  第 41 至 45 行：发生异常，说明 Redis 连接断开了。因此，调用 `#sleep(millis)` 方法，等待 Redis 重连成功。通过这样的方式，避免执行，占用大量的 CPU 资源。</span><br /><br /><span class="line">## 3.3 shutdown</span><br /><br /><span class="line">```Java</span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        <span class="comment">// 停止运行</span></span><br /><span class="line">        running = <span class="keyword">false</span>;</span><br /><span class="line">        <span class="comment">// Jedis 断开连接</span></span><br /><span class="line">        jedis.disconnect();</span><br /><span class="line">    } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line">        logger.warn(t.getMessage(), t);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
</li>
</ul>
<h1 id="4-NotifySub">4. NotifySub</h1>
<blockquote>
<p>NotifySub 是 RedisRegistry 的内部类。</p>
</blockquote>
<p>NotifySub ，实现&nbsp;<code>redis.clients.jedis.JedisPubSub</code>&nbsp;抽象类，通知订阅实现类。</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">NotifySub</span> <span class="keyword">extends</span> <span class="title">JedisPubSub</span> </span>{</span><br /><span class="line"> <span class="number">2</span>: </span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">private</span> <span class="keyword">final</span> JedisPool jedisPool;</span><br /><span class="line"> <span class="number">4</span>: </span><br /><span class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> <span class="title">NotifySub</span><span class="params">(JedisPool jedisPool)</span> </span>{</span><br /><span class="line"> <span class="number">6</span>:         <span class="keyword">this</span>.jedisPool = jedisPool;</span><br /><span class="line"> <span class="number">7</span>:     }</span><br /><span class="line"> <span class="number">8</span>: </span><br /><span class="line"> <span class="number">9</span>:     <span class="meta">@Override</span></span><br /><span class="line"><span class="number">10</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(String key, String msg)</span> </span>{</span><br /><span class="line"><span class="number">11</span>:         <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line"><span class="number">12</span>:             logger.info(<span class="string">"redis event: "</span> + key + <span class="string">" = "</span> + msg);</span><br /><span class="line"><span class="number">13</span>:         }</span><br /><span class="line"><span class="number">14</span>:         <span class="keyword">if</span> (msg.equals(Constants.REGISTER)</span><br /><span class="line"><span class="number">15</span>:                 || msg.equals(Constants.UNREGISTER)) {</span><br /><span class="line"><span class="number">16</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">17</span>:                 Jedis jedis = jedisPool.getResource();</span><br /><span class="line"><span class="number">18</span>:                 <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">19</span>:                     doNotify(jedis, key);</span><br /><span class="line"><span class="number">20</span>:                 } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">21</span>:                     jedisPool.returnResource(jedis);</span><br /><span class="line"><span class="number">22</span>:                 }</span><br /><span class="line"><span class="number">23</span>:             } <span class="keyword">catch</span> (Throwable t) { <span class="comment">// TODO Notification failure does not restore mechanism guarantee</span></span><br /><span class="line"><span class="number">24</span>:                 logger.error(t.getMessage(), t);</span><br /><span class="line"><span class="number">25</span>:             }</span><br /><span class="line"><span class="number">26</span>:         }</span><br /><span class="line"><span class="number">27</span>:     }</span><br /><span class="line"><span class="number">28</span>: </span><br /><span class="line"><span class="number">29</span>:     <span class="meta">@Override</span></span><br /><span class="line"><span class="number">30</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPMessage</span><span class="params">(String pattern, String key, String msg)</span> </span>{</span><br /><span class="line"><span class="number">31</span>:         onMessage(key, msg);</span><br /><span class="line"><span class="number">32</span>:     }</span><br /><span class="line"><span class="number">33</span>: </span><br /><span class="line"><span class="number">34</span>:     <span class="meta">@Override</span></span><br /><span class="line"><span class="number">35</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(String key, <span class="keyword">int</span> num)</span> </span>{</span><br /><span class="line"><span class="number">36</span>:     }</span><br /><span class="line"><span class="number">37</span>: </span><br /><span class="line"><span class="number">38</span>:     <span class="meta">@Override</span></span><br /><span class="line"><span class="number">39</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPSubscribe</span><span class="params">(String pattern, <span class="keyword">int</span> num)</span> </span>{</span><br /><span class="line"><span class="number">40</span>:     }</span><br /><span class="line"><span class="number">41</span>: </span><br /><span class="line"><span class="number">42</span>:     <span class="meta">@Override</span></span><br /><span class="line"><span class="number">43</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUnsubscribe</span><span class="params">(String key, <span class="keyword">int</span> num)</span> </span>{</span><br /><span class="line"><span class="number">44</span>:     }</span><br /><span class="line"><span class="number">45</span>: </span><br /><span class="line"><span class="number">46</span>:     <span class="meta">@Override</span></span><br /><span class="line"><span class="number">47</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPUnsubscribe</span><span class="params">(String pattern, <span class="keyword">int</span> num)</span> </span>{</span><br /><span class="line"><span class="number">48</span>:     }</span><br /><span class="line"><span class="number">49</span>: </span><br /><span class="line"><span class="number">50</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>实现了&nbsp;<code>#onMessage(key, msg)</code>&nbsp;和&nbsp;<code>#onPMessage(pattern, key, msg)</code>&nbsp;方法，收到&nbsp;<code>register</code><code>unregister</code>&nbsp;事件，调用&nbsp;<code>#doNotify(jedis, key)</code>&nbsp;方法，通知监听器，数据变化，从而实现<strong>实时</strong>更新。</li>
</ul>
<h1 id="5-可靠性">5. 可靠性</h1>
<blockquote>
<p>FROM&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/references/registry/redis.html" target="_blank" rel="external nofollow noopener noreferrer">《Dubbo 用户指南 &mdash;&mdash; Redis 注册中心》</a></p>
<p>阿里内部并没有采用 Redis 做为注册中心，而是使用自己实现的基于数据库的注册中心，即：Redis 注册中心并没有在阿里内部长时间运行的可靠性保障，此 Redis 桥接实现只为开源版本提供，其可靠性依赖于 Redis 本身的可靠性。</p>
</blockquote>
<blockquote>
<p>FROM&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/maturity.html" target="_blank" rel="external nofollow noopener noreferrer">《Dubbo 用户指南 &mdash;&mdash; 成熟度》</a></p>
<p>Redis注册中心</p>
<ul>
<li>Maturity：Stable</li>
<li>Strength：支持基于客户端双写的集群方式，性能高</li>
<li>Problem：要求服务器时间同步，用于检查心跳过期脏数据</li>
<li>Advise：可用于生产环境</li>
</ul>
</blockquote>
<p>做个小笔记，Redis 主从复制的情况下，从节点的订阅( Subscribe )，可以收到主节点的发布( Publish ) 。做这个笔记的原因是，原来担心&nbsp;<code>"failover"</code>&nbsp;模式下，Redis 主节点挂了，如果订阅从节点，会不会出现，Redis 主节点恢复后，收不到在其上的发布事件。</p>
</div>