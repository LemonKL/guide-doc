<header class="article-header">
<h1 class="article-title">过滤器（五）之 TimeoutFilter</h1>
</header>
<div class="article-entry">
<blockquote>
<p>本文基于 Dubbo 2.6.1 版本，望知悉。</p>
</blockquote>
<h1 id="1-概述">1. 概述</h1>
<p>本文分享过滤器 TimeoutFilter ，用于服务<strong>提供者</strong>中。</p>
<h1 id="2-TimeoutFilter">2. TimeoutFilter</h1>
<p><code>com.alibaba.dubbo.rpc.filter.TimeoutFilter</code>&nbsp;，实现 Filter 接口，超时过滤器。如果服务调用<strong>超时</strong>，记录<strong>告警</strong>日志，<strong>不干涉</strong>服务的运行。代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Activate</span>(group = Constants.PROVIDER)</span><br /><span class="line"> <span class="number">2</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeoutFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>{</span><br /><span class="line"> <span class="number">3</span>: </span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(TimeoutFilter.class);</span><br /><span class="line"> <span class="number">5</span>: </span><br /><span class="line"> <span class="number">6</span>:     <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">7</span>:     <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"> <span class="number">8</span>:         <span class="keyword">long</span> start = System.currentTimeMillis();</span><br /><span class="line"> <span class="number">9</span>:         <span class="comment">// 服务调用</span></span><br /><span class="line"><span class="number">10</span>:         Result result = invoker.invoke(invocation);</span><br /><span class="line"><span class="number">11</span>:         <span class="comment">// 计算调用时长</span></span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">long</span> elapsed = System.currentTimeMillis() - start;</span><br /><span class="line"><span class="number">13</span>:         <span class="comment">// 超过时长，打印告警日志</span></span><br /><span class="line"><span class="number">14</span>:         <span class="keyword">if</span> (invoker.getUrl() != <span class="keyword">null</span></span><br /><span class="line"><span class="number">15</span>:                 &amp;&amp; elapsed &gt; invoker.getUrl().getMethodParameter(invocation.getMethodName(), <span class="string">"timeout"</span>, Integer.MAX_VALUE)) {</span><br /><span class="line"><span class="number">16</span>:             <span class="keyword">if</span> (logger.isWarnEnabled()) {</span><br /><span class="line"><span class="number">17</span>:                 logger.warn(<span class="string">"invoke time out. method: "</span> + invocation.getMethodName()</span><br /><span class="line"><span class="number">18</span>:                         + <span class="string">" arguments: "</span> + Arrays.toString(invocation.getArguments()) + <span class="string">" , url is "</span></span><br /><span class="line"><span class="number">19</span>:                         + invoker.getUrl() + <span class="string">", invoke elapsed "</span> + elapsed + <span class="string">" ms."</span>);</span><br /><span class="line"><span class="number">20</span>:             }</span><br /><span class="line"><span class="number">21</span>:         }</span><br /><span class="line"><span class="number">22</span>:         <span class="keyword">return</span> result;</span><br /><span class="line"><span class="number">23</span>:     }</span><br /><span class="line"><span class="number">24</span>: </span><br /><span class="line"><span class="number">25</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>第 10 行：调用&nbsp;<code>Invoker#invoke(invocation)</code>&nbsp;方法，服务调用。</li>
<li>第 12 行：计算调用时长。</li>
<li>第 13 至 21 行：超过时长，打印<strong>告警</strong>日志。注意，此处的&nbsp;<code>"timeout"</code>&nbsp;取得的是服务<strong>提供者</strong>的配置，不同于服务<strong>消费者</strong>的配置。</li>
<li>第 22 行：返回调用结果。</li>
<li>🙂 再注意，在服务<strong>提供者</strong>，执行服务调用时，即使<strong>超过了超时时间</strong>，也不会取消执行。虽然，服务<strong>消费者</strong>，已经结束调用，返回调用超时。</li>
</ul>
</div>