<header class="article-header">
<h1 class="article-title">API 配置（二）之服务提供者</h1>
</header>
<div class="article-entry">
<blockquote>
<p>本文基于 Dubbo 2.6.1 版本，望知悉。</p>
</blockquote>
<blockquote>
<p>友情提示，【<strong>配置</strong>】这块的内容，会相对比较枯燥。所以，如果看到一些很难懂的地方，建议先跳过。</p>
<p>对于 Dubbo ，重点是要去理解，多协议、RPC、容错等等模块，而不是【<strong>配置</strong>】。</p>
<p>😈 估计好多胖友被【<strong>配置</strong>】这章劝退了把？？？</p>
</blockquote>
<h1 id="1-概述">1. 概述</h1>
<p>本文接&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-api-1/">《API 配置（一）之应用》</a>&nbsp;，分享<strong>服务提供者</strong>相关的配置：包括 provider-config 和 sub-config 部分。</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_01_07/03.png" alt="配置类关系" /></p>
<ul>
<li><strong>黄框</strong>部分，provider-side</li>
<li><strong>其他</strong>部分，sub-config</li>
</ul>
<hr />
<p>还是老样子，我们先来看一段&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/configuration/api.html" target="_blank" rel="external nofollow noopener noreferrer">《Dubbo 用户指南 &mdash;&mdash; API 配置》</a>&nbsp;，服务提供者的初始化代码：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// 服务实现</span></span><br /><span class="line">XxxService xxxService = <span class="keyword">new</span> XxxServiceImpl();</span><br /><br /><span class="line"><span class="comment">// 当前应用配置</span></span><br /><span class="line">ApplicationConfig application = <span class="keyword">new</span> ApplicationConfig();</span><br /><span class="line">application.setName(<span class="string">"xxx"</span>);</span><br /><br /><span class="line"><span class="comment">// 连接注册中心配置</span></span><br /><span class="line">RegistryConfig registry = <span class="keyword">new</span> RegistryConfig();</span><br /><span class="line">registry.setAddress(<span class="string">"10.20.130.230:9090"</span>);</span><br /><span class="line">registry.setUsername(<span class="string">"aaa"</span>);</span><br /><span class="line">registry.setPassword(<span class="string">"bbb"</span>);</span><br /><br /><span class="line"><span class="comment">// 服务提供者协议配置</span></span><br /><span class="line">ProtocolConfig protocol = <span class="keyword">new</span> ProtocolConfig();</span><br /><span class="line">protocol.setName(<span class="string">"dubbo"</span>);</span><br /><span class="line">protocol.setPort(<span class="number">12345</span>);</span><br /><span class="line">protocol.setThreads(<span class="number">200</span>);</span><br /><br /><span class="line"><span class="comment">// 注意：ServiceConfig为重对象，内部封装了与注册中心的连接，以及开启服务端口</span></span><br /><br /><span class="line"><span class="comment">// 服务提供者暴露服务配置</span></span><br /><span class="line">ServiceConfig&lt;XxxService&gt; service = <span class="keyword">new</span> ServiceConfig&lt;XxxService&gt;(); <span class="comment">// 此实例很重，封装了与注册中心的连接，请自行缓存，否则可能造成内存和连接泄漏</span></span><br /><span class="line">service.setApplication(application);</span><br /><span class="line">service.setRegistry(registry); <span class="comment">// 多个注册中心可以用setRegistries()</span></span><br /><span class="line">service.setProtocol(protocol); <span class="comment">// 多个协议可以用setProtocols()</span></span><br /><span class="line">service.setInterface(XxxService.class);</span><br /><span class="line">service.setRef(xxxService);</span><br /><span class="line">service.setVersion(<span class="string">"1.0.0"</span>);</span><br /><br /><span class="line"><span class="comment">// 暴露及注册服务</span></span><br /><span class="line">service.export();</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>相比 ReferenceConfig 的初始化，会多创建 ProtocolConfig 对象，设置到 ServiceConfig 对象中。</li>
</ul>
<blockquote>
<p>友情提示：本文前面部分会比较琐碎，重点在&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-api-2/">「8. ServiceConfig」</a>&nbsp;部分。</p>
</blockquote>
<h1 id="2-ProtocolConfig">2. ProtocolConfig</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ProtocolConfig.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.config.ProtocolConfig</code></a>&nbsp;，服务提供者协议配置。</p>
<ul>
<li>具体属性的解释，参见&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/references/xml/dubbo-protocol.html" target="_blank" rel="external nofollow noopener noreferrer">《Dubbo 用户指南 &mdash;&mdash; dubbo:protocol》</a>&nbsp;文档。</li>
</ul>
<h1 id="3-AbstractMethodConfig">3. AbstractMethodConfig</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractMethodConfig.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.config.AbstractMethodConfig</code></a>&nbsp;，方法级配置的抽象类。</p>
<ul>
<li><strong>部分</strong>属性的解释，参见&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/references/xml/dubbo-method.html" target="_blank" rel="external nofollow noopener noreferrer">《Dubbo 用户指南 &mdash;&mdash; dubbo:method》</a>&nbsp;文档。</li>
</ul>
<h1 id="4-MethodConfig">4. MethodConfig</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractMethodConfig.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.config.MethodConfig</code></a>&nbsp;，继承 AbstractMethodConfig ，方法级配置。</p>
<ul>
<li>具体属性的解释，<a href="http://dubbo.apache.org/zh-cn/docs/user/references/xml/dubbo-method.html" target="_blank" rel="external nofollow noopener noreferrer">《Dubbo 用户指南 &mdash;&mdash; dubbo:method》</a>&nbsp;文档。</li>
</ul>
<h1 id="5-AbstractInterfaceConfig">5. AbstractInterfaceConfig</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.config.AbstractInterfaceConfig</code></a>&nbsp;，继承 AbstractMethodConfig ，抽象接口配置类。</p>
<ul>
<li>具体属性的解释，<strong>需要寻找</strong>在&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/references/xml/dubbo-service.html" target="_blank" rel="external nofollow noopener noreferrer">《Dubbo 用户指南 &mdash;&mdash; dubbo:service》</a>&nbsp;或&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/references/xml/dubbo-reference.html" target="_blank" rel="external nofollow noopener noreferrer">《Dubbo 用户指南 &mdash;&mdash; dubbo:reference》</a>&nbsp;文档。</li>
<li>下面的方法，会在&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-api-2/">「8. ServiceConfig」</a>&nbsp;的初始化被调用，胖友可需要的时候，点击查看。</li>
<li><a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L156-L187" target="_blank" rel="external nofollow noopener noreferrer"><code>#checkApplication()</code></a>&nbsp;方法，校验 ApplicationConfig 配置。<strong>实际上</strong>，该方法会初始化 ApplicationConfig 的配置属性。
<ul>
<li>🙂 直接点击方法查看，较为简单，已经添加详细注释。</li>
</ul>
</li>
<li><a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L122-L154" target="_blank" rel="external nofollow noopener noreferrer"><code>#checkRegistry()</code></a>&nbsp;方法，校验 RegistryConfig 配置。<strong>实际上</strong>，该方法会初始化 RegistryConfig 的配置属性。
<ul>
<li>🙂 直接点击方法查看，较为简单，已经添加详细注释。</li>
</ul>
</li>
<li><a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L280-L317" target="_blank" rel="external nofollow noopener noreferrer"><code>#checkInterfaceAndMethods(interfaceClass, methods)</code></a>&nbsp;方法，校验接口和方法。主要是两方面：
<ul>
<li>1、 接口类非空，并是接口</li>
<li>2、 方法在接口中已定义</li>
<li>🙂 直接点击方法查看，较为简单，已经添加详细注释。</li>
</ul>
</li>
<li><a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L319-L368" target="_blank" rel="external nofollow noopener noreferrer"><code>#checkStubAndMock(interfaceClass)</code></a>&nbsp;方法，校验 Stub 和 Mock 相关的配置。</li>
<li>以上未列举的&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L189-L233" target="_blank" rel="external nofollow noopener noreferrer"><code>#loadRegistries(provider)</code></a>&nbsp;和&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L235-L278" target="_blank" rel="external nofollow noopener noreferrer"><code>#loadMonitor(registryURL)</code></a>&nbsp;方法，在<strong>后续文章</strong>需要使用到时，在详细分享。</li>
</ul>
<h1 id="6-AbstractServiceConfig">6. AbstractServiceConfig</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractServiceConfig.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.config.AbstractServiceConfig</code></a>&nbsp;，实现 AbstractInterfaceConfig ，抽象服务配置类。</p>
<ul>
<li>具体属性的解释，<strong>需要寻找</strong>在&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/references/xml/dubbo-service.html" target="_blank" rel="external nofollow noopener noreferrer">《Dubbo 用户指南 &mdash;&mdash; dubbo:service》</a>&nbsp;或&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/references/xml/dubbo-provider.html" target="_blank" rel="external nofollow noopener noreferrer">《Dubbo 用户指南 &mdash;&mdash; dubbo:provider》</a>&nbsp;文档。</li>
</ul>
<h1 id="7-ProviderConfig">7. ProviderConfig</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ProviderConfig.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.config.ProviderConfig</code></a>&nbsp;，实现 AbstractServiceConfig ，服务提供者缺省值配置。</p>
<ul>
<li>具体属性的解释，参见&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/references/xml/dubbo-provider.html" target="_blank" rel="external nofollow noopener noreferrer">《Dubbo 用户指南 &mdash;&mdash; dubbo:provider》</a>&nbsp;文档。</li>
</ul>
<h1 id="8-ServiceConfig">8. ServiceConfig</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.config.ServiceConfig</code></a>&nbsp;，服务提供者暴露<strong>服务配置类</strong>。</p>
<ul>
<li>具体属性的解释，参见&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/references/xml/dubbo-service.html" target="_blank" rel="external nofollow noopener noreferrer">《Dubbo 用户指南 &mdash;&mdash; dubbo:service》</a>&nbsp;文档。</li>
</ul>
<p>下面，我们进入<strong>正戏</strong>。</p>
<p>在文初的 ServiceConfig 的初始化示例代码中，最后调用的是&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L239" target="_blank" rel="external nofollow noopener noreferrer"><code>ServiceConfig#export()</code></a>&nbsp;方法。从方法的命名，我们可以看出，<strong>暴露服务</strong>。该方法主要做了如下几件事情：</p>
<ol>
<li><strong>进一步初始化</strong>&nbsp;ServiceConfig 对象。</li>
<li><strong>校验</strong>&nbsp;ServiceConfig 对象的配置项。</li>
<li>使用 ServiceConfig 对象，<strong>生成</strong>&nbsp;Dubbo URL 对象<strong>数组</strong>。</li>
<li>使用 Dubbo URL 对象，<strong>暴露服务</strong>。</li>
</ol>
<p>😈 本文重点在服务提供者相关的配置，因此只解析&nbsp;<strong>1+2+3</strong>&nbsp;部分( 不包括 4 )。代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">export</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="comment">// 当 export 或者 delay 未配置，从 ProviderConfig 对象读取。</span></span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (provider != <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">4</span>:         <span class="keyword">if</span> (export == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">5</span>:             export = provider.getExport();</span><br /><span class="line"> <span class="number">6</span>:         }</span><br /><span class="line"> <span class="number">7</span>:         <span class="keyword">if</span> (delay == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">8</span>:             delay = provider.getDelay();</span><br /><span class="line"> <span class="number">9</span>:         }</span><br /><span class="line"><span class="number">10</span>:     }</span><br /><span class="line"><span class="number">11</span>:     <span class="comment">// 不暴露服务( export = false ) ，则不进行暴露服务逻辑。</span></span><br /><span class="line"><span class="number">12</span>:     <span class="keyword">if</span> (export != <span class="keyword">null</span> &amp;&amp; !export) {</span><br /><span class="line"><span class="number">13</span>:         <span class="keyword">return</span>;</span><br /><span class="line"><span class="number">14</span>:     }</span><br /><span class="line"><span class="number">15</span>: </span><br /><span class="line"><span class="number">16</span>:     <span class="comment">// 延迟暴露</span></span><br /><span class="line"><span class="number">17</span>:     <span class="keyword">if</span> (delay != <span class="keyword">null</span> &amp;&amp; delay &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">18</span>:         delayExportExecutor.schedule(<span class="keyword">new</span> Runnable() {</span><br /><span class="line"><span class="number">19</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br /><span class="line"><span class="number">20</span>:                 doExport();</span><br /><span class="line"><span class="number">21</span>:             }</span><br /><span class="line"><span class="number">22</span>:         }, delay, TimeUnit.MILLISECONDS);</span><br /><span class="line"><span class="number">23</span>:     <span class="comment">// 立即暴露</span></span><br /><span class="line"><span class="number">24</span>:     } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">25</span>:         doExport();</span><br /><span class="line"><span class="number">26</span>:     }</span><br /><span class="line"><span class="number">27</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>第 2 至 10 行：当&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractServiceConfig.java#L48" target="_blank" rel="external nofollow noopener noreferrer"><code>export</code></a>&nbsp;或&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractServiceConfig.java#L45" target="_blank" rel="external nofollow noopener noreferrer"><code>delay</code></a>&nbsp;未配置时，从 ProviderConfig 对象读取。</li>
<li>第 11 至 14 行：当配置不需要暴露服务(&nbsp;<code>export = false</code>&nbsp;)时，直接返回。</li>
<li>第 17 至 22 行：当配置延迟暴露(&nbsp;<code>delay &gt; 0</code>&nbsp;)时，使用&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L86" target="_blank" rel="external nofollow noopener noreferrer"><code>delayExportExecutor</code></a>&nbsp;<strong>延迟</strong>调度，调用&nbsp;<code>#doExport()</code>&nbsp;方法。
<ul>
<li><a href="http://dubbo.apache.org/zh-cn/docs/user/demos/delay-publish.html" target="_blank" rel="external nofollow noopener noreferrer">《Dubbo 用户指南 &mdash;&mdash; 延迟暴露》</a></li>
</ul>
</li>
<li>第 23 至 26 行：立即暴露，调用&nbsp;<code>#doExport()</code>&nbsp;方法。</li>
</ul>
<hr />
<p><a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L267-L391" target="_blank" rel="external nofollow noopener noreferrer"><code>#doExport()</code></a>&nbsp;方法，代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">doExport</span><span class="params">()</span> </span>{</span><br /><span class="line">  <span class="number">2</span>:     <span class="comment">// 检查是否可以暴露，若可以，标记已经暴露。</span></span><br /><span class="line">  <span class="number">3</span>:     <span class="keyword">if</span> (unexported) {</span><br /><span class="line">  <span class="number">4</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already unexported!"</span>);</span><br /><span class="line">  <span class="number">5</span>:     }</span><br /><span class="line">  <span class="number">6</span>:     <span class="keyword">if</span> (exported) {</span><br /><span class="line">  <span class="number">7</span>:         <span class="keyword">return</span>;</span><br /><span class="line">  <span class="number">8</span>:     }</span><br /><span class="line">  <span class="number">9</span>:     exported = <span class="keyword">true</span>;</span><br /><span class="line"> <span class="number">10</span>:     <span class="comment">// 校验接口名非空</span></span><br /><span class="line"> <span class="number">11</span>:     <span class="keyword">if</span> (interfaceName == <span class="keyword">null</span> || interfaceName.length() == <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">12</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"&lt;dubbo:service interface=\"\" /&gt; interface not allow null!"</span>);</span><br /><span class="line"> <span class="number">13</span>:     }</span><br /><span class="line"> <span class="number">14</span>:     <span class="comment">// 拼接属性配置（环境变量 + properties 属性）到 ProviderConfig 对象</span></span><br /><span class="line"> <span class="number">15</span>:     checkDefault();</span><br /><span class="line"> <span class="number">16</span>:     <span class="comment">// 从 ProviderConfig 对象中，读取 application、module、registries、monitor、protocols 配置对象。</span></span><br /><span class="line"> <span class="number">17</span>:     <span class="keyword">if</span> (provider != <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">18</span>:         <span class="keyword">if</span> (application == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">19</span>:             application = provider.getApplication();</span><br /><span class="line"> <span class="number">20</span>:         }</span><br /><span class="line"> <span class="number">21</span>:         <span class="keyword">if</span> (<span class="keyword">module</span> == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">22</span>:             <span class="keyword">module</span> = provider.getModule();</span><br /><span class="line"> <span class="number">23</span>:         }</span><br /><span class="line"> <span class="number">24</span>:         <span class="keyword">if</span> (registries == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">25</span>:             registries = provider.getRegistries();</span><br /><span class="line"> <span class="number">26</span>:         }</span><br /><span class="line"> <span class="number">27</span>:         <span class="keyword">if</span> (monitor == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">28</span>:             monitor = provider.getMonitor();</span><br /><span class="line"> <span class="number">29</span>:         }</span><br /><span class="line"> <span class="number">30</span>:         <span class="keyword">if</span> (protocols == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">31</span>:             protocols = provider.getProtocols();</span><br /><span class="line"> <span class="number">32</span>:         }</span><br /><span class="line"> <span class="number">33</span>:     }</span><br /><span class="line"> <span class="number">34</span>:     <span class="comment">// 从 ModuleConfig 对象中，读取 registries、monitor 配置对象。</span></span><br /><span class="line"> <span class="number">35</span>:     <span class="keyword">if</span> (<span class="keyword">module</span> != <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">36</span>:         <span class="keyword">if</span> (registries == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">37</span>:             registries = <span class="keyword">module</span>.getRegistries();</span><br /><span class="line"> <span class="number">38</span>:         }</span><br /><span class="line"> <span class="number">39</span>:         <span class="keyword">if</span> (monitor == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">40</span>:             monitor = <span class="keyword">module</span>.getMonitor();</span><br /><span class="line"> <span class="number">41</span>:         }</span><br /><span class="line"> <span class="number">42</span>:     }</span><br /><span class="line"> <span class="number">43</span>:     <span class="comment">// 从 ApplicationConfig 对象中，读取 registries、monitor 配置对象。</span></span><br /><span class="line"> <span class="number">44</span>:     <span class="keyword">if</span> (application != <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">45</span>:         <span class="keyword">if</span> (registries == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">46</span>:             registries = application.getRegistries();</span><br /><span class="line"> <span class="number">47</span>:         }</span><br /><span class="line"> <span class="number">48</span>:         <span class="keyword">if</span> (monitor == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">49</span>:             monitor = application.getMonitor();</span><br /><span class="line"> <span class="number">50</span>:         }</span><br /><span class="line"> <span class="number">51</span>:     }</span><br /><span class="line"> <span class="number">52</span>:     <span class="comment">// 泛化接口的实现</span></span><br /><span class="line"> <span class="number">53</span>:     <span class="keyword">if</span> (ref <span class="keyword">instanceof</span> GenericService) {</span><br /><span class="line"> <span class="number">54</span>:         interfaceClass = GenericService.class;</span><br /><span class="line"> <span class="number">55</span>:         <span class="keyword">if</span> (StringUtils.isEmpty(generic)) {</span><br /><span class="line"> <span class="number">56</span>:             generic = Boolean.TRUE.toString();</span><br /><span class="line"> <span class="number">57</span>:         }</span><br /><span class="line"> <span class="number">58</span>:     <span class="comment">// 普通接口的实现</span></span><br /><span class="line"> <span class="number">59</span>:     } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">60</span>:         <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">61</span>:             interfaceClass = Class.forName(interfaceName, <span class="keyword">true</span>, Thread.currentThread().getContextClassLoader());</span><br /><span class="line"> <span class="number">62</span>:         } <span class="keyword">catch</span> (ClassNotFoundException e) {</span><br /><span class="line"> <span class="number">63</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e.getMessage(), e);</span><br /><span class="line"> <span class="number">64</span>:         }</span><br /><span class="line"> <span class="number">65</span>:         <span class="comment">// 校验接口和方法</span></span><br /><span class="line"> <span class="number">66</span>:         checkInterfaceAndMethods(interfaceClass, methods);</span><br /><span class="line"> <span class="number">67</span>:         <span class="comment">// 校验指向的 service 对象</span></span><br /><span class="line"> <span class="number">68</span>:         checkRef();</span><br /><span class="line"> <span class="number">69</span>:         generic = Boolean.FALSE.toString();</span><br /><span class="line"> <span class="number">70</span>:     }</span><br /><span class="line"> <span class="number">71</span>:     <span class="comment">// 处理服务接口客户端本地代理( `local` )相关。实际目前已经废弃，使用 `stub` 属性，参见 `AbstractInterfaceConfig#setLocal` 方法。</span></span><br /><span class="line"> <span class="number">72</span>:     <span class="keyword">if</span> (local != <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">73</span>:         <span class="comment">// 设为 true，表示使用缺省代理类名，即：接口名 + Local 后缀</span></span><br /><span class="line"> <span class="number">74</span>:         <span class="keyword">if</span> (<span class="string">"true"</span>.equals(local)) {</span><br /><span class="line"> <span class="number">75</span>:             local = interfaceName + <span class="string">"Local"</span>;</span><br /><span class="line"> <span class="number">76</span>:         }</span><br /><span class="line"> <span class="number">77</span>:         Class&lt;?&gt; localClass;</span><br /><span class="line"> <span class="number">78</span>:         <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">79</span>:             localClass = ClassHelper.forNameWithThreadContextClassLoader(local);</span><br /><span class="line"> <span class="number">80</span>:         } <span class="keyword">catch</span> (ClassNotFoundException e) {</span><br /><span class="line"> <span class="number">81</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e.getMessage(), e);</span><br /><span class="line"> <span class="number">82</span>:         }</span><br /><span class="line"> <span class="number">83</span>:         <span class="keyword">if</span> (!interfaceClass.isAssignableFrom(localClass)) {</span><br /><span class="line"> <span class="number">84</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The local implementation class "</span> + localClass.getName() + <span class="string">" not implement interface "</span> + interfaceName);</span><br /><span class="line"> <span class="number">85</span>:         }</span><br /><span class="line"> <span class="number">86</span>:     }</span><br /><span class="line"> <span class="number">87</span>:     <span class="comment">// 处理服务接口客户端本地代理( `stub` )相关</span></span><br /><span class="line"> <span class="number">88</span>:     <span class="keyword">if</span> (stub != <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">89</span>:         <span class="comment">// 设为 true，表示使用缺省代理类名，即：接口名 + Stub 后缀</span></span><br /><span class="line"> <span class="number">90</span>:         <span class="keyword">if</span> (<span class="string">"true"</span>.equals(stub)) {</span><br /><span class="line"> <span class="number">91</span>:             stub = interfaceName + <span class="string">"Stub"</span>;</span><br /><span class="line"> <span class="number">92</span>:         }</span><br /><span class="line"> <span class="number">93</span>:         Class&lt;?&gt; stubClass;</span><br /><span class="line"> <span class="number">94</span>:         <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">95</span>:             stubClass = ClassHelper.forNameWithThreadContextClassLoader(stub);</span><br /><span class="line"> <span class="number">96</span>:         } <span class="keyword">catch</span> (ClassNotFoundException e) {</span><br /><span class="line"> <span class="number">97</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e.getMessage(), e);</span><br /><span class="line"> <span class="number">98</span>:         }</span><br /><span class="line"> <span class="number">99</span>:         <span class="keyword">if</span> (!interfaceClass.isAssignableFrom(stubClass)) {</span><br /><span class="line"><span class="number">100</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The stub implementation class "</span> + stubClass.getName() + <span class="string">" not implement interface "</span> + interfaceName);</span><br /><span class="line"><span class="number">101</span>:         }</span><br /><span class="line"><span class="number">102</span>:     }</span><br /><span class="line"><span class="number">103</span>:     <span class="comment">// 校验 ApplicationConfig 配置。</span></span><br /><span class="line"><span class="number">104</span>:     checkApplication();</span><br /><span class="line"><span class="number">105</span>:     <span class="comment">// 校验 RegistryConfig 配置。</span></span><br /><span class="line"><span class="number">106</span>:     checkRegistry();</span><br /><span class="line"><span class="number">107</span>:     <span class="comment">// 校验 ProtocolConfig 配置数组。</span></span><br /><span class="line"><span class="number">108</span>:     checkProtocol();</span><br /><span class="line"><span class="number">109</span>:     <span class="comment">// 读取环境变量和 properties 配置到 ServiceConfig 对象。</span></span><br /><span class="line"><span class="number">110</span>:     appendProperties(<span class="keyword">this</span>);</span><br /><span class="line"><span class="number">111</span>:     <span class="comment">// 校验 Stub 和 Mock 相关的配置</span></span><br /><span class="line"><span class="number">112</span>:     checkStubAndMock(interfaceClass);</span><br /><span class="line"><span class="number">113</span>:     <span class="comment">// 服务路径，缺省为接口名</span></span><br /><span class="line"><span class="number">114</span>:     <span class="keyword">if</span> (path == <span class="keyword">null</span> || path.length() == <span class="number">0</span>) {</span><br /><span class="line"><span class="number">115</span>:         path = interfaceName;</span><br /><span class="line"><span class="number">116</span>:     }</span><br /><span class="line"><span class="number">117</span>:     <span class="comment">// 暴露服务</span></span><br /><span class="line"><span class="number">118</span>:     doExportUrls();</span><br /><span class="line"><span class="number">119</span>:     <span class="comment">// TODO 芋艿，等待 qos</span></span><br /><span class="line"><span class="number">120</span>:     ProviderModel providerModel = <span class="keyword">new</span> ProviderModel(getUniqueServiceName(), <span class="keyword">this</span>, ref);</span><br /><span class="line"><span class="number">121</span>:     ApplicationModel.initProviderModel(getUniqueServiceName(), providerModel);</span><br /><span class="line"><span class="number">122</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>第 2 至 9 行：检查是否可以暴露。若可以，标记已经暴露(&nbsp;<code>exported = true</code>&nbsp;)。</li>
<li>第 10 至 13 行：校验接口名&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L111" target="_blank" rel="external nofollow noopener noreferrer"><code>interfaceName</code></a>&nbsp;非空。</li>
<li>第 15 行：调用&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L791-L800" target="_blank" rel="external nofollow noopener noreferrer"><code>#checkDefault()</code></a>&nbsp;方法，读取<strong>属性配置</strong>( 环境变量 + properties 属性 )到 ProviderConfig 对象。
<ul>
<li>关于&ldquo;<strong>属性配置</strong>&rdquo; ，在&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-properties/?self">《精尽 Dubbo 源码解析 &mdash;&mdash; 属性配置》</a>&nbsp;详细解析。</li>
<li>🙂 直接点击方法查看，较为简单，已经添加详细注释。</li>
</ul>
</li>
<li>第 16 至 33 行：从 ProviderConfig 对象中，读取&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L102" target="_blank" rel="external nofollow noopener noreferrer"><code>application</code></a>、<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L105" target="_blank" rel="external nofollow noopener noreferrer"><code>module</code></a>、<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L108" target="_blank" rel="external nofollow noopener noreferrer"><code>registries</code></a>、<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L77" target="_blank" rel="external nofollow noopener noreferrer"><code>monitor</code></a>、<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractServiceConfig.java#L64" target="_blank" rel="external nofollow noopener noreferrer"><code>protocols</code></a>&nbsp;对象。</li>
<li>第 34 至 42 行：从 ModuleConfig 对象中，读取&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L108" target="_blank" rel="external nofollow noopener noreferrer"><code>registries</code></a>、<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L77" target="_blank" rel="external nofollow noopener noreferrer"><code>monitor</code></a>&nbsp;对象。</li>
<li>第 43 至 51 行：从 ApplicationConfig 对象中，读取&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L108" target="_blank" rel="external nofollow noopener noreferrer"><code>registries</code></a>、<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L77" target="_blank" rel="external nofollow noopener noreferrer"><code>monitor</code></a>&nbsp;对象。</li>
<li>第 52 至 57 行：泛化接口的实现。
<ul>
<li><a href="http://dubbo.apache.org/zh-cn/docs/user/demos/generic-service.html" target="_blank" rel="external nofollow noopener noreferrer">《Dubbo 用户指南 &mdash;&mdash; 泛化接口》</a></li>
</ul>
</li>
<li>第 58 至 70 行：普通接口的实现。
<ul>
<li>第 60 至 64 行：根据&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L105" target="_blank" rel="external nofollow noopener noreferrer"><code>interfaceName</code></a>&nbsp;，获得对应的<strong>接口类</strong>，并赋值给&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L111" target="_blank" rel="external nofollow noopener noreferrer"><code>interfaceClass</code></a>。</li>
<li>第 66 行：调用&nbsp;<code>#checkInterfaceAndMethods(interfaceClass, methods)</code>&nbsp;方法，检查接口和方法。
<ul>
<li>🙂 本文有已经有这个方法的解析。</li>
</ul>
</li>
<li>第 68 行：调用&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L393-L408" target="_blank" rel="external nofollow noopener noreferrer"><code>#checkRef()</code></a>&nbsp;方法，校验指向的 Service 对象。</li>
<li>第 69 行：标记&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L138" target="_blank" rel="external nofollow noopener noreferrer"><code>generic</code></a>&nbsp;为<strong>非</strong>泛化实现。</li>
</ul>
</li>
<li>第 71 至 86 行：处理服务接口客户端本地代理(&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L55-L63" target="_blank" rel="external nofollow noopener noreferrer"><code>local</code></a>&nbsp;)相关。<strong>实际目前已经废弃，此处主要用于兼容</strong>，使用&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L64-L74" target="_blank" rel="external nofollow noopener noreferrer"><code>stub</code></a>属性，参见&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L379-L390" target="_blank" rel="external nofollow noopener noreferrer"><code>AbstractInterfaceConfig#setLocal(local)</code></a>&nbsp;方法的<strong>注释说明</strong>。</li>
<li>第 87 至 102 行：处理服务接口客户端本地代理(&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L64-L74" target="_blank" rel="external nofollow noopener noreferrer"><code>stub</code></a>&nbsp;属性，参见&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L379-L390" target="_blank" rel="external nofollow noopener noreferrer"><code>AbstractInterfaceConfig#setLocal(local)</code></a>&nbsp;)相关。</li>
<li>第 104 行：调用&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L156-L187" target="_blank" rel="external nofollow noopener noreferrer"><code>#checkApplication()</code></a>&nbsp;方法，校验 ApplicationConfig 配置。
<ul>
<li>🙂 直接点击方法查看，较为简单，已经添加详细注释。</li>
</ul>
</li>
<li>第 106 行：调用&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L122-L154" target="_blank" rel="external nofollow noopener noreferrer"><code>#checkRegistry()</code></a>&nbsp;方法，校验 RegistryConfig 配置。
<ul>
<li>🙂 直接点击方法查看，较为简单，已经添加详细注释。</li>
</ul>
</li>
<li>第 108 行：调用&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L802-L823" target="_blank" rel="external nofollow noopener noreferrer"><code>#checkProtocol()</code></a>&nbsp;方法，校验 ProtocolConfig 配置数组。
<ul>
<li>🙂 直接点击方法查看，较为简单，已经添加详细注释。</li>
</ul>
</li>
<li>第 110 行：调用&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractConfig.java#L132-L212" target="_blank" rel="external nofollow noopener noreferrer"><code>#appendProperties(config)</code></a>&nbsp;方法，读取<strong>属性配置</strong>( 环境变量 + properties 属性 )到 ServiceConfig 对象（<strong>自己</strong>）。</li>
<li>第 112 行：调用&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L319-L368" target="_blank" rel="external nofollow noopener noreferrer"><code>#checkStubAndMock(interfaceClass)</code></a>&nbsp;方法，校验 Stub 和 Mock 相关的配置。</li>
<li>第 113 至 116 行：服务路径&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L115" target="_blank" rel="external nofollow noopener noreferrer"><code>path</code></a>&nbsp;为空时，缺省为接口名。</li>
<li>第 118 行：调用&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L430-L439" target="_blank" rel="external nofollow noopener noreferrer"><code>#doExportUrls()</code></a>&nbsp;方法，<strong>暴露服务</strong>。此方法包含了我们上述的&nbsp;<strong>3+4</strong>&nbsp;部分。</li>
<li>第 119 至 121 行：// TODO 芋艿，等待 qos</li>
</ul>
<hr />
<p>因为本文不分享&nbsp;<strong>4</strong>&nbsp;部分，所以下面我们只看&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L430-L439" target="_blank" rel="external nofollow noopener noreferrer"><code>#doExportUrls()</code></a>&nbsp;方法中，调用&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L441-L621" target="_blank" rel="external nofollow noopener noreferrer"><code>#doExportUrlsFor1Protocol(protocolConfig, registryURLs)</code></a>&nbsp;方法，和&nbsp;<strong>3</strong>&nbsp;有关的部分。代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doExportUrlsFor1Protocol</span><span class="params">(ProtocolConfig protocolConfig, List&lt;URL&gt; registryURLs)</span> </span>{</span><br /><span class="line">  <span class="number">2</span>:     <span class="comment">// 协议名</span></span><br /><span class="line">  <span class="number">3</span>:     String name = protocolConfig.getName();</span><br /><span class="line">  <span class="number">4</span>:     <span class="keyword">if</span> (name == <span class="keyword">null</span> || name.length() == <span class="number">0</span>) {</span><br /><span class="line">  <span class="number">5</span>:         name = <span class="string">"dubbo"</span>;</span><br /><span class="line">  <span class="number">6</span>:     }</span><br /><span class="line">  <span class="number">7</span>: </span><br /><span class="line">  <span class="number">8</span>:     <span class="comment">// 将 `side`，`dubbo`，`timestamp`，`pid` 参数，添加到 `map` 集合中。</span></span><br /><span class="line">  <span class="number">9</span>:     Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br /><span class="line"> <span class="number">10</span>:     map.put(Constants.SIDE_KEY, Constants.PROVIDER_SIDE);</span><br /><span class="line"> <span class="number">11</span>:     map.put(Constants.DUBBO_VERSION_KEY, Version.getVersion());</span><br /><span class="line"> <span class="number">12</span>:     map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));</span><br /><span class="line"> <span class="number">13</span>:     <span class="keyword">if</span> (ConfigUtils.getPid() &gt; <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">14</span>:         map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid()));</span><br /><span class="line"> <span class="number">15</span>:     }</span><br /><span class="line"> <span class="number">16</span>:     <span class="comment">// 将各种配置对象，添加到 `map` 集合中。</span></span><br /><span class="line"> <span class="number">17</span>:     appendParameters(map, application);</span><br /><span class="line"> <span class="number">18</span>:     appendParameters(map, <span class="keyword">module</span>);</span><br /><span class="line"> <span class="number">19</span>:     appendParameters(map, provider, Constants.DEFAULT_KEY); <span class="comment">// ProviderConfig ，为 ServiceConfig 的默认属性，因此添加 `default` 属性前缀。</span></span><br /><span class="line"> <span class="number">20</span>:     appendParameters(map, protocolConfig);</span><br /><span class="line"> <span class="number">21</span>:     appendParameters(map, <span class="keyword">this</span>);</span><br /><span class="line"> <span class="number">22</span>:     <span class="comment">// 将 MethodConfig 对象数组，添加到 `map` 集合中。</span></span><br /><span class="line"> <span class="number">23</span>:     <span class="keyword">if</span> (methods != <span class="keyword">null</span> &amp;&amp; !methods.isEmpty()) {</span><br /><span class="line"> <span class="number">24</span>:         <span class="keyword">for</span> (MethodConfig method : methods) {</span><br /><span class="line"> <span class="number">25</span>:             <span class="comment">// 将 MethodConfig 对象，添加到 `map` 集合中。</span></span><br /><span class="line"> <span class="number">26</span>:             appendParameters(map, method, method.getName());</span><br /><span class="line"> <span class="number">27</span>:             <span class="comment">// 当 配置了 `MethodConfig.retry = false` 时，强制禁用重试</span></span><br /><span class="line"> <span class="number">28</span>:             String retryKey = method.getName() + <span class="string">".retry"</span>;</span><br /><span class="line"> <span class="number">29</span>:             <span class="keyword">if</span> (map.containsKey(retryKey)) {</span><br /><span class="line"> <span class="number">30</span>:                 String retryValue = map.remove(retryKey);</span><br /><span class="line"> <span class="number">31</span>:                 <span class="keyword">if</span> (<span class="string">"false"</span>.equals(retryValue)) {</span><br /><span class="line"> <span class="number">32</span>:                     map.put(method.getName() + <span class="string">".retries"</span>, <span class="string">"0"</span>);</span><br /><span class="line"> <span class="number">33</span>:                 }</span><br /><span class="line"> <span class="number">34</span>:             }</span><br /><span class="line"> <span class="number">35</span>:             <span class="comment">// 将 ArgumentConfig 对象数组，添加到 `map` 集合中。</span></span><br /><span class="line"> <span class="number">36</span>:             List&lt;ArgumentConfig&gt; arguments = method.getArguments();</span><br /><span class="line"> <span class="number">37</span>:             <span class="keyword">if</span> (arguments != <span class="keyword">null</span> &amp;&amp; !arguments.isEmpty()) {</span><br /><span class="line"> <span class="number">38</span>:                 <span class="keyword">for</span> (ArgumentConfig argument : arguments) {</span><br /><span class="line"> <span class="number">39</span>:                     <span class="comment">// convert argument type</span></span><br /><span class="line"> <span class="number">40</span>:                     <span class="keyword">if</span> (argument.getType() != <span class="keyword">null</span> &amp;&amp; argument.getType().length() &gt; <span class="number">0</span>) { <span class="comment">// 指定了类型</span></span><br /><span class="line"> <span class="number">41</span>:                         Method[] methods = interfaceClass.getMethods();</span><br /><span class="line"> <span class="number">42</span>:                         <span class="comment">// visit all methods</span></span><br /><span class="line"> <span class="number">43</span>:                         <span class="keyword">if</span> (methods != <span class="keyword">null</span> &amp;&amp; methods.length &gt; <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">44</span>:                             <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; methods.length; i++) {</span><br /><span class="line"> <span class="number">45</span>:                                 String methodName = methods[i].getName();</span><br /><span class="line"> <span class="number">46</span>:                                 <span class="comment">// target the method, and get its signature</span></span><br /><span class="line"> <span class="number">47</span>:                                 <span class="keyword">if</span> (methodName.equals(method.getName())) { <span class="comment">// 找到指定方法</span></span><br /><span class="line"> <span class="number">48</span>:                                     Class&lt;?&gt;[] argTypes = methods[i].getParameterTypes();</span><br /><span class="line"> <span class="number">49</span>:                                     <span class="comment">// one callback in the method</span></span><br /><span class="line"> <span class="number">50</span>:                                     <span class="keyword">if</span> (argument.getIndex() != -<span class="number">1</span>) { <span class="comment">// 指定单个参数的位置 + 类型</span></span><br /><span class="line"> <span class="number">51</span>:                                         <span class="keyword">if</span> (argTypes[argument.getIndex()].getName().equals(argument.getType())) {</span><br /><span class="line"> <span class="number">52</span>:                                             <span class="comment">// 将 ArgumentConfig 对象，添加到 `map` 集合中。</span></span><br /><span class="line"> <span class="number">53</span>:                                             appendParameters(map, argument, method.getName() + <span class="string">"."</span> + argument.getIndex()); <span class="comment">// `${methodName}.${index}`</span></span><br /><span class="line"> <span class="number">54</span>:                                         } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">55</span>:                                             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"argument config error : the index attribute and type attribute not match :index :"</span> + argument.getIndex() + <span class="string">", type:"</span> + argument.getType());</span><br /><span class="line"> <span class="number">56</span>:                                         }</span><br /><span class="line"> <span class="number">57</span>:                                     } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">58</span>:                                         <span class="comment">// multiple callbacks in the method</span></span><br /><span class="line"> <span class="number">59</span>:                                         <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; argTypes.length; j++) {</span><br /><span class="line"> <span class="number">60</span>:                                             Class&lt;?&gt; argClazz = argTypes[j];</span><br /><span class="line"> <span class="number">61</span>:                                             <span class="keyword">if</span> (argClazz.getName().equals(argument.getType())) {</span><br /><span class="line"> <span class="number">62</span>:                                                 <span class="comment">// 将 ArgumentConfig 对象，添加到 `map` 集合中。</span></span><br /><span class="line"> <span class="number">63</span>:                                                 appendParameters(map, argument, method.getName() + <span class="string">"."</span> + j); <span class="comment">// `${methodName}.${index}`</span></span><br /><span class="line"> <span class="number">64</span>:                                                 <span class="keyword">if</span> (argument.getIndex() != -<span class="number">1</span> &amp;&amp; argument.getIndex() != j) { <span class="comment">// 多余的判断，因为 `argument.getIndex() == -1` 。</span></span><br /><span class="line"> <span class="number">65</span>:                                                     <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"argument config error : the index attribute and type attribute not match :index :"</span> + argument.getIndex() + <span class="string">", type:"</span> + argument.getType());</span><br /><span class="line"> <span class="number">66</span>:                                                 }</span><br /><span class="line"> <span class="number">67</span>:                                             }</span><br /><span class="line"> <span class="number">68</span>:                                         }</span><br /><span class="line"> <span class="number">69</span>:                                     }</span><br /><span class="line"> <span class="number">70</span>:                                 }</span><br /><span class="line"> <span class="number">71</span>:                             }</span><br /><span class="line"> <span class="number">72</span>:                         }</span><br /><span class="line"> <span class="number">73</span>:                     } <span class="keyword">else</span> <span class="keyword">if</span> (argument.getIndex() != -<span class="number">1</span>) { <span class="comment">// 指定单个参数的位置</span></span><br /><span class="line"> <span class="number">74</span>:                         <span class="comment">// 将 ArgumentConfig 对象，添加到 `map` 集合中。</span></span><br /><span class="line"> <span class="number">75</span>:                         appendParameters(map, argument, method.getName() + <span class="string">"."</span> + argument.getIndex()); <span class="comment">// `${methodName}.${index}`</span></span><br /><span class="line"> <span class="number">76</span>:                     } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">77</span>:                         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"argument config must set index or type attribute.eg: &lt;dubbo:argument index='0' .../&gt; or &lt;dubbo:argument type=xxx .../&gt;"</span>);</span><br /><span class="line"> <span class="number">78</span>:                     }</span><br /><span class="line"> <span class="number">79</span>: </span><br /><span class="line"> <span class="number">80</span>:                 }</span><br /><span class="line"> <span class="number">81</span>:             }</span><br /><span class="line"> <span class="number">82</span>:         } <span class="comment">// end of methods for</span></span><br /><span class="line"> <span class="number">83</span>:     }</span><br /><span class="line"> <span class="number">84</span>: </span><br /><span class="line"> <span class="number">85</span>:     <span class="comment">// generic、methods、revision</span></span><br /><span class="line"> <span class="number">86</span>:     <span class="keyword">if</span> (ProtocolUtils.isGeneric(generic)) {</span><br /><span class="line"> <span class="number">87</span>:         map.put(<span class="string">"generic"</span>, generic);</span><br /><span class="line"> <span class="number">88</span>:         map.put(<span class="string">"methods"</span>, Constants.ANY_VALUE);</span><br /><span class="line"> <span class="number">89</span>:     } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">90</span>:         String revision = Version.getVersion(interfaceClass, version);</span><br /><span class="line"> <span class="number">91</span>:         <span class="keyword">if</span> (revision != <span class="keyword">null</span> &amp;&amp; revision.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">92</span>:             map.put(<span class="string">"revision"</span>, revision); <span class="comment">// 修订号</span></span><br /><span class="line"> <span class="number">93</span>:         }</span><br /><span class="line"> <span class="number">94</span>: </span><br /><span class="line"> <span class="number">95</span>:         String[] methods = Wrapper.getWrapper(interfaceClass).getMethodNames(); <span class="comment">// 获得方法数组</span></span><br /><span class="line"> <span class="number">96</span>:         <span class="keyword">if</span> (methods.length == <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">97</span>:             logger.warn(<span class="string">"NO method found in service interface "</span> + interfaceClass.getName());</span><br /><span class="line"> <span class="number">98</span>:             map.put(<span class="string">"methods"</span>, Constants.ANY_VALUE);</span><br /><span class="line"> <span class="number">99</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">100</span>:             map.put(<span class="string">"methods"</span>, StringUtils.join(<span class="keyword">new</span> HashSet&lt;String&gt;(Arrays.asList(methods)), <span class="string">","</span>));</span><br /><span class="line"><span class="number">101</span>:         }</span><br /><span class="line"><span class="number">102</span>:     }</span><br /><span class="line"><span class="number">103</span>:     <span class="comment">// token ，参见《令牌校验》http://dubbo.apache.org/zh-cn/docs/user/demos/token-authorization.html</span></span><br /><span class="line"><span class="number">104</span>:     <span class="keyword">if</span> (!ConfigUtils.isEmpty(token)) {</span><br /><span class="line"><span class="number">105</span>:         <span class="keyword">if</span> (ConfigUtils.isDefault(token)) {</span><br /><span class="line"><span class="number">106</span>:             map.put(<span class="string">"token"</span>, UUID.randomUUID().toString());</span><br /><span class="line"><span class="number">107</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">108</span>:             map.put(<span class="string">"token"</span>, token);</span><br /><span class="line"><span class="number">109</span>:         }</span><br /><span class="line"><span class="number">110</span>:     }</span><br /><span class="line"><span class="number">111</span>:     <span class="comment">// 协议为 injvm 时，不注册，不通知。</span></span><br /><span class="line"><span class="number">112</span>:     <span class="keyword">if</span> (<span class="string">"injvm"</span>.equals(protocolConfig.getName())) {</span><br /><span class="line"><span class="number">113</span>:         protocolConfig.setRegister(<span class="keyword">false</span>);</span><br /><span class="line"><span class="number">114</span>:         map.put(<span class="string">"notify"</span>, <span class="string">"false"</span>);</span><br /><span class="line"><span class="number">115</span>:     }</span><br /><span class="line"><span class="number">116</span>:     <span class="comment">// export service</span></span><br /><span class="line"><span class="number">117</span>:     String contextPath = protocolConfig.getContextpath();</span><br /><span class="line"><span class="number">118</span>:     <span class="keyword">if</span> ((contextPath == <span class="keyword">null</span> || contextPath.length() == <span class="number">0</span>) &amp;&amp; provider != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">119</span>:         contextPath = provider.getContextpath();</span><br /><span class="line"><span class="number">120</span>:     }</span><br /><span class="line"><span class="number">121</span>: </span><br /><span class="line"><span class="number">122</span>:     <span class="comment">// host、port</span></span><br /><span class="line"><span class="number">123</span>:     String host = <span class="keyword">this</span>.findConfigedHosts(protocolConfig, registryURLs, map);</span><br /><span class="line"><span class="number">124</span>:     Integer port = <span class="keyword">this</span>.findConfigedPorts(protocolConfig, name, map);</span><br /><span class="line"><span class="number">125</span>: </span><br /><span class="line"><span class="number">126</span>:     <span class="comment">// 创建 Dubbo URL 对象</span></span><br /><span class="line"><span class="number">127</span>:     URL url = <span class="keyword">new</span> URL(name, host, port, (contextPath == <span class="keyword">null</span> || contextPath.length() == <span class="number">0</span> ? <span class="string">""</span> : contextPath + <span class="string">"/"</span>) + path, map);</span><br /><span class="line"><span class="number">128</span>: </span><br /><span class="line"><span class="number">129</span>:     <span class="comment">// 配置规则，参见《配置规则》http://dubbo.apache.org/zh-cn/docs/user/demos/config-rule.html</span></span><br /><span class="line"><span class="number">130</span>:     <span class="keyword">if</span> (ExtensionLoader.getExtensionLoader(ConfiguratorFactory.class)</span><br /><span class="line"><span class="number">131</span>:             .hasExtension(url.getProtocol())) {</span><br /><span class="line"><span class="number">132</span>:         url = ExtensionLoader.getExtensionLoader(ConfiguratorFactory.class)</span><br /><span class="line"><span class="number">133</span>:                 .getExtension(url.getProtocol()).getConfigurator(url).configure(url);</span><br /><span class="line"><span class="number">134</span>:     }</span><br /><span class="line"><span class="number">135</span>: </span><br /><span class="line"><span class="number">136</span>:     <span class="comment">// 省略【服务暴露】逻辑</span></span><br /><span class="line"><span class="number">137</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>第 2 至 6 行：协议名空时，缺省&nbsp;<code>"dubbo"</code>&nbsp;。</li>
<li>第 9 行：创建参数集合&nbsp;<code>map</code>&nbsp;，用于下面创建 Dubbo URL 的&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-common/src/main/java/com/alibaba/dubbo/common/URL.java#L109" target="_blank" rel="external nofollow noopener noreferrer"><code>parameters</code></a>&nbsp;属性。</li>
<li>第 10 至 15 行：将&nbsp;<code>side</code>&nbsp;<code>dubbo</code>&nbsp;<code>timestamp</code>&nbsp;<code>timestamp</code>&nbsp;<code>pid</code>&nbsp;添加到&nbsp;<code>map</code>&nbsp;中。</li>
<li>第 16 至 21 行：调用&nbsp;<code>#appendParameters(map, config)</code>&nbsp;方法，将各种配置对象添加到&nbsp;<code>map</code>&nbsp;中。
<ul>
<li>🙂&nbsp;<code>#appendParameters(map, config)</code>&nbsp;方法，在&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-api-1/?self">《API 配置（一）之应用》</a></li>
</ul>
</li>
<li>第 22 至 83 行：调用 MethodConfig 对象<strong>数组</strong>，添加到&nbsp;<code>map</code>&nbsp;中。
<ul>
<li>目的是将<strong>每个</strong>&nbsp;MethodConfig 和其对应的 ArgumentConfig 对象数组，添加到&nbsp;<code>map</code>&nbsp;中。</li>
<li>🙂 代码比较冗长，胖友耐心看注释，建议进行调试每种情况。</li>
</ul>
</li>
<li>第 85 至 102 行：将&nbsp;<code>generic</code>&nbsp;<code>methods</code>&nbsp;<code>revision</code>&nbsp;到&nbsp;<code>map</code>&nbsp;中。
<ul>
<li><code>revision</code>&nbsp;，可能比较难理解，在&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-api-2/">「10. Version」</a>&nbsp;详细解析。</li>
</ul>
</li>
<li>第 103 至 110 行：将&nbsp;<code>token</code>&nbsp;添加到&nbsp;<code>map</code>&nbsp;中。
<ul>
<li><a href="http://dubbo.apache.org/zh-cn/docs/user/demos/token-authorization.html" target="_blank" rel="external nofollow noopener noreferrer">《Dubbo 用户指南 &mdash;&mdash; 令牌验证》</a></li>
</ul>
</li>
<li>第 111 至 115 行：当协议为&nbsp;<code>injvm</code>&nbsp;时，添加&nbsp;<code>notify = false</code>&nbsp;到&nbsp;<code>map</code>&nbsp;中，表示不注册，不通知。
<ul>
<li><a href="http://dubbo.apache.org/zh-cn/docs/user/demos/local-call.html" target="_blank" rel="external nofollow noopener noreferrer">《Dubbo 用户指南 &mdash;&mdash; 本地调用》</a></li>
</ul>
</li>
<li>第 116 至 120 行：获得&nbsp;<code>contextPath</code>&nbsp;，基础路径，即java web应用中常说的context path 。</li>
<li>第 123 行：调用&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/d3c3975f320c78452f96098b04441fed4c00ab70/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L661-L744" target="_blank" rel="external nofollow noopener noreferrer"><code>#this.findConfigedHosts(protocolConfig, registryURLs, map)</code></a>&nbsp;方法，获得注册到注册中心的服务提供者 Host 。
<ul>
<li><a href="http://dubbo.apache.org/zh-cn/docs/user/demos/hostname-binding.html" target="_blank" rel="external nofollow noopener noreferrer">《Dubbo 用户指南 &mdash;&mdash; 主机绑定》</a></li>
<li><a href="https://segmentfault.com/a/1190000010550512" target="_blank" rel="external nofollow noopener noreferrer">《dubbo注册服务IP解析异常及IP解析源码分析》</a></li>
<li>指定服务注册地址，参见&nbsp;<a href="https://github.com/dubbo/dubbo-docker-sample" target="_blank" rel="external nofollow noopener noreferrer">dubbo-docker-sample</a>&nbsp;示例项目。</li>
<li>🙂 代码比较冗长，胖友耐心看注释，建议进行调试每种情况。</li>
</ul>
</li>
<li>第 124 行：调用&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/d3c3975f320c78452f96098b04441fed4c00ab70/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L746-L800" target="_blank" rel="external nofollow noopener noreferrer"><code>#findConfigedHosts(protocolConfig, name, map)</code></a>&nbsp;方法，获得注册到注册中心的服务提供者 Port 。
<ul>
<li>🙂 代码比较冗长，胖友耐心看注释，建议进行调试每种情况。</li>
</ul>
</li>
<li>第 127 行：创建 Dubbo URL 。</li>
<li>第 129 至 134 行：配置规则，后续详细解析。
<ul>
<li><a href="http://dubbo.apache.org/zh-cn/docs/user/demos/config-rule.html" target="_blank" rel="external nofollow noopener noreferrer">《Dubbo 用户指南 &mdash;&mdash; 配置规则》</a></li>
</ul>
</li>
<li>第 136 行：<strong>省略</strong>【服务暴露】逻辑。</li>
</ul>
<h1 id="9-为什么继承？？？">9. 为什么继承？？？</h1>
<p>我们以 ServiceConfig 和 ProviderConfig 来举例子，两者都继承 AbstractServiceConfig。<br />从属性上，两者有相同的属性，例如&nbsp;<code>group</code>&nbsp;/&nbsp;<code>version</code>&nbsp;。<br />同时，也存在着一些差异，例如&nbsp;<code>ServiceConfig.interfaceName</code>&nbsp;/&nbsp;<code>ProviderConfig.host</code>&nbsp;。</p>
<p>另外，我们在看看 ServiceConfig 和 MethodConfig ，两者都继承 AbstractMethodConfig。<br />在 ServiceConfig 中，可以配置下属所有方法的&nbsp;<code>retries</code>&nbsp;次数，也可以在 MethodConfig 中<strong>自定义</strong><code>retries</code>&nbsp;次数。</p>
<p>通过继承，获得相同的属性。</p>
<h1 id="10-Version">10. Version</h1>
<p><a href="https://github.com/alibaba/dubbo/blob/0423219d839404186b8a5ec7dec37f6addeb58d9/dubbo-common/src/main/java/com/alibaba/dubbo/common/Version.java" target="_blank" rel="external nofollow noopener noreferrer"><code>Version#getVersion(cls, defaultVersion)</code></a>&nbsp;方法，获得版本号。代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getVersion</span><span class="params">(Class&lt;?&gt; cls, String defaultVersion)</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">3</span>:         <span class="comment">// find version info from MANIFEST.MF first</span></span><br /><span class="line"> <span class="number">4</span>:         String version = cls.getPackage().getImplementationVersion();</span><br /><span class="line"> <span class="number">5</span>:         <span class="keyword">if</span> (version == <span class="keyword">null</span> || version.length() == <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">6</span>:             version = cls.getPackage().getSpecificationVersion();</span><br /><span class="line"> <span class="number">7</span>:         }</span><br /><span class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (version == <span class="keyword">null</span> || version.length() == <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">9</span>:             <span class="comment">// guess version fro jar file name if nothing's found from MANIFEST.MF</span></span><br /><span class="line"><span class="number">10</span>:             CodeSource codeSource = cls.getProtectionDomain().getCodeSource();</span><br /><span class="line"><span class="number">11</span>:             <span class="keyword">if</span> (codeSource == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">12</span>:                 logger.info(<span class="string">"No codeSource for class "</span> + cls.getName() + <span class="string">" when getVersion, use default version "</span> + defaultVersion);</span><br /><span class="line"><span class="number">13</span>:             } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">14</span>:                 String file = codeSource.getLocation().getFile();</span><br /><span class="line"><span class="number">15</span>:                 <span class="keyword">if</span> (file != <span class="keyword">null</span> &amp;&amp; file.length() &gt; <span class="number">0</span> &amp;&amp; file.endsWith(<span class="string">".jar"</span>)) {</span><br /><span class="line"><span class="number">16</span>:                     file = file.substring(<span class="number">0</span>, file.length() - <span class="number">4</span>);</span><br /><span class="line"><span class="number">17</span>:                     <span class="keyword">int</span> i = file.lastIndexOf(<span class="string">'/'</span>);</span><br /><span class="line"><span class="number">18</span>:                     <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) {</span><br /><span class="line"><span class="number">19</span>:                         file = file.substring(i + <span class="number">1</span>);</span><br /><span class="line"><span class="number">20</span>:                     }</span><br /><span class="line"><span class="number">21</span>:                     i = file.indexOf(<span class="string">"-"</span>);</span><br /><span class="line"><span class="number">22</span>:                     <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) {</span><br /><span class="line"><span class="number">23</span>:                         file = file.substring(i + <span class="number">1</span>);</span><br /><span class="line"><span class="number">24</span>:                     }</span><br /><span class="line"><span class="number">25</span>:                     <span class="keyword">while</span> (file.length() &gt; <span class="number">0</span> &amp;&amp; !Character.isDigit(file.charAt(<span class="number">0</span>))) {</span><br /><span class="line"><span class="number">26</span>:                         i = file.indexOf(<span class="string">"-"</span>);</span><br /><span class="line"><span class="number">27</span>:                         <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) {</span><br /><span class="line"><span class="number">28</span>:                             file = file.substring(i + <span class="number">1</span>);</span><br /><span class="line"><span class="number">29</span>:                         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">30</span>:                             <span class="keyword">break</span>;</span><br /><span class="line"><span class="number">31</span>:                         }</span><br /><span class="line"><span class="number">32</span>:                     }</span><br /><span class="line"><span class="number">33</span>:                     version = file;</span><br /><span class="line"><span class="number">34</span>:                 }</span><br /><span class="line"><span class="number">35</span>:             }</span><br /><span class="line"><span class="number">36</span>:         }</span><br /><span class="line"><span class="number">37</span>:         <span class="comment">// return default version if no version info is found</span></span><br /><span class="line"><span class="number">38</span>:         <span class="keyword">return</span> version == <span class="keyword">null</span> || version.length() == <span class="number">0</span> ? defaultVersion : version;</span><br /><span class="line"><span class="number">39</span>:     } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">40</span>:         <span class="comment">// return default version when any exception is thrown</span></span><br /><span class="line"><span class="number">41</span>:         logger.error(<span class="string">"return default version, ignore exception "</span> + e.getMessage(), e);</span><br /><span class="line"><span class="number">42</span>:         <span class="keyword">return</span> defaultVersion;</span><br /><span class="line"><span class="number">43</span>:     }</span><br /><span class="line"><span class="number">44</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>第 3 至 7 行：从&nbsp;<code>MAINFEST.MF</code>&nbsp;中获得版本号。以&nbsp;<a href="http://central.maven.org/maven2/org/springframework/boot/spring-boot-starter/1.5.10.RELEASE/spring-boot-starter-1.5.10.RELEASE.jar" target="_blank" rel="external nofollow noopener noreferrer">spring-boot-starter-1.5.10.RELEASE.jar</a>&nbsp;举例子：<img src="http://static2.iocoder.cn/images/Dubbo/2018_01_10/01.png" alt="MAINFEST.MF" /></li>
<li>第 8 至 36 行：若获取不到，从 jar 包<strong>命名</strong>中<strong>可能</strong>带的版本号作为结果。例如上面的例子，<code>1.5.10.RELEASE</code>&nbsp;。</li>
<li>第 38 行：返回版本号。若不存在，返回默认版本号。</li>
</ul>
</div>