<header class="article-header">
<h1 class="article-title">NIO 服务器（七）之 Netty3 实现</h1>
</header>
<div class="article-entry">
<blockquote>
<p>本文基于 Dubbo 2.6.1 版本，望知悉。</p>
</blockquote>
<h1 id="1-概述">1. 概述</h1>
<p>本文接&nbsp;<a href="http://svip.iocoder.cn/Dubbo/remoting-impl-netty4/?self">《精尽 Dubbo 源码分析 &mdash;&mdash; NIO 服务器（六）之 Netty4 实现》</a>&nbsp;一文，分享在&nbsp;<code>dubbo-remoting-netty</code>&nbsp;中，Netty3 如何接入实现。</p>
<p>因为 Netty3 的接入代码，和 Netty4 基本是一致，主要是一些 Netty 不同版本的 API 差异，所以本文，会相对简介，只重点分享一些差异的地方。</p>
<p>涉及如下类：</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_12_19/01.png" alt="类图" /></p>
<blockquote>
<p>友情提示：在当前版本，默认情况下，使用 Netty3 ，如果想配置成 Netty4 ，请参考文档：<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/netty4.html" target="_blank" rel="external nofollow noopener noreferrer">《Dubbo 用户指南 &mdash;&mdash; Netty4》</a></p>
</blockquote>
<h1 id="2-NettyTransporter">2. NettyTransporter</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyTransporter.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.transport.netty.NettyTransporter</code></a>&nbsp;，和&nbsp;<code>dubbo-remoting-netty4</code>&nbsp;一致，省略。</p>
<h1 id="3-NettyChannel">3. NettyChannel</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyChannel.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.transport.netty.NettyChannel</code></a>&nbsp;，和&nbsp;<code>dubbo-remoting-netty4</code>&nbsp;一致，省略。</p>
<h1 id="4-NettyHandler">4. NettyHandler</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyHandler.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.transport.netty.NettyHandler</code></a>&nbsp;，实现&nbsp;<code>io.netty.channel.ChannelDuplexHandler</code>&nbsp;类，NettyServer 和 NettyClient 的处理器，<strong>统一使用</strong>。这一点，不同于&nbsp;<code>dubbo-remoting-netty4</code>&nbsp;，服务端和服务器使用不同的两个处理器。相比来说，<code>dubbo-remoting-netty4</code>&nbsp;控制更精细，影响不大。</p>
<p>当然也有一个原因，Dubbo ChannelHandler 基于&nbsp;<strong>Netty3 的 SimpleChannelHandler</strong>&nbsp;为设计原型。因此，在&nbsp;<code>dubbo-remoting-netty4</code>&nbsp;中，需要将 DubboHandler 的方法，适配到&nbsp;<strong>Netty4 的 ChannelDuplexHandler</strong>&nbsp;的方法。</p>
<blockquote>
<p>NettyHandler 和 HeaderExchangeHandler 类似。</p>
</blockquote>
<p><strong>构造方法</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Sharable</span></span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelHandler</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Dubbo Channel 集合</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Channel&gt; channels = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Channel&gt;(); <span class="comment">// &lt;ip:port, channel&gt;</span></span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * URL</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> URL url;</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Dubbo ChannelHandler</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChannelHandler handler;</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NettyHandler</span><span class="params">(URL url, ChannelHandler handler)</span> </span>{</span><br /><span class="line">        <span class="keyword">if</span> (url == <span class="keyword">null</span>) {</span><br /><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"url == null"</span>);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">if</span> (handler == <span class="keyword">null</span>) {</span><br /><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"handler == null"</span>);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">this</span>.url = url;</span><br /><span class="line">        <span class="keyword">this</span>.handler = handler;</span><br /><span class="line">    }</span><br />    <br /><span class="line">    <span class="comment">// ... 省略实现方法</span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p><strong>实现方法</strong></p>
<p>每个实现的方法，调用&nbsp;<code>handler</code>&nbsp;对应的方法。以&nbsp;<code>#channelActive(ChannelHandlerContext)</code>&nbsp;方法举例子，代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelConnected</span><span class="params">(ChannelHandlerContext ctx, ChannelStateEvent e)</span> <span class="keyword">throws</span> Exception </span>{</span><br /><span class="line">    <span class="comment">// 创建 NettyChannel 对象</span></span><br /><span class="line">    NettyChannel channel = NettyChannel.getOrAddChannel(ctx.getChannel(), url, handler);</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        <span class="comment">// 添加到 `channels` 中</span></span><br /><span class="line">        <span class="keyword">if</span> (channel != <span class="keyword">null</span>) {</span><br /><span class="line">            channels.put(NetUtils.toAddressString((InetSocketAddress) ctx.getChannel().getRemoteAddress()), channel);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// 提交给 `handler` 处理器。</span></span><br /><span class="line">        handler.connected(channel);</span><br /><span class="line">    } <span class="keyword">finally</span> {</span><br /><span class="line">        <span class="comment">// 移除 NettyChannel 对象，若已断开</span></span><br /><span class="line">        NettyChannel.removeChannelIfDisconnected(ctx.getChannel());</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>🙂 其他方法，胖友自己查看。</p>
<h1 id="5-NettyServer">5. NettyServer</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyServer.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.transport.netty.NettyServer</code></a>&nbsp;，实现 Server 接口，继承 AbstractServer 抽象类，Netty 服务器实现类。</p>
<p><strong>构造方法</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * 通道集合</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Map&lt;String, Channel&gt; channels; <span class="comment">// &lt;ip:port, channel&gt;</span></span><br /><br /><span class="line"><span class="keyword">private</span> ServerBootstrap bootstrap;</span><br /><br /><span class="line"><span class="keyword">private</span> org.jboss.netty.channel.Channel channel;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NettyServer</span><span class="params">(URL url, ChannelHandler handler)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">    <span class="keyword">super</span>(url, ChannelHandlers.wrap(handler, ExecutorUtil.setThreadName(url, SERVER_THREAD_POOL_NAME)));</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>和&nbsp;<code>dubbo-remoting-netty4</code>&nbsp;基本一致。</li>
</ul>
<p><strong>启动服务器</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doOpen</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// 设置日志工厂</span></span><br /><span class="line"> <span class="number">4</span>:     NettyHelper.setNettyLoggerFactory();</span><br /><span class="line"> <span class="number">5</span>: </span><br /><span class="line"> <span class="number">6</span>:     <span class="comment">// 创建线程池</span></span><br /><span class="line"> <span class="number">7</span>:     ExecutorService boss = Executors.newCachedThreadPool(<span class="keyword">new</span> NamedThreadFactory(<span class="string">"NettyServerBoss"</span>, <span class="keyword">true</span>));</span><br /><span class="line"> <span class="number">8</span>:     ExecutorService worker = Executors.newCachedThreadPool(<span class="keyword">new</span> NamedThreadFactory(<span class="string">"NettyServerWorker"</span>, <span class="keyword">true</span>));</span><br /><span class="line"> <span class="number">9</span>: </span><br /><span class="line"><span class="number">10</span>:     <span class="comment">// 创建 ChannelFactory 对象</span></span><br /><span class="line"><span class="number">11</span>:     ChannelFactory channelFactory = <span class="keyword">new</span> NioServerSocketChannelFactory(boss, worker, getUrl().getPositiveParameter(Constants.IO_THREADS_KEY, Constants.DEFAULT_IO_THREADS));</span><br /><span class="line"><span class="number">12</span>:     <span class="comment">// 实例化 ServerBootstrap</span></span><br /><span class="line"><span class="number">13</span>:     bootstrap = <span class="keyword">new</span> ServerBootstrap(channelFactory);</span><br /><span class="line"><span class="number">14</span>: </span><br /><span class="line"><span class="number">15</span>:     <span class="comment">// 创建 NettyHandler 对象</span></span><br /><span class="line"><span class="number">16</span>:     <span class="keyword">final</span> NettyHandler nettyHandler = <span class="keyword">new</span> NettyHandler(getUrl(), <span class="keyword">this</span>);</span><br /><span class="line"><span class="number">17</span>:     <span class="comment">// 设置 `channels` 属性</span></span><br /><span class="line"><span class="number">18</span>:     channels = nettyHandler.getChannels();</span><br /><span class="line"><span class="number">19</span>:     <span class="comment">// https://issues.jboss.org/browse/NETTY-365</span></span><br /><span class="line"><span class="number">20</span>:     <span class="comment">// https://issues.jboss.org/browse/NETTY-379</span></span><br /><span class="line"><span class="number">21</span>:     <span class="comment">// final Timer timer = new HashedWheelTimer(new NamedThreadFactory("NettyIdleTimer", true));</span></span><br /><span class="line"><span class="number">22</span>:     bootstrap.setPipelineFactory(<span class="keyword">new</span> ChannelPipelineFactory() {</span><br /><span class="line"><span class="number">23</span>:         <span class="meta">@Override</span></span><br /><span class="line"><span class="number">24</span>:         <span class="function"><span class="keyword">public</span> ChannelPipeline <span class="title">getPipeline</span><span class="params">()</span> </span>{</span><br /><span class="line"><span class="number">25</span>:             <span class="comment">// 创建 NettyCodecAdapter 对象</span></span><br /><span class="line"><span class="number">26</span>:             NettyCodecAdapter adapter = <span class="keyword">new</span> NettyCodecAdapter(getCodec(), getUrl(), NettyServer.<span class="keyword">this</span>);</span><br /><span class="line"><span class="number">27</span>:             ChannelPipeline pipeline = Channels.pipeline();</span><br /><span class="line"><span class="number">28</span>:             <span class="comment">/*int idleTimeout = getIdleTimeout();</span></span><br /><span class="line"><span class="comment">29:             if (idleTimeout &gt; 10000) {</span></span><br /><span class="line"><span class="comment">30:                 pipeline.addLast("timer", new IdleStateHandler(timer, idleTimeout / 1000, 0, 0));</span></span><br /><span class="line"><span class="comment">31:             }*/</span></span><br /><span class="line"><span class="number">32</span>:             pipeline.addLast(<span class="string">"decoder"</span>, adapter.getDecoder()); <span class="comment">// 解码</span></span><br /><span class="line"><span class="number">33</span>:             pipeline.addLast(<span class="string">"encoder"</span>, adapter.getEncoder()); <span class="comment">// 解码</span></span><br /><span class="line"><span class="number">34</span>:             pipeline.addLast(<span class="string">"handler"</span>, nettyHandler); <span class="comment">// 处理器</span></span><br /><span class="line"><span class="number">35</span>:             <span class="keyword">return</span> pipeline;</span><br /><span class="line"><span class="number">36</span>:         }</span><br /><span class="line"><span class="number">37</span>:     });</span><br /><span class="line"><span class="number">38</span>:     <span class="comment">// 服务器绑定端口监听</span></span><br /><span class="line"><span class="number">39</span>:     <span class="comment">// bind</span></span><br /><span class="line"><span class="number">40</span>:     channel = bootstrap.bind(getBindAddress());</span><br /><span class="line"><span class="number">41</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>和&nbsp;<code>dubbo-remoting-netty4</code>&nbsp;基本一致，下面只说一些差异的地方。</li>
<li>第 6 至 8 行：创建线程池，不同于&nbsp;<code>dubbo-remoting-netty4</code>&nbsp;中，创建线程组 NioEventLoopGroup 。</li>
<li>第 11 行：基于&nbsp;<code>boss</code>&nbsp;<code>worker</code>&nbsp;，创建 ChannelFactory 对象。</li>
<li><strong>并未设置</strong>&nbsp;ServerBootstrap 的可选项。</li>
</ul>
<p><strong>关闭服务器</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doClose</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// 关闭服务器通道</span></span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">5</span>:         <span class="keyword">if</span> (channel != <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">6</span>:             <span class="comment">// unbind.</span></span><br /><span class="line"> <span class="number">7</span>:             channel.close();</span><br /><span class="line"> <span class="number">8</span>:         }</span><br /><span class="line"> <span class="number">9</span>:     } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">10</span>:         logger.warn(e.getMessage(), e);</span><br /><span class="line"><span class="number">11</span>:     }</span><br /><span class="line"><span class="number">12</span>:     <span class="comment">// 关闭连接到服务器的客户端通道</span></span><br /><span class="line"><span class="number">13</span>:     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">14</span>:         Collection&lt;com.alibaba.dubbo.remoting.Channel&gt; channels = getChannels();</span><br /><span class="line"><span class="number">15</span>:         <span class="keyword">if</span> (channels != <span class="keyword">null</span> &amp;&amp; !channels.isEmpty()) {</span><br /><span class="line"><span class="number">16</span>:             <span class="keyword">for</span> (com.alibaba.dubbo.remoting.Channel channel : channels) {</span><br /><span class="line"><span class="number">17</span>:                 <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">18</span>:                     channel.close();</span><br /><span class="line"><span class="number">19</span>:                 } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">20</span>:                     logger.warn(e.getMessage(), e);</span><br /><span class="line"><span class="number">21</span>:                 }</span><br /><span class="line"><span class="number">22</span>:             }</span><br /><span class="line"><span class="number">23</span>:         }</span><br /><span class="line"><span class="number">24</span>:     } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">25</span>:         logger.warn(e.getMessage(), e);</span><br /><span class="line"><span class="number">26</span>:     }</span><br /><span class="line"><span class="number">27</span>:     <span class="comment">// 优雅关闭 ServerBootstrap</span></span><br /><span class="line"><span class="number">28</span>:     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">29</span>:         <span class="keyword">if</span> (bootstrap != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">30</span>:             <span class="comment">// release external resource.</span></span><br /><span class="line"><span class="number">31</span>:             bootstrap.releaseExternalResources();</span><br /><span class="line"><span class="number">32</span>:         }</span><br /><span class="line"><span class="number">33</span>:     } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">34</span>:         logger.warn(e.getMessage(), e);</span><br /><span class="line"><span class="number">35</span>:     }</span><br /><span class="line"><span class="number">36</span>:     <span class="comment">// 清空连接到服务器的客户端通道</span></span><br /><span class="line"><span class="number">37</span>:     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">38</span>:         <span class="keyword">if</span> (channels != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">39</span>:             channels.clear();</span><br /><span class="line"><span class="number">40</span>:         }</span><br /><span class="line"><span class="number">41</span>:     } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">42</span>:         logger.warn(e.getMessage(), e);</span><br /><span class="line"><span class="number">43</span>:     }</span><br /><span class="line"><span class="number">44</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>和&nbsp;<code>dubbo-remoting-netty4</code>&nbsp;基本一致，下面只说一些差异的地方。</li>
<li>第 27 至 35 行：调用&nbsp;<code>Bootstrap#releaseExternalResources()</code>&nbsp;方法，释放 ServerBootstrap 相关的资源。</li>
</ul>
<h1 id="6-NettyClient">6. NettyClient</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyClient.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.transport.netty.NettyClient</code></a>&nbsp;，继承 AbstractNettyClient 抽象类，Netty 客户端实现类。</p>
<p><strong>构造方法</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ChannelFactory's closure has a DirectMemory leak, using static to avoid</span></span><br /><span class="line"><span class="comment">// https://issues.jboss.org/browse/NETTY-424</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ChannelFactory channelFactory = <span class="keyword">new</span> NioClientSocketChannelFactory(Executors.newCachedThreadPool(<span class="keyword">new</span> NamedThreadFactory(<span class="string">"NettyClientBoss"</span>, <span class="keyword">true</span>)),</span><br /><span class="line">        Executors.newCachedThreadPool(<span class="keyword">new</span> NamedThreadFactory(<span class="string">"NettyClientWorker"</span>, <span class="keyword">true</span>)),</span><br /><span class="line">        Constants.DEFAULT_IO_THREADS);</span><br /><br /><span class="line"><span class="keyword">private</span> ClientBootstrap bootstrap;</span><br /><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> org.jboss.netty.channel.Channel channel; <span class="comment">// volatile, please copy reference to use</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NettyClient</span><span class="params">(<span class="keyword">final</span> URL url, <span class="keyword">final</span> ChannelHandler handler)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">    <span class="keyword">super</span>(url, wrapChannelHandler(url, handler));</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>channelFactory</code>&nbsp;属性，【TODO 8027】为啥公用</li>
</ul>
<p><strong>启动客户端</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doOpen</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// 设置日志工厂</span></span><br /><span class="line"> <span class="number">4</span>:     NettyHelper.setNettyLoggerFactory();</span><br /><span class="line"> <span class="number">5</span>: </span><br /><span class="line"> <span class="number">6</span>:     <span class="comment">// 实例化 ServerBootstrap</span></span><br /><span class="line"> <span class="number">7</span>:     bootstrap = <span class="keyword">new</span> ClientBootstrap(channelFactory);</span><br /><span class="line"> <span class="number">8</span>:     <span class="comment">// 设置可选项</span></span><br /><span class="line"> <span class="number">9</span>:     <span class="comment">// config</span></span><br /><span class="line"><span class="number">10</span>:     <span class="comment">// @see org.jboss.netty.channel.socket.SocketChannelConfig</span></span><br /><span class="line"><span class="number">11</span>:     bootstrap.setOption(<span class="string">"keepAlive"</span>, <span class="keyword">true</span>);</span><br /><span class="line"><span class="number">12</span>:     bootstrap.setOption(<span class="string">"tcpNoDelay"</span>, <span class="keyword">true</span>);</span><br /><span class="line"><span class="number">13</span>:     bootstrap.setOption(<span class="string">"connectTimeoutMillis"</span>, getTimeout());</span><br /><span class="line"><span class="number">14</span>: </span><br /><span class="line"><span class="number">15</span>:     <span class="comment">// 创建 NettyHandler 对象</span></span><br /><span class="line"><span class="number">16</span>:     <span class="keyword">final</span> NettyHandler nettyHandler = <span class="keyword">new</span> NettyHandler(getUrl(), <span class="keyword">this</span>);</span><br /><span class="line"><span class="number">17</span>: </span><br /><span class="line"><span class="number">18</span>:     <span class="comment">// 设置责任链路</span></span><br /><span class="line"><span class="number">19</span>:     bootstrap.setPipelineFactory(<span class="keyword">new</span> ChannelPipelineFactory() {</span><br /><span class="line"><span class="number">20</span>:         <span class="function"><span class="keyword">public</span> ChannelPipeline <span class="title">getPipeline</span><span class="params">()</span> </span>{</span><br /><span class="line"><span class="number">21</span>:             <span class="comment">// 创建 NettyCodecAdapter 对象</span></span><br /><span class="line"><span class="number">22</span>:             NettyCodecAdapter adapter = <span class="keyword">new</span> NettyCodecAdapter(getCodec(), getUrl(), NettyClient.<span class="keyword">this</span>);</span><br /><span class="line"><span class="number">23</span>:             ChannelPipeline pipeline = Channels.pipeline();</span><br /><span class="line"><span class="number">24</span>:             pipeline.addLast(<span class="string">"decoder"</span>, adapter.getDecoder()); <span class="comment">// 解码</span></span><br /><span class="line"><span class="number">25</span>:             pipeline.addLast(<span class="string">"encoder"</span>, adapter.getEncoder()); <span class="comment">// 编码</span></span><br /><span class="line"><span class="number">26</span>:             pipeline.addLast(<span class="string">"handler"</span>, nettyHandler); <span class="comment">// 处理器</span></span><br /><span class="line"><span class="number">27</span>:             <span class="keyword">return</span> pipeline;</span><br /><span class="line"><span class="number">28</span>:         }</span><br /><span class="line"><span class="number">29</span>:     });</span><br /><span class="line"><span class="number">30</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>和&nbsp;<code>dubbo-remoting-netty4</code>&nbsp;基本一致。</li>
</ul>
<p><strong>连接服务器</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doConnect</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">long</span> start = System.currentTimeMillis();</span><br /><span class="line"> <span class="number">4</span>:     <span class="comment">// 连接服务器</span></span><br /><span class="line"> <span class="number">5</span>:     ChannelFuture future = bootstrap.connect(getConnectAddress());</span><br /><span class="line"> <span class="number">6</span>:     <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">7</span>:         <span class="comment">// 等待连接成功或者超时</span></span><br /><span class="line"> <span class="number">8</span>:         <span class="keyword">boolean</span> ret = future.awaitUninterruptibly(getConnectTimeout(), TimeUnit.MILLISECONDS);</span><br /><span class="line"> <span class="number">9</span>:         <span class="comment">// 连接成功</span></span><br /><span class="line"><span class="number">10</span>:         <span class="keyword">if</span> (ret &amp;&amp; future.isSuccess()) {</span><br /><span class="line"><span class="number">11</span>:             Channel newChannel = future.getChannel();</span><br /><span class="line"><span class="number">12</span>:             newChannel.setInterestOps(Channel.OP_READ_WRITE);</span><br /><span class="line"><span class="number">13</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">14</span>:                 <span class="comment">// 关闭老的连接</span></span><br /><span class="line"><span class="number">15</span>:                 <span class="comment">// Close old channel</span></span><br /><span class="line"><span class="number">16</span>:                 Channel oldChannel = NettyClient.<span class="keyword">this</span>.channel; <span class="comment">// copy reference</span></span><br /><span class="line"><span class="number">17</span>:                 <span class="keyword">if</span> (oldChannel != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">18</span>:                     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">19</span>:                         <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line"><span class="number">20</span>:                             logger.info(<span class="string">"Close old netty channel "</span> + oldChannel + <span class="string">" on create new netty channel "</span> + newChannel);</span><br /><span class="line"><span class="number">21</span>:                         }</span><br /><span class="line"><span class="number">22</span>:                         oldChannel.close();</span><br /><span class="line"><span class="number">23</span>:                     } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">24</span>:                         NettyChannel.removeChannelIfDisconnected(oldChannel);</span><br /><span class="line"><span class="number">25</span>:                     }</span><br /><span class="line"><span class="number">26</span>:                 }</span><br /><span class="line"><span class="number">27</span>:             } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">28</span>:                 <span class="comment">// 若 NettyClient 被关闭，关闭连接</span></span><br /><span class="line"><span class="number">29</span>:                 <span class="keyword">if</span> (NettyClient.<span class="keyword">this</span>.isClosed()) {</span><br /><span class="line"><span class="number">30</span>:                     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">31</span>:                         <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line"><span class="number">32</span>:                             logger.info(<span class="string">"Close new netty channel "</span> + newChannel + <span class="string">", because the client closed."</span>);</span><br /><span class="line"><span class="number">33</span>:                         }</span><br /><span class="line"><span class="number">34</span>:                         newChannel.close();</span><br /><span class="line"><span class="number">35</span>:                     } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">36</span>:                         NettyClient.<span class="keyword">this</span>.channel = <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">37</span>:                         NettyChannel.removeChannelIfDisconnected(newChannel);</span><br /><span class="line"><span class="number">38</span>:                     }</span><br /><span class="line"><span class="number">39</span>:                 <span class="comment">// 设置新连接</span></span><br /><span class="line"><span class="number">40</span>:                 } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">41</span>:                     NettyClient.<span class="keyword">this</span>.channel = newChannel;</span><br /><span class="line"><span class="number">42</span>:                 }</span><br /><span class="line"><span class="number">43</span>:             }</span><br /><span class="line"><span class="number">44</span>:         <span class="comment">// 发生异常，抛出 RemotingException 异常</span></span><br /><span class="line"><span class="number">45</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (future.getCause() != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">46</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> RemotingException(<span class="keyword">this</span>, <span class="string">"client(url: "</span> + getUrl() + <span class="string">") failed to connect to server "</span></span><br /><span class="line"><span class="number">47</span>:                     + getRemoteAddress() + <span class="string">", error message is:"</span> + future.getCause().getMessage(), future.getCause());</span><br /><span class="line"><span class="number">48</span>:         <span class="comment">// 无结果（连接超时），抛出 RemotingException 异常</span></span><br /><span class="line"><span class="number">49</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">50</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> RemotingException(<span class="keyword">this</span>, <span class="string">"client(url: "</span> + getUrl() + <span class="string">") failed to connect to server "</span></span><br /><span class="line"><span class="number">51</span>:                     + getRemoteAddress() + <span class="string">" client-side timeout "</span></span><br /><span class="line"><span class="number">52</span>:                     + getConnectTimeout() + <span class="string">"ms (elapsed: "</span> + (System.currentTimeMillis() - start) + <span class="string">"ms) from netty client "</span></span><br /><span class="line"><span class="number">53</span>:                     + NetUtils.getLocalHost() + <span class="string">" using dubbo version "</span> + Version.getVersion());</span><br /><span class="line"><span class="number">54</span>:         }</span><br /><span class="line"><span class="number">55</span>:     } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">56</span>:         <span class="comment">// 未连接，取消任务</span></span><br /><span class="line"><span class="number">57</span>:         <span class="keyword">if</span> (!isConnected()) {</span><br /><span class="line"><span class="number">58</span>:             future.cancel();</span><br /><span class="line"><span class="number">59</span>:         }</span><br /><span class="line"><span class="number">60</span>:     }</span><br /><span class="line"><span class="number">61</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>和&nbsp;<code>dubbo-remoting-netty4</code>&nbsp;基本一致，下面只说一些差异的地方。</li>
<li>第 9 行：调用&nbsp;<code>ChannelFuture#awaitUninterruptibly(timeout, TimeUnit)</code>&nbsp;方法，等待连接成功或超时。这里传入的不是&nbsp;<code>3000</code>&nbsp;。</li>
<li>第 55 至 60 行：最终结果为未连接，调用&nbsp;<code>ChannelFuture#cancel(true)</code>&nbsp;方法，取消任务。</li>
</ul>
<p><strong>关闭连接</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doClose</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>{</span><br /><span class="line">    <span class="comment">/*try {</span></span><br /><span class="line"><span class="comment">            bootstrap.releaseExternalResources();</span></span><br /><span class="line"><span class="comment">        } catch (Throwable t) {</span></span><br /><span class="line"><span class="comment">            logger.warn(t.getMessage());</span></span><br /><span class="line"><span class="comment">        }*/</span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>因为&nbsp;<code>channelFactory</code>&nbsp;是<strong>静态</strong>属性，被多个 NettyClient 共用。</li>
</ul>
<h1 id="7-Buffer">7. Buffer</h1>
<h2 id="7-1-NettyBackedChannelBuffer">7.1 NettyBackedChannelBuffer</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyBackedChannelBuffer.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.transport.netty.NettyBackedChannelBuffer</code></a>&nbsp;，实现 ChannelBuffer 接口，基于&nbsp;<strong>Netty3 ChannelBuffer</strong>&nbsp;的 ChannelBuffer 实现类。</p>
<p><strong>构造方法</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> org.jboss.netty.buffer.ChannelBuffer buffer;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NettyBackedChannelBuffer</span><span class="params">(org.jboss.netty.buffer.ChannelBuffer buffer)</span> </span>{</span><br /><span class="line">    Assert.notNull(buffer, <span class="string">"buffer == null"</span>);</span><br /><span class="line">    <span class="keyword">this</span>.buffer = buffer;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p><strong>工厂</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> ChannelBufferFactory <span class="title">factory</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> NettyBackedChannelBufferFactory.getInstance();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>对应的工厂是 NettyBackedChannelBufferFactory</li>
</ul>
<p><strong>实现方法</strong></p>
<p>每个方法，直接调用 Netty3 ChannelBuffer 对应的方法。</p>
<h2 id="7-2-NettyBackedChannelBufferFactory">7.2 NettyBackedChannelBufferFactory</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyBackedChannelBufferFactory.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.transport.netty.NettyBackedChannelBufferFactory</code></a>&nbsp;，实现 ChannelBufferFactory 接口，创建 NettyBackedChannelBuffer 的工厂。代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> ChannelBuffer <span class="title">getBuffer</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> NettyBackedChannelBuffer(ChannelBuffers.dynamicBuffer(capacity)); <span class="comment">// ChannelBuffers 为 `org.jboss.netty.buffer` 包下</span></span><br /><span class="line">}</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> ChannelBuffer <span class="title">getBuffer</span><span class="params">(<span class="keyword">byte</span>[] array, <span class="keyword">int</span> offset, <span class="keyword">int</span> length)</span> </span>{</span><br /><span class="line">    <span class="comment">// 创建 Netty3 ChannelBuffer 对象</span></span><br /><span class="line">    org.jboss.netty.buffer.ChannelBuffer buffer = ChannelBuffers.dynamicBuffer(length); <span class="comment">// ChannelBuffers 为 `org.jboss.netty.buffer` 包下</span></span><br /><span class="line">    <span class="comment">// 写入数据</span></span><br /><span class="line">    buffer.writeBytes(array, offset, length);</span><br /><span class="line">    <span class="comment">// 创建 NettyBackedChannelBuffer 对象</span></span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> NettyBackedChannelBuffer(buffer);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> ChannelBuffer <span class="title">getBuffer</span><span class="params">(ByteBuffer nioBuffer)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> NettyBackedChannelBuffer(ChannelBuffers.wrappedBuffer(nioBuffer)); <span class="comment">// ChannelBuffers 为 `org.jboss.netty.buffer` 包下</span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><strong>注意</strong>，此处的 ChannelBuffers 是&nbsp;<code>org.jboss.netty.buffer</code>&nbsp;包下的。</li>
</ul>
<h1 id="8-NettyCodecAdapter">8. NettyCodecAdapter</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyCodecAdapter.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.transport.netty.NettyCodecAdapter</code></a>&nbsp;，Netty 编解码<strong>适配器</strong>，将&nbsp;<strong>Dubbo 编解码器</strong>&nbsp;适配成 Netty3 的编码器和解码器。</p>
<p><strong>构造方法</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Netty 编码器</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ChannelHandler encoder = <span class="keyword">new</span> InternalEncoder();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Netty 解码器</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ChannelHandler decoder = <span class="keyword">new</span> InternalDecoder();</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Dubbo 编解码器</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Codec2 codec;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Dubbo URL</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> URL url;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * 网络读写缓冲区大小</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> bufferSize;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Dubbo ChannelHandler</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> com.alibaba.dubbo.remoting.ChannelHandler handler;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NettyCodecAdapter</span><span class="params">(Codec2 codec, URL url, com.alibaba.dubbo.remoting.ChannelHandler handler)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>.codec = codec;</span><br /><span class="line">    <span class="keyword">this</span>.url = url;</span><br /><span class="line">    <span class="keyword">this</span>.handler = handler;</span><br /><span class="line">    <span class="comment">// 设置 `bufferSize`</span></span><br /><span class="line">    <span class="keyword">int</span> b = url.getPositiveParameter(Constants.BUFFER_KEY, Constants.DEFAULT_BUFFER_SIZE);</span><br /><span class="line">    <span class="keyword">this</span>.bufferSize = b &gt;= Constants.MIN_BUFFER_SIZE &amp;&amp; b &lt;= Constants.MAX_BUFFER_SIZE ? b : Constants.DEFAULT_BUFFER_SIZE;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>bufferSize</code>&nbsp;属性，网络读写缓冲区大小，默认 8K 。这是&nbsp;<code>dubbo-remoting-netty4</code>&nbsp;的 NettyCodecAdapter 所<strong>不需要</strong>的。用于下面&nbsp;<a href="http://svip.iocoder.cn/Dubbo/remoting-impl-netty3/">「8.2 InternalDecoder」</a>&nbsp;，消息解码时使用。</li>
</ul>
<h2 id="8-1-InternalEncoder">8.1 InternalEncoder</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Sharable</span></span><br /><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalEncoder</span> <span class="keyword">extends</span> <span class="title">OneToOneEncoder</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, Channel ch, Object msg)</span> <span class="keyword">throws</span> Exception </span>{</span><br /><span class="line">        <span class="comment">// 创建 HeapChannelBuffer 对象</span></span><br /><span class="line">        com.alibaba.dubbo.remoting.buffer.ChannelBuffer buffer = com.alibaba.dubbo.remoting.buffer.ChannelBuffers.dynamicBuffer(<span class="number">1024</span>);</span><br /><span class="line">        <span class="comment">// 获得 NettyChannel 对象</span></span><br /><span class="line">        NettyChannel channel = NettyChannel.getOrAddChannel(ch, url, handler);</span><br /><span class="line">        <span class="keyword">try</span> {</span><br /><span class="line">            <span class="comment">// 编码</span></span><br /><span class="line">            codec.encode(channel, buffer, msg);</span><br /><span class="line">        } <span class="keyword">finally</span> {</span><br /><span class="line">            <span class="comment">// 移除 NettyChannel 对象，若断开连接</span></span><br /><span class="line">            NettyChannel.removeChannelIfDisconnected(ch);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// 返回 Netty ChannelBuffer 对象</span></span><br /><span class="line">        <span class="keyword">return</span> ChannelBuffers.wrappedBuffer(buffer.toByteBuffer());</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>org.jboss.netty.handler.codec.oneone.OneToOneEncoder</code>&nbsp;，Netty3 编码器<strong>抽象类</strong>。</li>
<li>🙂 代码比较简单，胖友自己看注释。</li>
</ul>
<h2 id="8-2-InternalDecoder">8.2 InternalDecoder</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalDecoder</span> <span class="keyword">extends</span> <span class="title">SimpleChannelUpstreamHandler</span> </span>{</span><br /><span class="line"> <span class="number">2</span>: </span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 4:      * 未读完的消息 Buffer</span></span><br /><span class="line"><span class="comment"> 5:      */</span></span><br /><span class="line"> <span class="number">6</span>:     <span class="keyword">private</span> com.alibaba.dubbo.remoting.buffer.ChannelBuffer buffer = com.alibaba.dubbo.remoting.buffer.ChannelBuffers.EMPTY_BUFFER;</span><br /><span class="line"> <span class="number">7</span>: </span><br /><span class="line"> <span class="number">8</span>:     <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">9</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">messageReceived</span><span class="params">(ChannelHandlerContext ctx, MessageEvent event)</span> <span class="keyword">throws</span> Exception </span>{</span><br /><span class="line"><span class="number">10</span>:         <span class="comment">// 跳过非 ChannelBuffer</span></span><br /><span class="line"><span class="number">11</span>:         Object o = event.getMessage();</span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> ChannelBuffer)) {</span><br /><span class="line"><span class="number">13</span>:             ctx.sendUpstream(event);</span><br /><span class="line"><span class="number">14</span>:             <span class="keyword">return</span>;</span><br /><span class="line"><span class="number">15</span>:         }</span><br /><span class="line"><span class="number">16</span>: </span><br /><span class="line"><span class="number">17</span>:         <span class="comment">// 无可读，跳过</span></span><br /><span class="line"><span class="number">18</span>:         ChannelBuffer input = (ChannelBuffer) o;</span><br /><span class="line"><span class="number">19</span>:         <span class="keyword">int</span> readable = input.readableBytes();</span><br /><span class="line"><span class="number">20</span>:         <span class="keyword">if</span> (readable &lt;= <span class="number">0</span>) {</span><br /><span class="line"><span class="number">21</span>:             <span class="keyword">return</span>;</span><br /><span class="line"><span class="number">22</span>:         }</span><br /><span class="line"><span class="number">23</span>: </span><br /><span class="line"><span class="number">24</span>:         <span class="comment">// 合并 `buffer` + `input` 成 `message`</span></span><br /><span class="line"><span class="number">25</span>:         com.alibaba.dubbo.remoting.buffer.ChannelBuffer message;</span><br /><span class="line"><span class="number">26</span>:         <span class="keyword">if</span> (buffer.readable()) { <span class="comment">// 有未读完的，需要拼接</span></span><br /><span class="line"><span class="number">27</span>:             <span class="keyword">if</span> (buffer <span class="keyword">instanceof</span> DynamicChannelBuffer) {</span><br /><span class="line"><span class="number">28</span>:                 buffer.writeBytes(input.toByteBuffer());</span><br /><span class="line"><span class="number">29</span>:                 message = buffer;</span><br /><span class="line"><span class="number">30</span>:             } <span class="keyword">else</span> { <span class="comment">// Netty3 ChannelBuffer ，转成 DynamicChannelBuffer 。</span></span><br /><span class="line"><span class="number">31</span>:                 <span class="keyword">int</span> size = buffer.readableBytes() + input.readableBytes();</span><br /><span class="line"><span class="number">32</span>:                 message = com.alibaba.dubbo.remoting.buffer.ChannelBuffers.dynamicBuffer(size &gt; bufferSize ? size : bufferSize);</span><br /><span class="line"><span class="number">33</span>:                 message.writeBytes(buffer, buffer.readableBytes());</span><br /><span class="line"><span class="number">34</span>:                 message.writeBytes(input.toByteBuffer());</span><br /><span class="line"><span class="number">35</span>:             }</span><br /><span class="line"><span class="number">36</span>:         } <span class="keyword">else</span> { <span class="comment">// 无未读完的，直接创建</span></span><br /><span class="line"><span class="number">37</span>:             message = com.alibaba.dubbo.remoting.buffer.ChannelBuffers.wrappedBuffer(input.toByteBuffer());</span><br /><span class="line"><span class="number">38</span>:         }</span><br /><span class="line"><span class="number">39</span>: </span><br /><span class="line"><span class="number">40</span>:         <span class="comment">// 获得 NettyChannel 对象</span></span><br /><span class="line"><span class="number">41</span>:         NettyChannel channel = NettyChannel.getOrAddChannel(ctx.getChannel(), url, handler);</span><br /><span class="line"><span class="number">42</span>:         <span class="comment">// 循环解析，直到结束</span></span><br /><span class="line"><span class="number">43</span>:         Object msg;</span><br /><span class="line"><span class="number">44</span>:         <span class="keyword">int</span> saveReaderIndex;</span><br /><span class="line"><span class="number">45</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">46</span>:             <span class="comment">// decode object.</span></span><br /><span class="line"><span class="number">47</span>:             <span class="keyword">do</span> {</span><br /><span class="line"><span class="number">48</span>:                 saveReaderIndex = message.readerIndex();</span><br /><span class="line"><span class="number">49</span>:                 <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">50</span>:                     msg = codec.decode(channel, message);</span><br /><span class="line"><span class="number">51</span>:                 } <span class="keyword">catch</span> (IOException e) {</span><br /><span class="line"><span class="number">52</span>:                     buffer = com.alibaba.dubbo.remoting.buffer.ChannelBuffers.EMPTY_BUFFER;</span><br /><span class="line"><span class="number">53</span>:                     <span class="keyword">throw</span> e;</span><br /><span class="line"><span class="number">54</span>:                 }</span><br /><span class="line"><span class="number">55</span>:                 <span class="keyword">if</span> (msg == Codec2.DecodeResult.NEED_MORE_INPUT) {</span><br /><span class="line"><span class="number">56</span>:                     message.readerIndex(saveReaderIndex);</span><br /><span class="line"><span class="number">57</span>:                     <span class="keyword">break</span>;</span><br /><span class="line"><span class="number">58</span>:                 <span class="comment">// 解码到消息，触发一条消息</span></span><br /><span class="line"><span class="number">59</span>:                 } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">60</span>:                     <span class="comment">//is it possible to go here ? 芋艿：不可能，哈哈哈</span></span><br /><span class="line"><span class="number">61</span>:                     <span class="keyword">if</span> (saveReaderIndex == message.readerIndex()) {</span><br /><span class="line"><span class="number">62</span>:                         buffer = com.alibaba.dubbo.remoting.buffer.ChannelBuffers.EMPTY_BUFFER;</span><br /><span class="line"><span class="number">63</span>:                         <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Decode without read data."</span>);</span><br /><span class="line"><span class="number">64</span>:                     }</span><br /><span class="line"><span class="number">65</span>:                     <span class="keyword">if</span> (msg != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">66</span>:                         Channels.fireMessageReceived(ctx, msg, event.getRemoteAddress());</span><br /><span class="line"><span class="number">67</span>:                     }</span><br /><span class="line"><span class="number">68</span>:                 }</span><br /><span class="line"><span class="number">69</span>:             } <span class="keyword">while</span> (message.readable());</span><br /><span class="line"><span class="number">70</span>:         } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">71</span>:             <span class="comment">// 有剩余可读的，压缩并缓存</span></span><br /><span class="line"><span class="number">72</span>:             <span class="keyword">if</span> (message.readable()) {</span><br /><span class="line"><span class="number">73</span>:                 message.discardReadBytes();</span><br /><span class="line"><span class="number">74</span>:                 buffer = message;</span><br /><span class="line"><span class="number">75</span>:             <span class="comment">// 无剩余的，设置空 Buffer</span></span><br /><span class="line"><span class="number">76</span>:             } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">77</span>:                 buffer = com.alibaba.dubbo.remoting.buffer.ChannelBuffers.EMPTY_BUFFER;</span><br /><span class="line"><span class="number">78</span>:             }</span><br /><span class="line"><span class="number">79</span>:             <span class="comment">// 移除 NettyChannel 对象，若断开连接</span></span><br /><span class="line"><span class="number">80</span>:             NettyChannel.removeChannelIfDisconnected(ctx.getChannel());</span><br /><span class="line"><span class="number">81</span>:         }</span><br /><span class="line"><span class="number">82</span>:     }</span><br /><span class="line"><span class="number">83</span>: </span><br /><span class="line"><span class="number">84</span>:     <span class="meta">@Override</span></span><br /><span class="line"><span class="number">85</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, ExceptionEvent e)</span> </span>{</span><br /><span class="line"><span class="number">86</span>:         ctx.sendUpstream(e);</span><br /><span class="line"><span class="number">87</span>:     }</span><br /><span class="line"><span class="number">88</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>继承&nbsp;<code>org.jboss.netty.channel.SimpleChannelUpstreamHandler</code>&nbsp;类。</li>
<li><code>buffer</code>&nbsp;属性，未读完的消息 Buffer 。在&nbsp;<code>#messageReceived(ctx, event)</code>&nbsp;方法中，我们在做拆包粘包的处理过程中，可能收到数据是不完整的。例如，不足以解析成一条 Dubbo Request 。那么，我们就需要将收到的，缓存到&nbsp;<code>buffer</code>&nbsp;中。</li>
<li>第 10 至 15 行：跳过非 ChannelBuffer 。</li>
<li>第 17 至 22 行：跳过无可读的。</li>
<li>第 24 至 38 行：合并&nbsp;<code>buffer</code>&nbsp;+&nbsp;<code>input</code>&nbsp;成&nbsp;<code>message</code>&nbsp;。有<strong>两类三种</strong>情况，胖友看下注释。</li>
<li>第 41 行：获得 NettyChannel 对象。</li>
<li>第 42 至 69 行：循环解析，直到结束。此处，和&nbsp;<code>dubbo-remoting-netty4</code>&nbsp;的解码流程，就是一致的了。</li>
<li>第 71 至 75 行：有剩余的部分，压缩并缓存到&nbsp;<code>buffer</code>&nbsp;中。</li>
<li>第 75 至 78 行：完全读完，设置&nbsp;<code>buffer</code>&nbsp;为空(&nbsp;<code>EMPTY_BUFFER</code>&nbsp;)。</li>
<li>第 80 行：移除 NettyChannel 对象，若断开连接。</li>
</ul>
<h1 id="9-日志工厂">9. 日志工厂</h1>
<p>和&nbsp;<code>netty-remoting-netty4</code>&nbsp;的<strong>日志工厂</strong>，基本一致。差异点是&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyHelper.java#L43-L103" target="_blank" rel="external nofollow noopener noreferrer">DubboLogger</a>&nbsp;，无需实现类似&nbsp;<code>#log(format, arguments)</code>&nbsp;等需要格式化的方法。因此，无需复制 FormattingTuple 、MessageFormatter 类。</p>
</div>