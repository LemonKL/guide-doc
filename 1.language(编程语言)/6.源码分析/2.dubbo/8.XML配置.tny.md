<header class="article-header">
<h1 class="article-title">XML 配置</h1>
</header>
<div class="article-entry">
<blockquote>
<p>本文基于 Dubbo 2.6.1 版本，望知悉。</p>
</blockquote>
<blockquote>
<p>友情提示，【<strong>配置</strong>】这块的内容，会相对比较枯燥。所以，如果看到一些很难懂的地方，建议先跳过。</p>
<p>对于 Dubbo ，重点是要去理解，多协议、RPC、容错等等模块，而不是【<strong>配置</strong>】。</p>
<p>😈 估计好多胖友被【<strong>配置</strong>】这章劝退了把？？？</p>
</blockquote>
<h1 id="1-概述">1. 概述</h1>
<p>在 Dubbo 提供的几种方式中，<strong>XML 配置</strong>肯定是大家最熟悉的方式。</p>
<p>如果胖友不熟悉，可以查看如下文档：</p>
<ul>
<li><a href="http://dubbo.apache.org/zh-cn/docs/user/configuration/xml.html" target="_blank" rel="external nofollow noopener noreferrer">《Dubbo 用户指南 &mdash;&mdash; XML 配置》</a></li>
<li><a href="http://dubbo.apache.org/zh-cn/docs/user/references/xml/introduction.html" target="_blank" rel="external nofollow noopener noreferrer">《Dubbo 用户指南 &mdash;&mdash; schema 配置参考手册》</a></li>
</ul>
<p>XML 配置，自定义&nbsp;<code>&lt;dubbo: /&gt;</code>&nbsp;标签，基于&nbsp;<strong>Spring XML</strong>&nbsp;进行解析。如果不了解的胖友，可以查看如下文档：</p>
<ul>
<li><a href="https://gavinzhang1.gitbooks.io/spring/content/xmlwen_jian_mo_ren_biao_qian_de_jie_xi.html" target="_blank" rel="external nofollow noopener noreferrer">《Spring 源码阅读 &mdash;&mdash; XML 文件默认标签的解析》</a></li>
<li><a href="https://gavinzhang1.gitbooks.io/spring/content/xmlzi_ding_yi_biao_qian_de_jie_xi.html" target="_blank" rel="external nofollow noopener noreferrer">《Spring 源码阅读 &mdash;&mdash; XML 自定义标签的解析》</a></li>
</ul>
<h1 id="2-定义">2. 定义</h1>
<h2 id="2-1-sprng-schemas">2.1 sprng.schemas</h2>
<p>Dubbo 在&nbsp;<code>dubbo-spring-config</code>&nbsp;的&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/05dd4fe091e37d08e01d4e243e3fc24dbfdc61ff/dubbo-config/dubbo-config-spring/src/main/resources/META-INF/spring.schemas" target="_blank" rel="external nofollow noopener noreferrer"><code>META-INF/spring.schemas</code></a>&nbsp;定义如下：</p>
<figure class="highlight plain">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">http\://code.alibabatech.com/schema/dubbo/dubbo.xsd=META-INF/dubbo.xsd</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>xmlns</code>&nbsp;为&nbsp;<code>http://code.alibabatech.com/schema/dubbo</code></li>
<li><code>xsd</code>&nbsp;为&nbsp;<code>META-INF/dubbo.xsd</code></li>
</ul>
<h2 id="2-2-dubbo-xsd">2.2 dubbo.xsd</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/05dd4fe091e37d08e01d4e243e3fc24dbfdc61ff/dubbo-config/dubbo-config-spring/src/main/resources/META-INF/dubbo.xsd" target="_blank" rel="external nofollow noopener noreferrer"><code>dubbo.xsd</code></a>&nbsp;定义如下：</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_01_19/01.png" alt="dubbo.xsd" /></p>
<ul>
<li><code>&lt;xsd:element name="" /&gt;</code>&nbsp;，定义了<strong>元素的名称</strong>。例如，<code>&lt;xsd:element name="application" /&gt;</code>&nbsp;对应&nbsp;<code>&lt;dubbo:application /&gt;</code>&nbsp;。</li>
<li><code>&lt;xsd:element type="" /&gt;</code>&nbsp;，定义了<strong>内建数据类型的名称</strong>。例如，<code>&lt;xsd:element type="applicationType" /&gt;</code>&nbsp;对应&nbsp;<code>&lt;xsd:complexType name="applicationType" /&gt;</code>&nbsp;。</li>
<li><code>&lt;xsd:complexType name=""&gt;</code>&nbsp;，定义了<strong>复杂类型</strong>。例如&nbsp;<code>&lt;xsd:complexType name="applicationType" /&gt;</code>&nbsp;如下：</li>
</ul>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_01_19/02.png" alt="applicationType" /></p>
<h2 id="2-3-spring-handlers">2.3 spring.handlers</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/05dd4fe091e37d08e01d4e243e3fc24dbfdc61ff/dubbo-config/dubbo-config-spring/src/main/resources/META-INF/spring.handlers" target="_blank" rel="external nofollow noopener noreferrer"><code>spring.handlers</code></a>&nbsp;定义如下：</p>
<figure class="highlight plain">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">http\://code.alibabatech.com/schema/dubbo=com.alibaba.dubbo.config.spring.schema.DubboNamespaceHandler</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>定义了 Dubbo 的 XML Namespace 的处理器 DubboNamespaceHandler 。</li>
</ul>
<h2 id="2-4-DubboNamespaceHandler">2.4 DubboNamespaceHandler</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/025ac8b49c7608b0a76ea7bd8c2de6c72138b5ef/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboNamespaceHandler.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.config.spring.schema.DubboNamespaceHandler</code></a>&nbsp;，实现&nbsp;<code>org.springframework.beans.factory.xml.NamespaceHandlerSupport</code>&nbsp;<strong>抽象类</strong>，Dubbo 的 XML Namespace 的处理器。</p>
<p>在&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/6cd9a5b53ca8f86de7eac4e978c1f2d13c439845/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboNamespaceHandler.java#L36-L49" target="_blank" rel="external nofollow noopener noreferrer"><code>#init()</code></a>&nbsp;方法，定义了每个&nbsp;<code>&lt;xsd:element /&gt;</code>&nbsp;对应的&nbsp;<code>org.springframework.beans.factory.xml.BeanDefinitionParser</code>&nbsp;，代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>{</span><br /><span class="line">    registerBeanDefinitionParser(<span class="string">"application"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(ApplicationConfig.class, <span class="keyword">true</span>));</span><br /><span class="line">    registerBeanDefinitionParser(<span class="string">"module"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(ModuleConfig.class, <span class="keyword">true</span>));</span><br /><span class="line">    registerBeanDefinitionParser(<span class="string">"registry"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(RegistryConfig.class, <span class="keyword">true</span>));</span><br /><span class="line">    registerBeanDefinitionParser(<span class="string">"monitor"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(MonitorConfig.class, <span class="keyword">true</span>));</span><br /><span class="line">    registerBeanDefinitionParser(<span class="string">"provider"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(ProviderConfig.class, <span class="keyword">true</span>));</span><br /><span class="line">    registerBeanDefinitionParser(<span class="string">"consumer"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(ConsumerConfig.class, <span class="keyword">true</span>));</span><br /><span class="line">    registerBeanDefinitionParser(<span class="string">"protocol"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(ProtocolConfig.class, <span class="keyword">true</span>));</span><br /><span class="line">    registerBeanDefinitionParser(<span class="string">"service"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(ServiceBean.class, <span class="keyword">true</span>));</span><br /><span class="line">    registerBeanDefinitionParser(<span class="string">"reference"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(ReferenceBean.class, <span class="keyword">false</span>));</span><br /><br /><span class="line">    registerBeanDefinitionParser(<span class="string">"annotation"</span>, <span class="keyword">new</span> AnnotationBeanDefinitionParser()); <span class="comment">// 废弃</span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>细心的胖友，会看到&nbsp;<code>service</code>&nbsp;标签使用的是 ServiceBean ，而不是 ServiceConfig ，<code>reference</code>&nbsp;表示用的是 ReferenceBean ，因为无论是 ServiceConfig 还是 ReferenceBean ，在解析完具体配置后，需要调用它们对应的方法进行<strong>初始化</strong>。🙂 考虑到篇幅，我们在后续文章分享。这篇我们重点放在<strong>解析</strong>。</li>
</ul>
<h1 id="3-解析">3. 解析</h1>
<p><a href="http://svip.iocoder.cn/Dubbo/configuration-xml/DubboBeanDefinitionParser"><code>com.alibaba.dubbo.config.spring.schema.DubboBeanDefinitionParser</code></a>&nbsp;，实现&nbsp;<code>org.springframework.beans.factory.xml.BeanDefinitionParser</code>&nbsp;<strong>接口</strong>，Dubbo Bean 定义解析器。</p>
<h2 id="3-1-构造方法">3.1 构造方法</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L62-L74" target="_blank" rel="external nofollow noopener noreferrer">构造方法</a>&nbsp;，代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Bean 对象的类</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; beanClass;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * 是否需要 Bean 的 `id` 属性</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> required;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DubboBeanDefinitionParser</span><span class="params">(Class&lt;?&gt; beanClass, <span class="keyword">boolean</span> required)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>.beanClass = beanClass;</span><br /><span class="line">    <span class="keyword">this</span>.required = required;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>beanClass</code>&nbsp;，Bean 对象的<strong>类</strong>。</li>
<li><code>required</code>&nbsp;，是否需要在 Bean 对象的编号(&nbsp;<code>id</code>&nbsp;) 不存在时，<strong>自动生成编号</strong>。无需被其他应用引用的配置对象，无需自动生成编号。例如有&nbsp;<code>&lt;dubbo:reference /&gt;</code>&nbsp;。</li>
</ul>
<h2 id="3-2-解析方法【主流程】">3.2 解析方法【主流程】</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L516-L518" target="_blank" rel="external nofollow noopener noreferrer"><code>#parse(Element, ParserContext)</code></a>&nbsp;方法，解析 XML 元素。代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parse</span><span class="params">(Element element, ParserContext parserContext)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> parse(element, parserContext, beanClass, required);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>调用&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L76-L292" target="_blank" rel="external nofollow noopener noreferrer"><code>#parse(Element, ParserContext, beanClass, required)</code></a>&nbsp;方法，<strong>真正</strong>解析 XML 元素。该方法十分冗长，近 200+ 行。另外算上内部会调用其他方法，整体 500+ 行左右。🙂 下面，我们来将方法切换理解。</li>
</ul>
<blockquote>
<p>友情提示：建议胖友，能够边看边调试。</p>
</blockquote>
<h3 id="3-2-1-创建-RootBeanDefinition">3.2.1 创建 RootBeanDefinition</h3>
<p><a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L76-L292" target="_blank" rel="external nofollow noopener noreferrer"><code>#parse(Element, ParserContext, beanClass, required)</code></a>&nbsp;的第 78 至 80 行，代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">RootBeanDefinition beanDefinition = <span class="keyword">new</span> RootBeanDefinition();</span><br /><span class="line">beanDefinition.setBeanClass(beanClass);</span><br /><span class="line">beanDefinition.setLazyInit(<span class="keyword">false</span>);</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>默认&nbsp;<code>lazyInit = false</code>&nbsp;。</p>
<blockquote>
<p>FROM&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/configuration/xml.html" target="_blank" rel="external nofollow noopener noreferrer">《Dubbo 用户指南 &mdash;&mdash; XML 配置》</a><br />引用缺省是延迟初始化的，只有引用被注入到其它 Bean，或被 getBean() 获取，才会初始化。如果需要饥饿加载，即没有人引用也立即生成动态代理，可以配置：<code>&lt;dubbo:reference ... init="true" /&gt;</code></p>
</blockquote>
</li>
</ul>
<h3 id="3-2-2-处理-Bean-的编号">3.2.2 处理 Bean 的编号</h3>
<p><a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L81-L111" target="_blank" rel="external nofollow noopener noreferrer"><code>#parse(Element, ParserContext, beanClass, required)</code></a>&nbsp;的第 81 至 111 行，代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">81</span>: <span class="comment">// 解析配置对象的 id 。若不存在，则进行生成。</span></span><br /><span class="line"> <span class="number">82</span>: String id = element.getAttribute(<span class="string">"id"</span>);</span><br /><span class="line"> <span class="number">83</span>: <span class="keyword">if</span> ((id == <span class="keyword">null</span> || id.length() == <span class="number">0</span>) &amp;&amp; required) {</span><br /><span class="line"> <span class="number">84</span>:     <span class="comment">// 生成 id 。不同的配置对象，会存在不同。</span></span><br /><span class="line"> <span class="number">85</span>:     String generatedBeanName = element.getAttribute(<span class="string">"name"</span>);</span><br /><span class="line"> <span class="number">86</span>:     <span class="keyword">if</span> (generatedBeanName == <span class="keyword">null</span> || generatedBeanName.length() == <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">87</span>:         <span class="keyword">if</span> (ProtocolConfig.class.equals(beanClass)) {</span><br /><span class="line"> <span class="number">88</span>:             generatedBeanName = <span class="string">"dubbo"</span>;</span><br /><span class="line"> <span class="number">89</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">90</span>:             generatedBeanName = element.getAttribute(<span class="string">"interface"</span>);</span><br /><span class="line"> <span class="number">91</span>:         }</span><br /><span class="line"> <span class="number">92</span>:     }</span><br /><span class="line"> <span class="number">93</span>:     <span class="keyword">if</span> (generatedBeanName == <span class="keyword">null</span> || generatedBeanName.length() == <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">94</span>:         generatedBeanName = beanClass.getName();</span><br /><span class="line"> <span class="number">95</span>:     }</span><br /><span class="line"> <span class="number">96</span>:     id = generatedBeanName;</span><br /><span class="line"> <span class="number">97</span>:     <span class="comment">// 若 id 已存在，通过自增序列，解决重复。</span></span><br /><span class="line"> <span class="number">98</span>:     <span class="keyword">int</span> counter = <span class="number">2</span>;</span><br /><span class="line"> <span class="number">99</span>:     <span class="keyword">while</span> (parserContext.getRegistry().containsBeanDefinition(id)) {</span><br /><span class="line"><span class="number">100</span>:         id = generatedBeanName + (counter++);</span><br /><span class="line"><span class="number">101</span>:     }</span><br /><span class="line"><span class="number">102</span>: }</span><br /><span class="line"><span class="number">103</span>: <span class="keyword">if</span> (id != <span class="keyword">null</span> &amp;&amp; id.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">104</span>:     <span class="keyword">if</span> (parserContext.getRegistry().containsBeanDefinition(id)) {</span><br /><span class="line"><span class="number">105</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Duplicate spring bean id "</span> + id);</span><br /><span class="line"><span class="number">106</span>:     }</span><br /><span class="line"><span class="number">107</span>:     <span class="comment">// 添加到 Spring 的注册表</span></span><br /><span class="line"><span class="number">108</span>:     parserContext.getRegistry().registerBeanDefinition(id, beanDefinition);</span><br /><span class="line"><span class="number">109</span>:     <span class="comment">// 设置 Bean 的 `id` 属性值</span></span><br /><span class="line"><span class="number">110</span>:     beanDefinition.getPropertyValues().addPropertyValue(<span class="string">"id"</span>, id);</span><br /><span class="line"><span class="number">111</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>第 82 至 102 行：解析 Bean 的&nbsp;<code>id</code>&nbsp;。若不存在，则自动进行生成。
<ul>
<li>第 85 至 96 行：生成&nbsp;<code>id</code>&nbsp;。规则为&nbsp;<code>name</code>&nbsp;&gt; 特殊规则 &gt;&nbsp;<code>className</code>&nbsp;。</li>
<li>第 97 至 101 行：若&nbsp;<code>id</code>&nbsp;在 Spring 注册表已经存在，通过添加<strong>自增序列</strong>作为后缀，避免冲突。</li>
</ul>
</li>
<li>第 108 行：添加 Bean 到 Spring 注册表。</li>
<li>第 110 行：设置 Bean 的&nbsp;<code>id</code>&nbsp;。</li>
</ul>
<h3 id="3-2-3-处理-lt-dubbo-protocol-gt-特殊情况">3.2.3 处理&nbsp;<code>&lt;dubbo:protocol/&gt;</code>&nbsp;特殊情况</h3>
<p><a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L113-L128" target="_blank" rel="external nofollow noopener noreferrer"><code>#parse(Element, ParserContext, beanClass, required)</code></a>&nbsp;的第 113 至 128 行，代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="number">113</span>: <span class="comment">// 处理 `&lt;dubbo:protocol` /&gt; 的特殊情况</span></span><br /><span class="line"><span class="number">114</span>: <span class="keyword">if</span> (ProtocolConfig.class.equals(beanClass)) {</span><br /><span class="line"><span class="number">115</span>:     <span class="comment">// 需要满足第 220 至 233 行。</span></span><br /><span class="line"><span class="number">116</span>:     <span class="comment">// 例如：【顺序要这样】</span></span><br /><span class="line"><span class="number">117</span>:     <span class="comment">// &lt;dubbo:service interface="com.alibaba.dubbo.demo.DemoService" protocol="dubbo" ref="demoService"/&gt;</span></span><br /><span class="line"><span class="number">118</span>:     <span class="comment">// &lt;dubbo:protocol id="dubbo" name="dubbo" port="20880"/&gt;</span></span><br /><span class="line"><span class="number">119</span>:     <span class="keyword">for</span> (String name : parserContext.getRegistry().getBeanDefinitionNames()) {</span><br /><span class="line"><span class="number">120</span>:         BeanDefinition definition = parserContext.getRegistry().getBeanDefinition(name);</span><br /><span class="line"><span class="number">121</span>:         PropertyValue property = definition.getPropertyValues().getPropertyValue(<span class="string">"protocol"</span>);</span><br /><span class="line"><span class="number">122</span>:         <span class="keyword">if</span> (property != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">123</span>:             Object value = property.getValue();</span><br /><span class="line"><span class="number">124</span>:             <span class="keyword">if</span> (value <span class="keyword">instanceof</span> ProtocolConfig &amp;&amp; id.equals(((ProtocolConfig) value).getName())) {</span><br /><span class="line"><span class="number">125</span>:                 definition.getPropertyValues().addPropertyValue(<span class="string">"protocol"</span>, <span class="keyword">new</span> RuntimeBeanReference(id));</span><br /><span class="line"><span class="number">126</span>:             }</span><br /><span class="line"><span class="number">127</span>:         }</span><br /><span class="line"><span class="number">128</span>:     }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>在&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-xml/">「3.2.7 循环 Bean 对象的 setting 方法，将属性赋值到 Bean 对象」</a>&nbsp;统一解析。</p>
<h3 id="3-2-4-处理-lt-dubbo-service-gt-的-class-属性">3.2.4 处理&nbsp;<code>&lt;dubbo:service /&gt;</code>&nbsp;的&nbsp;<code>class</code>&nbsp;属性</h3>
<p><a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L129-L142" target="_blank" rel="external nofollow noopener noreferrer"><code>#parse(Element, ParserContext, beanClass, required)</code></a>&nbsp;的第 129 至 142 行，代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="number">113</span>: <span class="comment">// 处理 `&lt;dubbo:service /&gt;` 的属性 `class`</span></span><br /><span class="line"><span class="number">114</span>: } <span class="keyword">else</span> <span class="keyword">if</span> (ServiceBean.class.equals(beanClass)) {</span><br /><span class="line"><span class="number">115</span>:     <span class="comment">// 处理 `class` 属性。例如  &lt;dubbo:service id="sa" interface="com.alibaba.dubbo.demo.DemoService" class="com.alibaba.dubbo.demo.provider.DemoServiceImpl" &gt;</span></span><br /><span class="line"><span class="number">116</span>:     String className = element.getAttribute(<span class="string">"class"</span>);</span><br /><span class="line"><span class="number">117</span>:     <span class="keyword">if</span> (className != <span class="keyword">null</span> &amp;&amp; className.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">118</span>:         <span class="comment">// 创建 Service 的 RootBeanDefinition 对象。相当于内嵌了 &lt;bean class="com.alibaba.dubbo.demo.provider.DemoServiceImpl" /&gt;</span></span><br /><span class="line"><span class="number">119</span>:         RootBeanDefinition classDefinition = <span class="keyword">new</span> RootBeanDefinition();</span><br /><span class="line"><span class="number">120</span>:         classDefinition.setBeanClass(ReflectUtils.forName(className));</span><br /><span class="line"><span class="number">121</span>:         classDefinition.setLazyInit(<span class="keyword">false</span>);</span><br /><span class="line"><span class="number">122</span>:         <span class="comment">// 解析 Service Bean 对象的属性</span></span><br /><span class="line"><span class="number">123</span>:         parseProperties(element.getChildNodes(), classDefinition);</span><br /><span class="line"><span class="number">124</span>:         <span class="comment">// 设置 `&lt;dubbo:service ref="" /&gt;` 属性</span></span><br /><span class="line"><span class="number">125</span>:         beanDefinition.getPropertyValues().addPropertyValue(<span class="string">"ref"</span>, <span class="keyword">new</span> BeanDefinitionHolder(classDefinition, id + <span class="string">"Impl"</span>));</span><br /><span class="line"><span class="number">126</span>:     }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>处理&nbsp;<code>&lt;dubbo:service class="" /&gt;</code>&nbsp;场景下的处理，<strong>大多数</strong>情况下我们不这么使用，包括官方文档也没提供这种方式的说明。当配置&nbsp;<code>class</code>&nbsp;属时，会自动创建 Service Bean 对象，而无需再配置&nbsp;<code>ref</code>&nbsp;属性，指向 Service Bean 对象。示例如下：</p>
<figure class="highlight xml">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"demoDAO"</span> <span class="attr">class</span>=<span class="string">"com.alibaba.dubbo.demo.provider.DemoDAO"</span> /&gt;</span></span><br /><br /><span class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">id</span>=<span class="string">"sa"</span> <span class="attr">interface</span>=<span class="string">"com.alibaba.dubbo.demo.DemoService"</span>  <span class="attr">class</span>=<span class="string">"com.alibaba.dubbo.demo.provider.DemoServiceImpl"</span>&gt;</span></span><br /><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"demoDAO"</span> <span class="attr">ref</span>=<span class="string">"demoDAO"</span> /&gt;</span></span><br /><span class="line"><span class="tag">&lt;/<span class="name">dubbo:service</span>&gt;</span></span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>通过这种方式，可以使用&nbsp;<code>&lt;property /&gt;</code>&nbsp;标签，设置 Service Bean 的属性。</li>
</ul>
</li>
<li>
<p>第 118 至 121 行：创建 Service 的 Bean 对象。</p>
</li>
<li>第 123 行：调用&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L368-L399" target="_blank" rel="external nofollow noopener noreferrer"><code>#parseProperties(NodeList, RootBeanDefinition)</code></a>&nbsp;方法，解析 Service Bean 对象的属性们。详细解析见&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-xml/">「3.3.1 parseProperties」</a>&nbsp;方法。</li>
</ul>
<h3 id="3-2-5-解析-lt-dubbo-provider-gt-的内嵌子元素-lt-dubbo-service-gt">3.2.5 解析&nbsp;<code>&lt;dubbo:provider /&gt;</code>&nbsp;的内嵌子元素&nbsp;<code>&lt;dubbo:service /&gt;</code></h3>
<p><a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L143-L145" target="_blank" rel="external nofollow noopener noreferrer"><code>#parse(Element, ParserContext, beanClass, required)</code></a>&nbsp;的第 143 至 145 行，代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// 解析 `&lt;dubbo:provider /&gt;` 的内嵌子元素 `&lt;dubbo:service /&gt;`</span></span><br /><span class="line">} <span class="keyword">else</span> <span class="keyword">if</span> (ProviderConfig.class.equals(beanClass)) {</span><br /><span class="line">    parseNested(element, parserContext, ServiceBean.class, <span class="keyword">true</span>, <span class="string">"service"</span>, <span class="string">"provider"</span>, id, beanDefinition);</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>调用&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L326-L366" target="_blank" rel="external nofollow noopener noreferrer"><code>#parseNested(...)</code></a>&nbsp;方法，解析内嵌的指向的子 XML 元素。详细解析见&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-xml/">「3.3.2 parseNested」</a>&nbsp;方法。</li>
</ul>
<h3 id="3-2-6-解析-lt-dubbo-consumer-gt-的内嵌子元素-lt-dubbo-reference-gt">3.2.6 解析&nbsp;<code>&lt;dubbo:consumer /&gt;</code>&nbsp;的内嵌子元素&nbsp;<code>&lt;dubbo:reference /&gt;</code></h3>
<p><a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L146-L149" target="_blank" rel="external nofollow noopener noreferrer"><code>#parse(Element, ParserContext, beanClass, required)</code></a>&nbsp;的第 146 至 149 行，代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// 解析 `&lt;dubbo:consumer /&gt;` 的内嵌子元素 `&lt;dubbo:reference /&gt;`</span></span><br /><span class="line">} <span class="keyword">else</span> <span class="keyword">if</span> (ConsumerConfig.class.equals(beanClass)) {</span><br /><span class="line">    parseNested(element, parserContext, ReferenceBean.class, <span class="keyword">false</span>, <span class="string">"reference"</span>, <span class="string">"consumer"</span>, id, beanDefinition);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>调用&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L326-L366" target="_blank" rel="external nofollow noopener noreferrer"><code>#parseNested(...)</code></a>&nbsp;方法，解析内嵌的指向的子 XML 元素。</li>
</ul>
<h3 id="3-2-7-循环-Bean-对象的-setting-方法，将属性赋值到-Bean-对象">3.2.7 循环 Bean 对象的 setting 方法，将属性赋值到 Bean 对象</h3>
<p><a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L150-L273" target="_blank" rel="external nofollow noopener noreferrer"><code>#parse(Element, ParserContext, beanClass, required)</code></a>&nbsp;的第 150 至 273 行，代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="number">150</span>: Set&lt;String&gt; props = <span class="keyword">new</span> HashSet&lt;String&gt;(); <span class="comment">// 已解析的属性集合</span></span><br /><span class="line"><span class="number">151</span>: ManagedMap parameters = <span class="keyword">null</span>; <span class="comment">//</span></span><br /><span class="line"><span class="number">152</span>: <span class="comment">// 循环 Bean 对象的 setting 方法，将属性添加到 Bean 对象的属性赋值</span></span><br /><span class="line"><span class="number">153</span>: <span class="keyword">for</span> (Method setter : beanClass.getMethods()) {</span><br /><span class="line"><span class="number">154</span>:     String name = setter.getName();</span><br /><span class="line"><span class="number">155</span>:     <span class="keyword">if</span> (name.length() &gt; <span class="number">3</span> &amp;&amp; name.startsWith(<span class="string">"set"</span>)</span><br /><span class="line"><span class="number">156</span>:             &amp;&amp; Modifier.isPublic(setter.getModifiers())</span><br /><span class="line"><span class="number">157</span>:             &amp;&amp; setter.getParameterTypes().length == <span class="number">1</span>) { <span class="comment">// setting &amp;&amp; public &amp;&amp; 唯一参数</span></span><br /><span class="line"><span class="number">158</span>:         Class&lt;?&gt; type = setter.getParameterTypes()[<span class="number">0</span>];</span><br /><span class="line"><span class="number">159</span>:         <span class="comment">// 添加 `props`</span></span><br /><span class="line"><span class="number">160</span>:         String property = StringUtils.camelToSplitName(name.substring(<span class="number">3</span>, <span class="number">4</span>).toLowerCase() + name.substring(<span class="number">4</span>), <span class="string">"-"</span>);</span><br /><span class="line"><span class="number">161</span>:         props.add(property);</span><br /><span class="line"><span class="number">162</span>:         <span class="comment">// getting &amp;&amp; public &amp;&amp; 属性值类型统一</span></span><br /><span class="line"><span class="number">163</span>:         Method getter = <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">164</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">165</span>:             getter = beanClass.getMethod(<span class="string">"get"</span> + name.substring(<span class="number">3</span>), <span class="keyword">new</span> Class&lt;?&gt;[<span class="number">0</span>]);</span><br /><span class="line"><span class="number">166</span>:         } <span class="keyword">catch</span> (NoSuchMethodException e) {</span><br /><span class="line"><span class="number">167</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">168</span>:                 getter = beanClass.getMethod(<span class="string">"is"</span> + name.substring(<span class="number">3</span>), <span class="keyword">new</span> Class&lt;?&gt;[<span class="number">0</span>]);</span><br /><span class="line"><span class="number">169</span>:             } <span class="keyword">catch</span> (NoSuchMethodException e2) {</span><br /><span class="line"><span class="number">170</span>:             }</span><br /><span class="line"><span class="number">171</span>:         }</span><br /><span class="line"><span class="number">172</span>:         <span class="keyword">if</span> (getter == <span class="keyword">null</span></span><br /><span class="line"><span class="number">173</span>:                 || !Modifier.isPublic(getter.getModifiers())</span><br /><span class="line"><span class="number">174</span>:                 || !type.equals(getter.getReturnType())) {</span><br /><span class="line"><span class="number">175</span>:             <span class="keyword">continue</span>;</span><br /><span class="line"><span class="number">176</span>:         }</span><br /><span class="line"><span class="number">177</span>:         <span class="comment">// 解析 `&lt;dubbo:parameters /&gt;`</span></span><br /><span class="line"><span class="number">178</span>:         <span class="keyword">if</span> (<span class="string">"parameters"</span>.equals(property)) {</span><br /><span class="line"><span class="number">179</span>:             parameters = parseParameters(element.getChildNodes(), beanDefinition);</span><br /><span class="line"><span class="number">180</span>:         <span class="comment">// 解析 `&lt;dubbo:method /&gt;`</span></span><br /><span class="line"><span class="number">181</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"methods"</span>.equals(property)) {</span><br /><span class="line"><span class="number">182</span>:             parseMethods(id, element.getChildNodes(), beanDefinition, parserContext);</span><br /><span class="line"><span class="number">183</span>:         <span class="comment">// 解析 `&lt;dubbo:argument /&gt;`</span></span><br /><span class="line"><span class="number">184</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"arguments"</span>.equals(property)) {</span><br /><span class="line"><span class="number">185</span>:             parseArguments(id, element.getChildNodes(), beanDefinition, parserContext);</span><br /><span class="line"><span class="number">186</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">187</span>:             String value = element.getAttribute(property);</span><br /><span class="line"><span class="number">188</span>:             <span class="keyword">if</span> (value != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">189</span>:                 value = value.trim();</span><br /><span class="line"><span class="number">190</span>:                 <span class="keyword">if</span> (value.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">191</span>:                     <span class="comment">// 不想注册到注册中心的情况，即 `registry=N/A` 。</span></span><br /><span class="line"><span class="number">192</span>:                     <span class="keyword">if</span> (<span class="string">"registry"</span>.equals(property) &amp;&amp; RegistryConfig.NO_AVAILABLE.equalsIgnoreCase(value)) {</span><br /><span class="line"><span class="number">193</span>:                         RegistryConfig registryConfig = <span class="keyword">new</span> RegistryConfig();</span><br /><span class="line"><span class="number">194</span>:                         registryConfig.setAddress(RegistryConfig.NO_AVAILABLE);</span><br /><span class="line"><span class="number">195</span>:                         beanDefinition.getPropertyValues().addPropertyValue(property, registryConfig);</span><br /><span class="line"><span class="number">196</span>:                     <span class="comment">// 多注册中心的情况</span></span><br /><span class="line"><span class="number">197</span>:                     } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"registry"</span>.equals(property) &amp;&amp; value.indexOf(<span class="string">','</span>) != -<span class="number">1</span>) {</span><br /><span class="line"><span class="number">198</span>:                         parseMultiRef(<span class="string">"registries"</span>, value, beanDefinition, parserContext);</span><br /><span class="line"><span class="number">199</span>:                     <span class="comment">// 多服务提供者的情况</span></span><br /><span class="line"><span class="number">200</span>:                     } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"provider"</span>.equals(property) &amp;&amp; value.indexOf(<span class="string">','</span>) != -<span class="number">1</span>) {</span><br /><span class="line"><span class="number">201</span>:                         parseMultiRef(<span class="string">"providers"</span>, value, beanDefinition, parserContext);</span><br /><span class="line"><span class="number">202</span>:                     <span class="comment">// 多协议的情况</span></span><br /><span class="line"><span class="number">203</span>:                     } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"protocol"</span>.equals(property) &amp;&amp; value.indexOf(<span class="string">','</span>) != -<span class="number">1</span>) {</span><br /><span class="line"><span class="number">204</span>:                         parseMultiRef(<span class="string">"protocols"</span>, value, beanDefinition, parserContext);</span><br /><span class="line"><span class="number">205</span>:                     } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">206</span>:                         Object reference;</span><br /><span class="line"><span class="number">207</span>:                         <span class="comment">// 处理属性类型为基本属性的情况</span></span><br /><span class="line"><span class="number">208</span>:                         <span class="keyword">if</span> (isPrimitive(type)) {</span><br /><span class="line"><span class="number">209</span>:                             <span class="comment">// 兼容性处理</span></span><br /><span class="line"><span class="number">210</span>:                             <span class="keyword">if</span> (<span class="string">"async"</span>.equals(property) &amp;&amp; <span class="string">"false"</span>.equals(value)</span><br /><span class="line"><span class="number">211</span>:                                     || <span class="string">"timeout"</span>.equals(property) &amp;&amp; <span class="string">"0"</span>.equals(value)</span><br /><span class="line"><span class="number">212</span>:                                     || <span class="string">"delay"</span>.equals(property) &amp;&amp; <span class="string">"0"</span>.equals(value)</span><br /><span class="line"><span class="number">213</span>:                                     || <span class="string">"version"</span>.equals(property) &amp;&amp; <span class="string">"0.0.0"</span>.equals(value)</span><br /><span class="line"><span class="number">214</span>:                                     || <span class="string">"stat"</span>.equals(property) &amp;&amp; <span class="string">"-1"</span>.equals(value)</span><br /><span class="line"><span class="number">215</span>:                                     || <span class="string">"reliable"</span>.equals(property) &amp;&amp; <span class="string">"false"</span>.equals(value)) {</span><br /><span class="line"><span class="number">216</span>:                                 <span class="comment">// backward compatibility for the default value in old version's xsd</span></span><br /><span class="line"><span class="number">217</span>:                                 value = <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">218</span>:                             }</span><br /><span class="line"><span class="number">219</span>:                             reference = value;</span><br /><span class="line"><span class="number">220</span>:                         <span class="comment">// 处理在 `&lt;dubbo:provider /&gt;` 或者 `&lt;dubbo:service /&gt;` 上定义了 `protocol` 属性的 兼容性。</span></span><br /><span class="line"><span class="number">221</span>:                         } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"protocol"</span>.equals(property)</span><br /><span class="line"><span class="number">222</span>:                                 &amp;&amp; ExtensionLoader.getExtensionLoader(Protocol.class).hasExtension(value) <span class="comment">// 存在该注册协议的实现</span></span><br /><span class="line"><span class="number">223</span>:                                 &amp;&amp; (!parserContext.getRegistry().containsBeanDefinition(value) <span class="comment">// Spring 注册表中不存在该 `&lt;dubbo:provider /&gt;` 的定义</span></span><br /><span class="line"><span class="number">224</span>:                                     || !ProtocolConfig.class.getName().equals(parserContext.getRegistry().getBeanDefinition(value).getBeanClassName())) <span class="comment">// Spring 注册表中存在该编号，但是类型不为 ProtocolConfig 。</span></span><br /><span class="line"><span class="number">225</span>:                                 ) {</span><br /><span class="line"><span class="number">226</span>:                             <span class="comment">// 目前，`&lt;dubbo:provider protocol="" /&gt;` 推荐独立成 `&lt;dubbo:protocol /&gt;`</span></span><br /><span class="line"><span class="number">227</span>:                             <span class="keyword">if</span> (<span class="string">"dubbo:provider"</span>.equals(element.getTagName())) {</span><br /><span class="line"><span class="number">228</span>:                                 logger.warn(<span class="string">"Recommended replace &lt;dubbo:provider protocol=\""</span> + value + <span class="string">"\" ... /&gt; to &lt;dubbo:protocol name=\""</span> + value + <span class="string">"\" ... /&gt;"</span>);</span><br /><span class="line"><span class="number">229</span>:                             }</span><br /><span class="line"><span class="number">230</span>:                             <span class="comment">// backward compatibility</span></span><br /><span class="line"><span class="number">231</span>:                             ProtocolConfig protocol = <span class="keyword">new</span> ProtocolConfig();</span><br /><span class="line"><span class="number">232</span>:                             protocol.setName(value);</span><br /><span class="line"><span class="number">233</span>:                             reference = protocol;</span><br /><span class="line"><span class="number">234</span>:                         <span class="comment">// 处理 `onreturn` 属性</span></span><br /><span class="line"><span class="number">235</span>:                         } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"onreturn"</span>.equals(property)) {</span><br /><span class="line"><span class="number">236</span>:                             <span class="comment">// 按照 `.` 拆分</span></span><br /><span class="line"><span class="number">237</span>:                             <span class="keyword">int</span> index = value.lastIndexOf(<span class="string">"."</span>);</span><br /><span class="line"><span class="number">238</span>:                             String returnRef = value.substring(<span class="number">0</span>, index);</span><br /><span class="line"><span class="number">239</span>:                             String returnMethod = value.substring(index + <span class="number">1</span>);</span><br /><span class="line"><span class="number">240</span>:                             <span class="comment">// 创建 RuntimeBeanReference ，指向回调的对象</span></span><br /><span class="line"><span class="number">241</span>:                             reference = <span class="keyword">new</span> RuntimeBeanReference(returnRef);</span><br /><span class="line"><span class="number">242</span>:                             <span class="comment">// 设置 `onreturnMethod` 到 BeanDefinition 的属性值</span></span><br /><span class="line"><span class="number">243</span>:                             beanDefinition.getPropertyValues().addPropertyValue(<span class="string">"onreturnMethod"</span>, returnMethod);</span><br /><span class="line"><span class="number">244</span>:                             <span class="comment">// 处理 `onthrow` 属性</span></span><br /><span class="line"><span class="number">245</span>:                         } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"onthrow"</span>.equals(property)) {</span><br /><span class="line"><span class="number">246</span>:                             <span class="comment">// 按照 `.` 拆分</span></span><br /><span class="line"><span class="number">247</span>:                             <span class="keyword">int</span> index = value.lastIndexOf(<span class="string">"."</span>);</span><br /><span class="line"><span class="number">248</span>:                             String throwRef = value.substring(<span class="number">0</span>, index);</span><br /><span class="line"><span class="number">249</span>:                             String throwMethod = value.substring(index + <span class="number">1</span>);</span><br /><span class="line"><span class="number">250</span>:                             <span class="comment">// 创建 RuntimeBeanReference ，指向回调的对象</span></span><br /><span class="line"><span class="number">251</span>:                             reference = <span class="keyword">new</span> RuntimeBeanReference(throwRef);</span><br /><span class="line"><span class="number">252</span>:                             <span class="comment">// 设置 `onthrowMethod` 到 BeanDefinition 的属性值</span></span><br /><span class="line"><span class="number">253</span>:                             beanDefinition.getPropertyValues().addPropertyValue(<span class="string">"onthrowMethod"</span>, throwMethod);</span><br /><span class="line"><span class="number">254</span>:                         <span class="comment">// 通用解析</span></span><br /><span class="line"><span class="number">255</span>:                         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">256</span>:                             <span class="comment">// 指向的 Service 的 Bean 对象，必须是单例</span></span><br /><span class="line"><span class="number">257</span>:                             <span class="keyword">if</span> (<span class="string">"ref"</span>.equals(property) &amp;&amp; parserContext.getRegistry().containsBeanDefinition(value)) {</span><br /><span class="line"><span class="number">258</span>:                                 BeanDefinition refBean = parserContext.getRegistry().getBeanDefinition(value);</span><br /><span class="line"><span class="number">259</span>:                                 <span class="keyword">if</span> (!refBean.isSingleton()) {</span><br /><span class="line"><span class="number">260</span>:                                     <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The exported service ref "</span> + value + <span class="string">" must be singleton! Please set the "</span> + value + <span class="string">" bean scope to singleton, eg: &lt;bean id=\""</span> + value + <span class="string">"\" scope=\"singleton\" ...&gt;"</span>);</span><br /><span class="line"><span class="number">261</span>:                                 }</span><br /><span class="line"><span class="number">262</span>:                             }</span><br /><span class="line"><span class="number">263</span>:                             <span class="comment">// 创建 RuntimeBeanReference ，指向 Service 的 Bean 对象</span></span><br /><span class="line"><span class="number">264</span>:                             reference = <span class="keyword">new</span> RuntimeBeanReference(value);</span><br /><span class="line"><span class="number">265</span>:                         }</span><br /><span class="line"><span class="number">266</span>:                         <span class="comment">// 设置 BeanDefinition 的属性值</span></span><br /><span class="line"><span class="number">267</span>:                         beanDefinition.getPropertyValues().addPropertyValue(property, reference);</span><br /><span class="line"><span class="number">268</span>:                     }</span><br /><span class="line"><span class="number">269</span>:                 }</span><br /><span class="line"><span class="number">270</span>:             }</span><br /><span class="line"><span class="number">271</span>:         }</span><br /><span class="line"><span class="number">272</span>:     }</span><br /><span class="line"><span class="number">273</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>第 150 行：已解析的属性集合&nbsp;<code>props</code>&nbsp;。该属性在&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-xml/">「3.2.8 将 XML 元素未遍历到的属性，添加到&nbsp;<code>parameters</code>&nbsp;集合中」</a>&nbsp;会使用到。</li>
<li>第 151 行：解析的参数集合&nbsp;<code>parameters</code>&nbsp;。</li>
<li>第 153 行：循环 Bean 对象的 setting 方法，将属性添加到 Bean 对象的属性赋值。</li>
<li>第 154 至 157 行：判断方法符合 setting &amp;&amp;&nbsp;<code>public</code>&nbsp;&amp;&amp; 唯一参数的条件。</li>
<li>第 159 至 161 行：添加<strong>属性名</strong>到&nbsp;<code>props</code>&nbsp;。</li>
<li>第 162 至 176 行：判断方法符合 getting &amp;&amp;&nbsp;<code>public</code>&nbsp;&amp;&amp; 返回类型与 setting 参数类型<strong>一致</strong>的条件。</li>
<li>第 177 至 179 行：调用&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L436-L476" target="_blank" rel="external nofollow noopener noreferrer"><code>#parseParameters(id, nodeList, beanDefinition, parserContext)</code></a>&nbsp;方法，解析&nbsp;<code>&lt;dubbo:argument /&gt;</code>&nbsp;标签。详细解析见&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-xml/">「3.3.6 parseParameters」</a>&nbsp;方法。</li>
<li>第 180 至 182 行：调用&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L436-L476" target="_blank" rel="external nofollow noopener noreferrer"><code>#parseMethods(id, nodeList, beanDefinition, parserContext)</code></a>&nbsp;方法，解析&nbsp;<code>&lt;dubbo:method /&gt;</code>&nbsp;标签。详细解析见&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-xml/">「3.3.4 parseMethods」</a>&nbsp;方法。</li>
<li>第 183 至 185 行：调用&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L436-L476" target="_blank" rel="external nofollow noopener noreferrer"><code>#parseArguments(id, nodeList, beanDefinition, parserContext)</code></a>&nbsp;方法，解析&nbsp;<code>&lt;dubbo:argument /&gt;</code>&nbsp;标签。详细解析见&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-xml/">「3.3.5 parseArguments」</a>&nbsp;方法。</li>
<li>第 191 至 195 行：处理&nbsp;<code>"registry"</code>&nbsp;属性，不想注册到注册中心的情况，即&nbsp;<code>registry=N/A</code>&nbsp;。</li>
<li>第 196 至 204 行：调用&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L301-L324" target="_blank" rel="external nofollow noopener noreferrer"><code>#parseMultiRef(property, beanDefinition, parserContext)</code></a>&nbsp;方法，处理多注册中心、多服务提供者、多协议的情况下。详细解析见&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-xml/">「3.3. parseMultiRef」</a>&nbsp;方法。</li>
<li>第 207 至 219 行：处理属性类型为<strong>基础属性</strong>(&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L294-L299" target="_blank" rel="external nofollow noopener noreferrer"><code>#isPrimitive(Class&lt;?&gt;)</code></a>&nbsp;)的情况。</li>
<li>第 220 至 233 行：这块比较<strong>复杂</strong>。<code>"protocol"</code>&nbsp;属性，在多个标签中会使用，例如&nbsp;<code>&lt;dubbo:service /&gt;</code>&nbsp;或者&nbsp;<code>&lt;dubbo:provider /&gt;</code>&nbsp;等等。根据&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/references/xml/introduction.html" target="_blank" rel="external nofollow noopener noreferrer">《Dubbo 文档 &mdash;&mdash; schema 配置参考手册》</a>&nbsp;的说明，<code>"protocol"</code>&nbsp;代表的是指向的&nbsp;<code>&lt;dubbo:protocol /&gt;</code>&nbsp;的编号(&nbsp;<code>id</code>&nbsp;)。
<ul>
<li>【此处是猜测】但是，早期的版本，<code>"protocol"</code>&nbsp;属性，代表的是<strong>协议名</strong>。这就麻烦了，和现有的逻辑有冲突啊！</li>
<li>那怎么解决呢？优先以指向的&nbsp;<code>&lt;dubbo:protocol /&gt;</code>&nbsp;的<strong>编号</strong>(&nbsp;<code>id</code>&nbsp;) 为准备，否则认为是<strong>协议名</strong>。</li>
<li>那实际在解析 Bean 对象时，带有&nbsp;<code>"protocol"</code>&nbsp;属性的标签，无法保证一定在&nbsp;<code>&lt;dubbo:protocol /&gt;</code>&nbsp;<strong>之后</strong>解析。那咋整呢？
<ul>
<li>如果带有&nbsp;<code>"protocol"</code>&nbsp;属性的标签<strong>先</strong>解析，先【第 221 至 223 行】<strong>直接</strong>创建 ProtocolConfig 对象并设置到&nbsp;<code>"protocol"</code>&nbsp;属性，再【第 119 至 127 行】在&nbsp;<code>&lt;dubbo:protocol /&gt;</code>&nbsp;解析后，进行<strong>覆盖</strong>。这样，如果不存在&nbsp;<code>&lt;dubbo:protocol /&gt;</code>&nbsp;的情况，最多不进行覆盖呢。</li>
<li>如果带有&nbsp;<code>"protocol"</code>&nbsp;属性的标签<strong>后</strong>解析，无需走上述流程，走【第 257 至 264 行】即可。</li>
<li>🙂 如果这段无法理解，可以给我留言，有点绕。</li>
</ul>
</li>
</ul>
</li>
<li>第 234 至 243 行&nbsp;<strong>||</strong>&nbsp;第 244 至 253 行：处理&nbsp;<code>"onreturn"</code>&nbsp;和&nbsp;<code>"onthrow"</code>&nbsp;属性。该属性用于&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/events-notify.html" target="_blank" rel="external nofollow noopener noreferrer">《Dubbo 用户指南 &mdash;&mdash; 事件通知》</a>&nbsp;功能。</li>
<li>第 254 至 264 行：剩余情况，通用解析，创建 RuntimeBeanReference 对象。例如，<code>&lt;dubbo:service /&gt;</code>&nbsp;的&nbsp;<code>"ref"</code>&nbsp;属性。</li>
<li>第 267 行：设置 Bean 的属性值。<strong>该属性值来自第 206 至 265 行代码的逻辑</strong>。</li>
</ul>
<h3 id="3-2-8-将-XML-元素未遍历到的属性，添加到-parameters-集合中">3.2.8 将 XML 元素未遍历到的属性，添加到&nbsp;<code>parameters</code>&nbsp;集合中</h3>
<p><a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L274-L290" target="_blank" rel="external nofollow noopener noreferrer"><code>#parse(Element, ParserContext, beanClass, required)</code></a>&nbsp;的第 274 至 290 行，代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="number">274</span>: <span class="comment">// 将 XML 元素，未在上面遍历到的属性，添加到 `parameters` 集合中。目前测试下来，不存在这样的情况。</span></span><br /><span class="line"><span class="number">275</span>: NamedNodeMap attributes = element.getAttributes();</span><br /><span class="line"><span class="number">276</span>: <span class="keyword">int</span> len = attributes.getLength();</span><br /><span class="line"><span class="number">277</span>: <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) {</span><br /><span class="line"><span class="number">278</span>:     Node node = attributes.item(i);</span><br /><span class="line"><span class="number">279</span>:     String name = node.getLocalName();</span><br /><span class="line"><span class="number">280</span>:     <span class="keyword">if</span> (!props.contains(name)) {</span><br /><span class="line"><span class="number">281</span>:         <span class="keyword">if</span> (parameters == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">282</span>:             parameters = <span class="keyword">new</span> ManagedMap();</span><br /><span class="line"><span class="number">283</span>:         }</span><br /><span class="line"><span class="number">284</span>:         String value = node.getNodeValue();</span><br /><span class="line"><span class="number">285</span>:         parameters.put(name, <span class="keyword">new</span> TypedStringValue(value, String.class));</span><br /><span class="line"><span class="number">286</span>:     }</span><br /><span class="line"><span class="number">287</span>: }</span><br /><span class="line"><span class="number">288</span>: <span class="keyword">if</span> (parameters != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">289</span>:     beanDefinition.getPropertyValues().addPropertyValue(<span class="string">"parameters"</span>, parameters);</span><br /><span class="line"><span class="number">290</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>第 275 至 287 行：将 XML 元素，<strong>未在上面遍历到的属性</strong>，添加到&nbsp;<code>parameters</code>&nbsp;集合中。目前测试下来，不存在这样的情况。</li>
<li>第 288 至 290 行：设置 Bean 的&nbsp;<code>parameters</code>&nbsp;。</li>
</ul>
<h2 id="3-3-解析方法【辅流程】">3.3 解析方法【辅流程】</h2>
<h3 id="3-3-1-parseProperties">3.3.1 parseProperties</h3>
<p><a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L368-L399" target="_blank" rel="external nofollow noopener noreferrer"><code>#parseProperties(NodeList, RootBeanDefinition)</code></a>&nbsp;方法，解析 Service Bean 对象的属性们。代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 2:  * 解析 &lt;dubbo:service class="" /&gt; 情况下，内涵的 `&lt;property /&gt;` 的赋值。</span></span><br /><span class="line"><span class="comment"> 3:  *</span></span><br /><span class="line"><span class="comment"> 4:  * <span class="doctag">@param</span> nodeList 子元素数组</span></span><br /><span class="line"><span class="comment"> 5:  * <span class="doctag">@param</span> beanDefinition Bean 定义对象</span></span><br /><span class="line"><span class="comment"> 6:  */</span></span><br /><span class="line"> <span class="number">7</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">parseProperties</span><span class="params">(NodeList nodeList, RootBeanDefinition beanDefinition)</span> </span>{</span><br /><span class="line"> <span class="number">8</span>:     <span class="keyword">if</span> (nodeList != <span class="keyword">null</span> &amp;&amp; nodeList.getLength() &gt; <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">9</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nodeList.getLength(); i++) {</span><br /><span class="line"><span class="number">10</span>:             Node node = nodeList.item(i);</span><br /><span class="line"><span class="number">11</span>:             <span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element) {</span><br /><span class="line"><span class="number">12</span>:                 <span class="keyword">if</span> (<span class="string">"property"</span>.equals(node.getNodeName())</span><br /><span class="line"><span class="number">13</span>:                         || <span class="string">"property"</span>.equals(node.getLocalName())) {</span><br /><span class="line"><span class="number">14</span>:                     String name = ((Element) node).getAttribute(<span class="string">"name"</span>);</span><br /><span class="line"><span class="number">15</span>:                     <span class="keyword">if</span> (name != <span class="keyword">null</span> &amp;&amp; name.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">16</span>:                         String value = ((Element) node).getAttribute(<span class="string">"value"</span>);</span><br /><span class="line"><span class="number">17</span>:                         String ref = ((Element) node).getAttribute(<span class="string">"ref"</span>);</span><br /><span class="line"><span class="number">18</span>:                         <span class="comment">// value</span></span><br /><span class="line"><span class="number">19</span>:                         <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; value.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">20</span>:                             beanDefinition.getPropertyValues().addPropertyValue(name, value);</span><br /><span class="line"><span class="number">21</span>:                         <span class="comment">// ref</span></span><br /><span class="line"><span class="number">22</span>:                         } <span class="keyword">else</span> <span class="keyword">if</span> (ref != <span class="keyword">null</span> &amp;&amp; ref.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">23</span>:                             beanDefinition.getPropertyValues().addPropertyValue(name, <span class="keyword">new</span> RuntimeBeanReference(ref));</span><br /><span class="line"><span class="number">24</span>:                         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">25</span>:                             <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Unsupported &lt;property name=\""</span> + name + <span class="string">"\"&gt; sub tag, Only supported &lt;property name=\""</span> + name + <span class="string">"\" ref=\"...\" /&gt; or &lt;property name=\""</span> + name + <span class="string">"\" value=\"...\" /&gt;"</span>);</span><br /><span class="line"><span class="number">26</span>:                         }</span><br /><span class="line"><span class="number">27</span>:                     }</span><br /><span class="line"><span class="number">28</span>:                 }</span><br /><span class="line"><span class="number">29</span>:             }</span><br /><span class="line"><span class="number">30</span>:         }</span><br /><span class="line"><span class="number">31</span>:     }</span><br /><span class="line"><span class="number">32</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>第 11 至 13 行：<strong>只</strong>解析&nbsp;<code>&lt;property /&gt;</code>&nbsp;标签。</li>
<li>第 18 至 20 行：优先使用&nbsp;<code>"value"</code>&nbsp;属性。</li>
<li>第 21 至 23 行：其次使用&nbsp;<code>"ref"</code>&nbsp;属性。</li>
<li>第 24 至 27 行：属性补全，抛出异常。</li>
</ul>
<h3 id="3-3-2-parseNested">3.3.2 parseNested</h3>
<p><a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L326-L366" target="_blank" rel="external nofollow noopener noreferrer"><code>#parseNested(...)</code></a>&nbsp;方法，解析内嵌的指向的子 XML 元素。代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 2:  * 解析内嵌的指向的子 XML 元素</span></span><br /><span class="line"><span class="comment"> 3:  *</span></span><br /><span class="line"><span class="comment"> 4:  * <span class="doctag">@param</span> element 父 XML 元素</span></span><br /><span class="line"><span class="comment"> 5:  * <span class="doctag">@param</span> parserContext Spring 解析上下文</span></span><br /><span class="line"><span class="comment"> 6:  * <span class="doctag">@param</span> beanClass 内嵌解析子元素的 Bean 的类</span></span><br /><span class="line"><span class="comment"> 7:  * <span class="doctag">@param</span> required 是否需要 Bean 的 `id` 属性</span></span><br /><span class="line"><span class="comment"> 8:  * <span class="doctag">@param</span> tag 标签</span></span><br /><span class="line"><span class="comment"> 9:  * <span class="doctag">@param</span> property 父 Bean 对象在子元素中的属性名</span></span><br /><span class="line"><span class="comment">10:  * <span class="doctag">@param</span> ref 指向</span></span><br /><span class="line"><span class="comment">11:  * <span class="doctag">@param</span> beanDefinition 父 Bean 定义对象</span></span><br /><span class="line"><span class="comment">12:  */</span></span><br /><span class="line"><span class="number">13</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">parseNested</span><span class="params">(Element element, ParserContext parserContext, Class&lt;?&gt; beanClass, <span class="keyword">boolean</span> required, String tag,</span></span></span><br /><span class="line"><span class="function"><span class="params"><span class="number">14</span>:                                 String property, String ref, BeanDefinition beanDefinition)</span> </span>{</span><br /><span class="line"><span class="number">15</span>:     NodeList nodeList = element.getChildNodes();</span><br /><span class="line"><span class="number">16</span>:     <span class="keyword">if</span> (nodeList != <span class="keyword">null</span> &amp;&amp; nodeList.getLength() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">17</span>:         <span class="keyword">boolean</span> first = <span class="keyword">true</span>;</span><br /><span class="line"><span class="number">18</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nodeList.getLength(); i++) {</span><br /><span class="line"><span class="number">19</span>:             Node node = nodeList.item(i);</span><br /><span class="line"><span class="number">20</span>:             <span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element) {</span><br /><span class="line"><span class="number">21</span>:                 <span class="keyword">if</span> (tag.equals(node.getNodeName())</span><br /><span class="line"><span class="number">22</span>:                         || tag.equals(node.getLocalName())) { <span class="comment">// 这三行，判断是否为指定要解析的子元素</span></span><br /><span class="line"><span class="number">23</span>:                     <span class="comment">// 【TODO 8008】 芋艿，default 是干锤子的</span></span><br /><span class="line"><span class="number">24</span>:                     <span class="keyword">if</span> (first) {</span><br /><span class="line"><span class="number">25</span>:                         first = <span class="keyword">false</span>;</span><br /><span class="line"><span class="number">26</span>:                         String isDefault = element.getAttribute(<span class="string">"default"</span>);</span><br /><span class="line"><span class="number">27</span>:                         <span class="keyword">if</span> (isDefault == <span class="keyword">null</span> || isDefault.length() == <span class="number">0</span>) {</span><br /><span class="line"><span class="number">28</span>:                             beanDefinition.getPropertyValues().addPropertyValue(<span class="string">"default"</span>, <span class="string">"false"</span>);</span><br /><span class="line"><span class="number">29</span>:                         }</span><br /><span class="line"><span class="number">30</span>:                     }</span><br /><span class="line"><span class="number">31</span>:                     <span class="comment">// 解析子元素，创建 BeanDefinition 对象</span></span><br /><span class="line"><span class="number">32</span>:                     BeanDefinition subDefinition = parse((Element) node, parserContext, beanClass, required);</span><br /><span class="line"><span class="number">33</span>:                     <span class="comment">// 设置子 BeanDefinition ，指向父 BeanDefinition 。</span></span><br /><span class="line"><span class="number">34</span>:                     <span class="keyword">if</span> (subDefinition != <span class="keyword">null</span> &amp;&amp; ref != <span class="keyword">null</span> &amp;&amp; ref.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">35</span>:                         subDefinition.getPropertyValues().addPropertyValue(property, <span class="keyword">new</span> RuntimeBeanReference(ref));</span><br /><span class="line"><span class="number">36</span>:                     }</span><br /><span class="line"><span class="number">37</span>:                 }</span><br /><span class="line"><span class="number">38</span>:             }</span><br /><span class="line"><span class="number">39</span>:         }</span><br /><span class="line"><span class="number">40</span>:     }</span><br /><span class="line"><span class="number">41</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>第 20 至 22 行：<strong>只</strong>解析<strong>指定标签</strong>。目前有<strong>内嵌</strong>的&nbsp;<code>&lt;dubbo:service /&gt;</code>&nbsp;和&nbsp;<code>&lt;dubbo:reference /&gt;</code>&nbsp;标签。</li>
<li>第 32 行：解析指定标签，创建子 Bean 对象。</li>
<li>第 33 至 36 行：设置创建的<strong>子</strong>&nbsp;Bean 对象，指向<strong>父</strong>&nbsp;Bean 对象。</li>
</ul>
<h3 id="3-3-3-parseMultiRef">3.3.3 parseMultiRef</h3>
<p><a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L301-L324" target="_blank" rel="external nofollow noopener noreferrer"><code>#parseMultiRef(property, beanDefinition, parserContext)</code></a>&nbsp;方法，解析多指向的情况，例如多注册中心，多协议等等。代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 2:  * 解析多指向的情况，例如多注册中心，多协议等等。</span></span><br /><span class="line"><span class="comment"> 3:  *</span></span><br /><span class="line"><span class="comment"> 4:  * <span class="doctag">@param</span> property 属性</span></span><br /><span class="line"><span class="comment"> 5:  * <span class="doctag">@param</span> value 值</span></span><br /><span class="line"><span class="comment"> 6:  * <span class="doctag">@param</span> beanDefinition Bean 定义对象</span></span><br /><span class="line"><span class="comment"> 7:  * <span class="doctag">@param</span> parserContext Spring 解析上下文</span></span><br /><span class="line"><span class="comment"> 8:  */</span></span><br /><span class="line"> <span class="number">9</span>: <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br /><span class="line"><span class="number">10</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">parseMultiRef</span><span class="params">(String property, String value, RootBeanDefinition beanDefinition,</span></span></span><br /><span class="line"><span class="function"><span class="params"><span class="number">11</span>:                                   ParserContext parserContext)</span> </span>{</span><br /><span class="line"><span class="number">12</span>:     String[] values = value.split(<span class="string">"\\s*[,]+\\s*"</span>);</span><br /><span class="line"><span class="number">13</span>:     ManagedList list = <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">14</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; values.length; i++) {</span><br /><span class="line"><span class="number">15</span>:         String v = values[i];</span><br /><span class="line"><span class="number">16</span>:         <span class="keyword">if</span> (v != <span class="keyword">null</span> &amp;&amp; v.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">17</span>:             <span class="keyword">if</span> (list == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">18</span>:                 list = <span class="keyword">new</span> ManagedList();</span><br /><span class="line"><span class="number">19</span>:             }</span><br /><span class="line"><span class="number">20</span>:             list.add(<span class="keyword">new</span> RuntimeBeanReference(v));</span><br /><span class="line"><span class="number">21</span>:         }</span><br /><span class="line"><span class="number">22</span>:     }</span><br /><span class="line"><span class="number">23</span>:     beanDefinition.getPropertyValues().addPropertyValue(property, list);</span><br /><span class="line"><span class="number">24</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>第 12 至 22 行：以&nbsp;<code>.</code>&nbsp;拆分<strong>值</strong>字符串，创建 RuntimeBeanReference 数组。</li>
<li>第 23 行：设置 Bean 对象的指定属性值。</li>
</ul>
<h3 id="3-3-4-parseMethods">3.3.4 parseMethods</h3>
<p><a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L436-L476" target="_blank" rel="external nofollow noopener noreferrer"><code>#parseMethods(id, nodeList, beanDefinition, parserContext)</code></a>&nbsp;方法，解析&nbsp;<code>&lt;dubbo:method /&gt;</code>&nbsp;标签。代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 2:  * 解析 `&lt;dubbo:method /&gt;`</span></span><br /><span class="line"><span class="comment"> 3:  *</span></span><br /><span class="line"><span class="comment"> 4:  * <span class="doctag">@param</span> id Bean 的 `id` 属性。</span></span><br /><span class="line"><span class="comment"> 5:  * <span class="doctag">@param</span> nodeList 子元素节点数组</span></span><br /><span class="line"><span class="comment"> 6:  * <span class="doctag">@param</span> beanDefinition Bean 定义对象</span></span><br /><span class="line"><span class="comment"> 7:  * <span class="doctag">@param</span> parserContext 解析上下文</span></span><br /><span class="line"><span class="comment"> 8:  */</span></span><br /><span class="line"> <span class="number">9</span>: <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br /><span class="line"><span class="number">10</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">parseMethods</span><span class="params">(String id, NodeList nodeList, RootBeanDefinition beanDefinition,</span></span></span><br /><span class="line"><span class="function"><span class="params"><span class="number">11</span>:                                  ParserContext parserContext)</span> </span>{</span><br /><span class="line"><span class="number">12</span>:     <span class="keyword">if</span> (nodeList != <span class="keyword">null</span> &amp;&amp; nodeList.getLength() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">13</span>:         ManagedList methods = <span class="keyword">null</span>; <span class="comment">// 解析的方法数组</span></span><br /><span class="line"><span class="number">14</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nodeList.getLength(); i++) {</span><br /><span class="line"><span class="number">15</span>:             Node node = nodeList.item(i);</span><br /><span class="line"><span class="number">16</span>:             <span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element) {</span><br /><span class="line"><span class="number">17</span>:                 Element element = (Element) node;</span><br /><span class="line"><span class="number">18</span>:                 <span class="keyword">if</span> (<span class="string">"method"</span>.equals(node.getNodeName())</span><br /><span class="line"><span class="number">19</span>:                         || <span class="string">"method"</span>.equals(node.getLocalName())) { <span class="comment">// 这三行，判断值解析 `&lt;dubbo:method /&gt;`</span></span><br /><span class="line"><span class="number">20</span>:                     <span class="comment">// 方法名不能为空</span></span><br /><span class="line"><span class="number">21</span>:                     String methodName = element.getAttribute(<span class="string">"name"</span>);</span><br /><span class="line"><span class="number">22</span>:                     <span class="keyword">if</span> (methodName == <span class="keyword">null</span> || methodName.length() == <span class="number">0</span>) {</span><br /><span class="line"><span class="number">23</span>:                         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"&lt;dubbo:method&gt; name attribute == null"</span>);</span><br /><span class="line"><span class="number">24</span>:                     }</span><br /><span class="line"><span class="number">25</span>:                     <span class="keyword">if</span> (methods == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">26</span>:                         methods = <span class="keyword">new</span> ManagedList();</span><br /><span class="line"><span class="number">27</span>:                     }</span><br /><span class="line"><span class="number">28</span>:                     <span class="comment">// 解析 `&lt;dubbo:method /&gt;`，创建 BeanDefinition 对象</span></span><br /><span class="line"><span class="number">29</span>:                     BeanDefinition methodBeanDefinition = parse(((Element) node), parserContext, MethodConfig.class, <span class="keyword">false</span>);</span><br /><span class="line"><span class="number">30</span>:                     <span class="comment">// 添加到 `methods` 中</span></span><br /><span class="line"><span class="number">31</span>:                     String name = id + <span class="string">"."</span> + methodName;</span><br /><span class="line"><span class="number">32</span>:                     BeanDefinitionHolder methodBeanDefinitionHolder = <span class="keyword">new</span> BeanDefinitionHolder(methodBeanDefinition, name);</span><br /><span class="line"><span class="number">33</span>:                     methods.add(methodBeanDefinitionHolder);</span><br /><span class="line"><span class="number">34</span>:                 }</span><br /><span class="line"><span class="number">35</span>:             }</span><br /><span class="line"><span class="number">36</span>:         }</span><br /><span class="line"><span class="number">37</span>:         <span class="keyword">if</span> (methods != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">38</span>:             beanDefinition.getPropertyValues().addPropertyValue(<span class="string">"methods"</span>, methods);</span><br /><span class="line"><span class="number">39</span>:         }</span><br /><span class="line"><span class="number">40</span>:     }</span><br /><span class="line"><span class="number">41</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>第 13 行：解析的方法数组&nbsp;<code>methods</code>&nbsp;。</li>
<li>第 16 至 19 行：<strong>只</strong>解析&nbsp;<code>&lt;dubbo:method&gt;</code>&nbsp;标签。</li>
<li>第 29 行：调用&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L516-L518" target="_blank" rel="external nofollow noopener noreferrer"><code>#parse(Element, ParserContext)</code></a>&nbsp;方法，<strong>主流程</strong>，解析&nbsp;<code>&lt;dubbo:method&gt;</code>&nbsp;标签，创建子 Bean 对象。</li>
<li>第 33 至 36 行：设置创建的<strong>子</strong>&nbsp;Bean 对象，指向<strong>父</strong>&nbsp;Bean 对象。</li>
<li>第 30 至 33 行：添加子 Bean 对象到&nbsp;<code>methods</code>&nbsp;中。</li>
<li>第 37 至 39 行：设置 Bean 的&nbsp;<code>methods</code>&nbsp;。</li>
</ul>
<h3 id="3-3-5-parseArguments">3.3.5 parseArguments</h3>
<p><a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L436-L476" target="_blank" rel="external nofollow noopener noreferrer"><code>#parseArguments(id, nodeList, beanDefinition, parserContext)</code></a>&nbsp;方法，解析&nbsp;<code>&lt;dubbo:argument /&gt;</code>&nbsp;标签。</p>
<p>和&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-xml/">「3.3.4 parseMethods」</a>&nbsp;基本一致，🙂 胖友点击方法，直接查看代码。</p>
<h3 id="3-3-6-parseParameters">3.3.6 parseParameters</h3>
<p><a href="https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L401-L434" target="_blank" rel="external nofollow noopener noreferrer"><code>#parseParameters(id, nodeList, beanDefinition, parserContext)</code></a>&nbsp;方法，解析&nbsp;<code>&lt;dubbo:argument /&gt;</code>&nbsp;标签。代码如下：</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 2:  * 解析 `&lt;dubbo:parameter /&gt;`</span></span><br /><span class="line"><span class="comment"> 3:  *</span></span><br /><span class="line"><span class="comment"> 4:  * <span class="doctag">@param</span> nodeList 子元素节点数组</span></span><br /><span class="line"><span class="comment"> 5:  * <span class="doctag">@param</span> beanDefinition Bean 定义对象</span></span><br /><span class="line"><span class="comment"> 6:  * <span class="doctag">@return</span> 参数集合</span></span><br /><span class="line"><span class="comment"> 7:  */</span></span><br /><span class="line"> <span class="number">8</span>: <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br /><span class="line"> <span class="number">9</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ManagedMap <span class="title">parseParameters</span><span class="params">(NodeList nodeList, RootBeanDefinition beanDefinition)</span> </span>{</span><br /><span class="line"><span class="number">10</span>:     <span class="keyword">if</span> (nodeList != <span class="keyword">null</span> &amp;&amp; nodeList.getLength() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">11</span>:         ManagedMap parameters = <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nodeList.getLength(); i++) {</span><br /><span class="line"><span class="number">13</span>:             Node node = nodeList.item(i);</span><br /><span class="line"><span class="number">14</span>:             <span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element) {</span><br /><span class="line"><span class="number">15</span>:                 <span class="keyword">if</span> (<span class="string">"parameter"</span>.equals(node.getNodeName())</span><br /><span class="line"><span class="number">16</span>:                         || <span class="string">"parameter"</span>.equals(node.getLocalName())) { <span class="comment">// 这三行，只解析子元素中的 `&lt;dubbo:parameter /&gt;`</span></span><br /><span class="line"><span class="number">17</span>:                     <span class="keyword">if</span> (parameters == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">18</span>:                         parameters = <span class="keyword">new</span> ManagedMap();</span><br /><span class="line"><span class="number">19</span>:                     }</span><br /><span class="line"><span class="number">20</span>:                     <span class="comment">// 添加到参数集合</span></span><br /><span class="line"><span class="number">21</span>:                     String key = ((Element) node).getAttribute(<span class="string">"key"</span>);</span><br /><span class="line"><span class="number">22</span>:                     String value = ((Element) node).getAttribute(<span class="string">"value"</span>);</span><br /><span class="line"><span class="number">23</span>:                     <span class="keyword">boolean</span> hide = <span class="string">"true"</span>.equals(((Element) node).getAttribute(<span class="string">"hide"</span>)); <span class="comment">// 【TODO 8007】 &lt;dubbo:parameter hide=&ldquo;&rdquo; /&gt; 的用途</span></span><br /><span class="line"><span class="number">24</span>:                     <span class="keyword">if</span> (hide) {</span><br /><span class="line"><span class="number">25</span>:                         key = Constants.HIDE_KEY_PREFIX + key;</span><br /><span class="line"><span class="number">26</span>:                     }</span><br /><span class="line"><span class="number">27</span>:                     parameters.put(key, <span class="keyword">new</span> TypedStringValue(value, String.class));</span><br /><span class="line"><span class="number">28</span>:                 }</span><br /><span class="line"><span class="number">29</span>:             }</span><br /><span class="line"><span class="number">30</span>:         }</span><br /><span class="line"><span class="number">31</span>:         <span class="keyword">return</span> parameters;</span><br /><span class="line"><span class="number">32</span>:     }</span><br /><span class="line"><span class="number">33</span>:     <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">34</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>第 13 行：解析的参数集合&nbsp;<code>parameters</code>&nbsp;。</li>
<li>第 20 至 27 行：添加&nbsp;<code>"key"</code>&nbsp;<code>"value"</code>&nbsp;到&nbsp;<code>parameters</code>&nbsp;。</li>
</ul>
</div>