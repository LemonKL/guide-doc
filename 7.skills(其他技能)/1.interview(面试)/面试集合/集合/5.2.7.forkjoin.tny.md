<div class="post">
		<h1 class="postTitle">
			<a id="cb_post_title_url" class="postTitle2" href="https://www.cnblogs.com/cjsblog/p/9078341.html">Java Fork/Join 框架</a>
		</h1>
		<div class="clear"></div>
		<div class="postBody">
			<div id="cnblogs_post_body" class="blogpost-body"><h1>简介</h1>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 15px;">从JDK1.7开始，Java提供Fork/Join框架用于并行执行任务，它的思想就是讲一个大任务分割成若干小任务，最终汇总每个小任务的结果得到这个大任务的结果。</span></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 15px;">这种思想和MapReduce很像（<span style="font-family: tahoma, arial, helvetica, sans-serif;">input --&gt; split --&gt; map --&gt; reduce --&gt; output</span>）</span></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 15px;">主要有两步：</span></p>
<ul>
<li><span style="font-family: 'Microsoft YaHei'; font-size: 15px;">第一、任务切分；</span></li>
<li><span style="font-family: 'Microsoft YaHei'; font-size: 15px;">第二、结果合并</span></li>
</ul>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 15px;">它的模型大致是这样的：线程池中的每个线程都有自己的工作队列（PS：这一点和ThreadPoolExecutor不同，ThreadPoolExecutor是所有线程公用一个工作队列，所有线程都从这个工作队列中取任务），当自己队列中的任务都完成以后，会从其它线程的工作队列中偷一个任务执行，这样可以充分利用资源。</span></p>
<h1>工作窃取（work-stealing）</h1>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 15px;">工作窃取（work-stealing）算法是指某个线程从其他队列里窃取任务来执行。工作窃取的运行流程图如下：</span></p>
<p><img src="https://images2018.cnblogs.com/blog/874963/201805/874963-20180523154643214-1612544334.png" alt=""></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 15px;">那么为什么需要使用工作窃取算法呢？</span></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 15px;">假如我们需要做一个比较大的任务，我们可以把这个任务分割为若干互不依赖的子任务，为了减少线程间的竞争，于是把这些子任务分别放到不同的队列里，并为每个队列创建一个单独的线程来执行队列里的任务，线程和队列一一对应，比如A线程负责处理A队列里的任务。但是有的线程会先把自己队列里的任务干完，而其他线程对应的队列里还有任务等待处理。干完活的线程与其等着，不如去帮其他线程干活，于是它就去其他线程的队列里窃取一个任务来执行。而在这时它们会访问同一个队列，所以为了减少窃取任务线程和被窃取任务线程之间的竞争，通常会使用双端队列，被窃取任务线程永远从双端队列的头部拿任务执行，而窃取任务的线程永远从双端队列的尾部拿任务执行。</span></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 15px;">工作窃取算法的优点是充分利用线程进行并行计算，并减少了线程间的竞争，其缺点是在某些情况下还是存在竞争，比如双端队列里只有一个任务时。并且消耗了更多的系统资源，比如创建多个线程和多个双端队列。</span></p>
<h1>API介绍</h1>
<h2>ForkJoinPool</h2>
<p><span style="font-family: tahoma, arial, helvetica, sans-serif; font-size: 15px;">An ExecutorService for running ForkJoinTasks.</span></p>
<p><span style="font-family: tahoma, arial, helvetica, sans-serif; font-size: 15px;"><span style="color: #ff0000;">A ForkJoinPool differs from other kinds of ExecutorService mainly by virtue of employing <strong>work-stealing</strong></span>: all threads in the pool attempt to find and execute tasks submitted to the pool and/or created by other active tasks (eventually blocking waiting for work if none exist). This enables efficient processing when most tasks spawn other subtasks (as do most ForkJoinTasks), as well as when many small tasks are submitted to the pool from external clients. Especially when setting asyncMode to true in constructors, ForkJoinPools may also be appropriate for use with event-style tasks that are never joined.</span></p>
<p><span style="font-size: 15px; font-family: 'Microsoft YaHei';"><span style="font-family: tahoma, arial, helvetica, sans-serif;">ForkJoinPool</span>与其它的<span style="font-family: tahoma, arial, helvetica, sans-serif;">ExecutorService</span>区别主要在于它使用“工作窃取”：线程池中的所有线程都企图找到并执行提交给线程池的任务。当大量的任务产生子任务的时候，或者同时当有许多小任务被提交到线程池中的时候，这种处理是非常高效的。特别的，当在构造方法中设置<span style="font-family: 'Microsoft YaHei';">asyncMode</span>为<span style="font-family: tahoma, arial, helvetica, sans-serif;">true</span>的时候这种处理更加高效。</span></p>
<p><img src="https://images2018.cnblogs.com/blog/874963/201805/874963-20180523155916226-588922770.png" alt=""></p>
<h2><span style="font-family: tahoma, arial, helvetica, sans-serif;">ForkJoinTask</span></h2>
<p><span style="font-size: 15px;"><span style="font-family: tahoma, arial, helvetica, sans-serif;">ForkJoinTask</span><span style="font-family: 'Microsoft YaHei';">代表运行在</span><span style="font-family: tahoma, arial, helvetica, sans-serif;">ForkJoinPool</span><span style="font-family: 'Microsoft YaHei';">中的任务。</span></span></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 15px;">主要方法：</span></p>
<ul>
<li><span style="font-family: 'Microsoft YaHei'; font-size: 15px;"><span style="font-family: tahoma, arial, helvetica, sans-serif;">fork()</span> &nbsp; &nbsp;在当前线程运行的线程池中安排一个异步执行。简单的理解就是再创建一个子任务。</span></li>
<li><span style="font-family: 'Microsoft YaHei'; font-size: 15px;"><span style="font-family: tahoma, arial, helvetica, sans-serif;">join()</span> &nbsp; &nbsp;当任务完成的时候返回计算结果。</span></li>
<li><span style="font-family: 'Microsoft YaHei'; font-size: 15px;"><span style="font-family: tahoma, arial, helvetica, sans-serif;">invoke()</span> &nbsp; &nbsp;开始执行任务，如果必要，等待计算完成。</span></li>
</ul>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 15px;">子类：</span></p>
<ul>
<li><span style="font-family: 'Microsoft YaHei'; font-size: 15px;"><span style="font-family: tahoma, arial, helvetica, sans-serif;">RecursiveAction</span> &nbsp; &nbsp;一个递归无结果的<span style="font-family: tahoma, arial, helvetica, sans-serif;">ForkJoinTask</span>（没有返回值）</span></li>
<li><span style="font-family: 'Microsoft YaHei'; font-size: 15px;"><span style="font-family: tahoma, arial, helvetica, sans-serif;">RecursiveTask</span> &nbsp; &nbsp;一个递归有结果的<span style="font-family: tahoma, arial, helvetica, sans-serif;">ForkJoinTask</span>（有返回值）</span></li>
</ul>
<h2>ForkJoinWorkerThread</h2>
<p><span style="font-family: tahoma, arial, helvetica, sans-serif; font-size: 15px;">A thread managed by a <strong>ForkJoinPool</strong>, which executes <strong>ForkJoinTasks</strong>.</span></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 15px;"><span style="font-family: tahoma, arial, helvetica, sans-serif;">ForkJoinWorkerThread</span>代表<span style="font-family: tahoma, arial, helvetica, sans-serif;">ForkJoinPool</span>线程池中的一个执行任务的线程。</span></p>
<h1>类图</h1>
<p><img src="https://images2018.cnblogs.com/blog/874963/201805/874963-20180523163529873-1907395587.png" alt="">&nbsp;&nbsp;<img src="https://images2018.cnblogs.com/blog/874963/201805/874963-20180523163540976-673113189.png" alt="">&nbsp;&nbsp;<img src="https://images2018.cnblogs.com/blog/874963/201805/874963-20180523163554075-1223888829.png" alt=""></p>
<h1>代码分析</h1>
<p><span style="font-size: 15px; font-family: 'Microsoft YaHei';">接下来，简略的看一下关键代码来加深对Fork/Join的理解。</span></p>
<h2>ForkJoinPool</h2>
<p>WorkQueue是一个ForkJoinPool中的内部类，它是线程池中线程的工作队列的一个封装，支持任务窃取。</p>
<p>什么叫线程的任务窃取呢？就是说你和你的一个伙伴一起吃水果，你的那份吃完了，他那份没吃完，那你就偷偷的拿了他的一些水果吃了。存在执行2个任务的子线程，这里要讲成存在A,B两个个WorkQueue在执行任务，A的任务执行完了，B的任务没执行完，那么A的WorkQueue就从B的WorkQueue的ForkJoinTask数组中拿走了一部分尾部的任务来执行，可以合理的提高运行和计算效率。</p>
<p><img src="https://images2018.cnblogs.com/blog/874963/201805/874963-20180523165423328-909454940.png" alt=""></p>
<h3>submit()</h3>
<p><img src="https://images2018.cnblogs.com/blog/874963/201805/874963-20180523170036097-1854162491.png" alt=""></p>
<p><img src="https://images2018.cnblogs.com/blog/874963/201805/874963-20180523170046577-972016318.png" alt=""></p>
<p><img src="https://images2018.cnblogs.com/blog/874963/201805/874963-20180523170247725-1317698839.png" alt=""></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 15px;">可以看到：</span></p>
<ol>
<li><span style="font-family: 'Microsoft YaHei'; font-size: 15px;">同样是提交任务，submit会返回ForkJoinTask，而execute不会</span></li>
<li><span style="font-family: 'Microsoft YaHei'; font-size: 15px;">任务提交给线程池以后，会将这个任务加入到当前提交者的任务队列中。</span></li>
</ol>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 15px;">前面我们说过，每个线程都有一个<span style="font-family: tahoma, arial, helvetica, sans-serif;">WorkQueue</span>，而<span style="font-family: tahoma, arial, helvetica, sans-serif;">WorkQueue</span>中有执行任务的线程（<span style="font-family: tahoma, arial, helvetica, sans-serif;">ForkJoinWorkerThread owner</span>），还有这个线程需要处理的任务（<span style="font-family: tahoma, arial, helvetica, sans-serif;">ForkJoinTask&lt;?&gt;[] array</span>）。那么这个新提交的任务就是加到array中。</span></p>
<h2>ForkJoinWorkerThread</h2>
<p><img src="https://images2018.cnblogs.com/blog/874963/201805/874963-20180523171750912-109401693.png" alt=""></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 15px;">从代码中我们可以清楚地看到，<span style="font-family: tahoma, arial, helvetica, sans-serif;">ForkJoinWorkThread</span>持有<span style="font-family: tahoma, arial, helvetica, sans-serif;">ForkJoinPool</span>和<span style="font-family: tahoma, arial, helvetica, sans-serif;">ForkJoinPool.WorkQueue</span>的引用，以表明该线程属于哪个线程池，它的工作队列是哪个</span></p>
<h2>ForkJoinTask</h2>
<h3>fork()</h3>
<p><img src="https://images2018.cnblogs.com/blog/874963/201805/874963-20180523172200955-636692873.png" alt=""></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 15px;">可以看到，如果是ForkJoinWorkerThread运行过程中fork()，则直接加入到它的工作队列中，否则，重新提交任务。</span></p>
<h3>join()和invoke()</h3>
<p><img src="https://images2018.cnblogs.com/blog/874963/201805/874963-20180523173616950-645619291.png" alt=""></p>
<p><img src="https://images2018.cnblogs.com/blog/874963/201805/874963-20180523174040579-1660483412.png" alt=""></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 15px;">可以看到它们都会等待计算完成</span></p>
<h1>图形化处理过程</h1>
<p><span style="font-size: 15px; font-family: 'Microsoft YaHei';">下面盗两张图</span></p>
<p><img src="https://images2018.cnblogs.com/blog/874963/201805/874963-20180523175928739-1854695576.png" alt=""></p>
<p><img src="https://images2018.cnblogs.com/blog/874963/201805/874963-20180523180033920-1766834164.png" alt=""></p>
<p>&nbsp;</p>
<p><img src="https://images2018.cnblogs.com/blog/874963/201805/874963-20180523180043948-1139632177.png" alt=""></p>
<p><img src="https://images2018.cnblogs.com/blog/874963/201805/874963-20180523182024837-2085258468.png" alt=""></p>
<p>&nbsp;</p>
<h1>使用示例</h1>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 15px;">批量发送消息</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.cjs.boot.demo;
</span><span style="color: #008080;"> 2</span> 
<span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.ArrayList;
</span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;
</span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.ForkJoinPool;
</span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.RecursiveAction;
</span><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.TimeUnit;
</span><span style="color: #008080;"> 8</span> 
<span style="color: #008080;"> 9</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> ForkJoinPoolDemo {
</span><span style="color: #008080;">10</span> 
<span style="color: #008080;">11</span>     <span style="color: #0000ff;">class</span> SendMsgTask <span style="color: #0000ff;">extends</span><span style="color: #000000;"> RecursiveAction {
</span><span style="color: #008080;">12</span> 
<span style="color: #008080;">13</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> THRESHOLD = 10<span style="color: #000000;">;
</span><span style="color: #008080;">14</span> 
<span style="color: #008080;">15</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> start;
</span><span style="color: #008080;">16</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> end;
</span><span style="color: #008080;">17</span>         <span style="color: #0000ff;">private</span> List&lt;String&gt;<span style="color: #000000;"> list;
</span><span style="color: #008080;">18</span> 
<span style="color: #008080;">19</span>         <span style="color: #0000ff;">public</span> SendMsgTask(<span style="color: #0000ff;">int</span> start, <span style="color: #0000ff;">int</span> end, List&lt;String&gt;<span style="color: #000000;"> list) {
</span><span style="color: #008080;">20</span>             <span style="color: #0000ff;">this</span>.start =<span style="color: #000000;"> start;
</span><span style="color: #008080;">21</span>             <span style="color: #0000ff;">this</span>.end =<span style="color: #000000;"> end;
</span><span style="color: #008080;">22</span>             <span style="color: #0000ff;">this</span>.list =<span style="color: #000000;"> list;
</span><span style="color: #008080;">23</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">24</span> 
<span style="color: #008080;">25</span> <span style="color: #000000;">        @Override
</span><span style="color: #008080;">26</span>         <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> compute() {
</span><span style="color: #008080;">27</span> 
<span style="color: #008080;">28</span>             <span style="color: #0000ff;">if</span> ((end - start) &lt;=<span style="color: #000000;"> THRESHOLD) {
</span><span style="color: #008080;">29</span>                 <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = start; i &lt; end; i++<span style="color: #000000;">) {
</span><span style="color: #008080;">30</span>                     System.out.println(Thread.currentThread().getName() + ": " +<span style="color: #000000;"> list.get(i));
</span><span style="color: #008080;">31</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">32</span>             }<span style="color: #0000ff;">else</span><span style="color: #000000;"> {
</span><span style="color: #008080;">33</span>                 <span style="color: #0000ff;">int</span> middle = (start + end) / 2<span style="color: #000000;">;
</span><span style="color: #008080;">34</span>                 invokeAll(<span style="color: #0000ff;">new</span> SendMsgTask(start, middle, list), <span style="color: #0000ff;">new</span><span style="color: #000000;"> SendMsgTask(middle, end, list));
</span><span style="color: #008080;">35</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">36</span> 
<span style="color: #008080;">37</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">38</span> 
<span style="color: #008080;">39</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">40</span> 
<span style="color: #008080;">41</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> main(String[] args) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> InterruptedException {
</span><span style="color: #008080;">42</span>         List&lt;String&gt; list = <span style="color: #0000ff;">new</span> ArrayList&lt;&gt;<span style="color: #000000;">();
</span><span style="color: #008080;">43</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 0; i &lt; 123; i++<span style="color: #000000;">) {
</span><span style="color: #008080;">44</span>             list.add(String.valueOf(i+1<span style="color: #000000;">));
</span><span style="color: #008080;">45</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">46</span> 
<span style="color: #008080;">47</span>         ForkJoinPool pool = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ForkJoinPool();
</span><span style="color: #008080;">48</span>         pool.submit(<span style="color: #0000ff;">new</span> ForkJoinPoolDemo().<span style="color: #0000ff;">new</span> SendMsgTask(0<span style="color: #000000;">, list.size(), list));
</span><span style="color: #008080;">49</span>         pool.awaitTermination(10<span style="color: #000000;">, TimeUnit.SECONDS);
</span><span style="color: #008080;">50</span> <span style="color: #000000;">        pool.shutdown();
</span><span style="color: #008080;">51</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">52</span> 
<span style="color: #008080;">53</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 15px;">求和</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.cjs.boot.demo;
</span><span style="color: #008080;"> 2</span> 
<span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.ExecutionException;
</span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.ForkJoinPool;
</span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.ForkJoinTask;
</span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.RecursiveTask;
</span><span style="color: #008080;"> 7</span> 
<span style="color: #008080;"> 8</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> ForkJoinTaskDemo {
</span><span style="color: #008080;"> 9</span> 
<span style="color: #008080;">10</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">class</span> SumTask <span style="color: #0000ff;">extends</span> RecursiveTask&lt;Integer&gt;<span style="color: #000000;"> {
</span><span style="color: #008080;">11</span> 
<span style="color: #008080;">12</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> THRESHOLD = 20<span style="color: #000000;">;
</span><span style="color: #008080;">13</span> 
<span style="color: #008080;">14</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> arr[];
</span><span style="color: #008080;">15</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> start;
</span><span style="color: #008080;">16</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> end;
</span><span style="color: #008080;">17</span> 
<span style="color: #008080;">18</span>         <span style="color: #0000ff;">public</span> SumTask(<span style="color: #0000ff;">int</span>[] arr, <span style="color: #0000ff;">int</span> start, <span style="color: #0000ff;">int</span><span style="color: #000000;"> end) {
</span><span style="color: #008080;">19</span>             <span style="color: #0000ff;">this</span>.arr =<span style="color: #000000;"> arr;
</span><span style="color: #008080;">20</span>             <span style="color: #0000ff;">this</span>.start =<span style="color: #000000;"> start;
</span><span style="color: #008080;">21</span>             <span style="color: #0000ff;">this</span>.end =<span style="color: #000000;"> end;
</span><span style="color: #008080;">22</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">23</span> 
<span style="color: #008080;">24</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;">25</span> <span style="color: #008000;">         * 小计
</span><span style="color: #008080;">26</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;">27</span>         <span style="color: #0000ff;">private</span><span style="color: #000000;"> Integer subtotal() {
</span><span style="color: #008080;">28</span>             Integer sum = 0<span style="color: #000000;">;
</span><span style="color: #008080;">29</span>             <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = start; i &lt; end; i++<span style="color: #000000;">) {
</span><span style="color: #008080;">30</span>                 sum +=<span style="color: #000000;"> arr[i];
</span><span style="color: #008080;">31</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">32</span>             System.out.println(Thread.currentThread().getName() + ": ∑(" + start + "~" + end + ")=" +<span style="color: #000000;"> sum);
</span><span style="color: #008080;">33</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> sum;
</span><span style="color: #008080;">34</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">35</span> 
<span style="color: #008080;">36</span> <span style="color: #000000;">        @Override
</span><span style="color: #008080;">37</span>         <span style="color: #0000ff;">protected</span><span style="color: #000000;"> Integer compute() {
</span><span style="color: #008080;">38</span> 
<span style="color: #008080;">39</span>             <span style="color: #0000ff;">if</span> ((end - start) &lt;=<span style="color: #000000;"> THRESHOLD) {
</span><span style="color: #008080;">40</span>                 <span style="color: #0000ff;">return</span><span style="color: #000000;"> subtotal();
</span><span style="color: #008080;">41</span>             }<span style="color: #0000ff;">else</span><span style="color: #000000;"> {
</span><span style="color: #008080;">42</span>                 <span style="color: #0000ff;">int</span> middle = (start + end) / 2<span style="color: #000000;">;
</span><span style="color: #008080;">43</span>                 SumTask left = <span style="color: #0000ff;">new</span><span style="color: #000000;"> SumTask(arr, start, middle);
</span><span style="color: #008080;">44</span>                 SumTask right = <span style="color: #0000ff;">new</span><span style="color: #000000;"> SumTask(arr, middle, end);
</span><span style="color: #008080;">45</span> <span style="color: #000000;">                left.fork();
</span><span style="color: #008080;">46</span> <span style="color: #000000;">                right.fork();
</span><span style="color: #008080;">47</span> 
<span style="color: #008080;">48</span>                 <span style="color: #0000ff;">return</span> left.join() +<span style="color: #000000;"> right.join();
</span><span style="color: #008080;">49</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">50</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">51</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">52</span> 
<span style="color: #008080;">53</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> main(String[] args) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> ExecutionException, InterruptedException {
</span><span style="color: #008080;">54</span>         <span style="color: #0000ff;">int</span>[] arr = <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">int</span>[100<span style="color: #000000;">];
</span><span style="color: #008080;">55</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 0; i &lt; 100; i++<span style="color: #000000;">) {
</span><span style="color: #008080;">56</span>             arr[i] = i + 1<span style="color: #000000;">;
</span><span style="color: #008080;">57</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">58</span> 
<span style="color: #008080;">59</span>         ForkJoinPool pool = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ForkJoinPool();
</span><span style="color: #008080;">60</span>         ForkJoinTask&lt;Integer&gt; result = pool.submit(<span style="color: #0000ff;">new</span> ForkJoinTaskDemo().<span style="color: #0000ff;">new</span> SumTask(arr, 0<span style="color: #000000;">, arr.length));
</span><span style="color: #008080;">61</span>         System.out.println("最终计算结果: " +<span style="color: #000000;"> result.invoke());
</span><span style="color: #008080;">62</span> <span style="color: #000000;">        pool.shutdown();
</span><span style="color: #008080;">63</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">64</span> 
<span style="color: #008080;">65</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre>ForkJoinPool.commonPool-worker-2: ∑(50~62)=678<span style="color: #000000;">
ForkJoinPool.commonPool</span>-worker-2: ∑(62~75)=897<span style="color: #000000;">
ForkJoinPool.commonPool</span>-worker-2: ∑(75~87)=978<span style="color: #000000;">
ForkJoinPool.commonPool</span>-worker-2: ∑(87~100)=1222<span style="color: #000000;">
ForkJoinPool</span>-1-worker-1: ∑(0~12)=78<span style="color: #000000;">
ForkJoinPool</span>-1-worker-1: ∑(12~25)=247<span style="color: #000000;">
ForkJoinPool</span>-1-worker-1: ∑(25~37)=378<span style="color: #000000;">
ForkJoinPool</span>-1-worker-1: ∑(37~50)=572<span style="color: #000000;">
ForkJoinPool</span>-1-worker-2: ∑(75~87)=978<span style="color: #000000;">
ForkJoinPool</span>-1-worker-3: ∑(50~62)=678<span style="color: #000000;">
ForkJoinPool</span>-1-worker-5: ∑(62~75)=897<span style="color: #000000;">
ForkJoinPool.commonPool</span>-worker-7: ∑(0~12)=78<span style="color: #000000;">
ForkJoinPool.commonPool</span>-worker-3: ∑(37~50)=572<span style="color: #000000;">
ForkJoinPool</span>-1-worker-4: ∑(87~100)=1222<span style="color: #000000;">
ForkJoinPool.commonPool</span>-worker-2: ∑(25~37)=378<span style="color: #000000;">
ForkJoinPool.commonPool</span>-worker-5: ∑(12~25)=247<span style="color: #000000;">
最终计算结果: </span>5050</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 15px;">api文档中的两个示例</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.cjs.boot.demo;
</span><span style="color: #008080;"> 2</span> 
<span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Arrays;
</span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span> java.util.concurrent.*<span style="color: #000000;">;
</span><span style="color: #008080;"> 5</span> 
<span style="color: #008080;"> 6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> RecursiveActionDemo {
</span><span style="color: #008080;"> 7</span> 
<span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">class</span> SortTask <span style="color: #0000ff;">extends</span><span style="color: #000000;"> RecursiveAction {
</span><span style="color: #008080;"> 9</span> 
<span style="color: #008080;">10</span>         <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> THRESHOLD = 100<span style="color: #000000;">;
</span><span style="color: #008080;">11</span> 
<span style="color: #008080;">12</span>         <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">long</span><span style="color: #000000;">[] array;
</span><span style="color: #008080;">13</span>         <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> lo, hi;
</span><span style="color: #008080;">14</span> 
<span style="color: #008080;">15</span>         <span style="color: #0000ff;">public</span> SortTask(<span style="color: #0000ff;">long</span>[] array, <span style="color: #0000ff;">int</span> lo, <span style="color: #0000ff;">int</span><span style="color: #000000;"> hi) {
</span><span style="color: #008080;">16</span>             <span style="color: #0000ff;">this</span>.array =<span style="color: #000000;"> array;
</span><span style="color: #008080;">17</span>             <span style="color: #0000ff;">this</span>.lo =<span style="color: #000000;"> lo;
</span><span style="color: #008080;">18</span>             <span style="color: #0000ff;">this</span>.hi =<span style="color: #000000;"> hi;
</span><span style="color: #008080;">19</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">20</span> 
<span style="color: #008080;">21</span>         <span style="color: #0000ff;">public</span> SortTask(<span style="color: #0000ff;">long</span><span style="color: #000000;">[] array) {
</span><span style="color: #008080;">22</span>             <span style="color: #0000ff;">this</span>(array, 0<span style="color: #000000;">, array.length);
</span><span style="color: #008080;">23</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">24</span> 
<span style="color: #008080;">25</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> sortSequentially(<span style="color: #0000ff;">int</span> lo, <span style="color: #0000ff;">int</span><span style="color: #000000;"> hi) {
</span><span style="color: #008080;">26</span> <span style="color: #000000;">            Arrays.sort(array, lo, hi);
</span><span style="color: #008080;">27</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">28</span> 
<span style="color: #008080;">29</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> merge(<span style="color: #0000ff;">int</span> lo, <span style="color: #0000ff;">int</span> mid, <span style="color: #0000ff;">int</span><span style="color: #000000;"> hi) {
</span><span style="color: #008080;">30</span>             <span style="color: #0000ff;">long</span>[] buf =<span style="color: #000000;"> Arrays.copyOfRange(array, lo, mid);
</span><span style="color: #008080;">31</span>             <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 0, j = lo, k = mid; i &lt; buf.length; j++<span style="color: #000000;">) {
</span><span style="color: #008080;">32</span>                 array[j] = (k == hi || buf[i] &lt; array[k]) ? buf[i++] : array[k++<span style="color: #000000;">];
</span><span style="color: #008080;">33</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">34</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">35</span> 
<span style="color: #008080;">36</span> <span style="color: #000000;">        @Override
</span><span style="color: #008080;">37</span>         <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> compute() {
</span><span style="color: #008080;">38</span>             <span style="color: #0000ff;">if</span> (hi - lo &lt;<span style="color: #000000;"> THRESHOLD) {
</span><span style="color: #008080;">39</span> <span style="color: #000000;">                sortSequentially(lo, hi);
</span><span style="color: #008080;">40</span>             }<span style="color: #0000ff;">else</span><span style="color: #000000;"> {
</span><span style="color: #008080;">41</span>                 <span style="color: #0000ff;">int</span> mid = (lo + hi) &gt;&gt;&gt; 1<span style="color: #000000;">;
</span><span style="color: #008080;">42</span>                 invokeAll(<span style="color: #0000ff;">new</span> SortTask(array, lo, mid), <span style="color: #0000ff;">new</span><span style="color: #000000;"> SortTask(array, mid, hi));
</span><span style="color: #008080;">43</span> <span style="color: #000000;">                merge(lo, mid, hi);
</span><span style="color: #008080;">44</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">45</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">46</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">47</span> 
<span style="color: #008080;">48</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> main(String[] args) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> ExecutionException, InterruptedException {
</span><span style="color: #008080;">49</span>         <span style="color: #0000ff;">long</span>[] array = <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">long</span>[120<span style="color: #000000;">];
</span><span style="color: #008080;">50</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 0; i &lt; array.length; i++<span style="color: #000000;">) {
</span><span style="color: #008080;">51</span>             array[i] = (<span style="color: #0000ff;">long</span>) (Math.random() * 1000<span style="color: #000000;">);
</span><span style="color: #008080;">52</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">53</span> <span style="color: #000000;">        System.out.println(Arrays.toString(array));
</span><span style="color: #008080;">54</span> 
<span style="color: #008080;">55</span>         ForkJoinPool pool = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ForkJoinPool();
</span><span style="color: #008080;">56</span>         pool.submit(<span style="color: #0000ff;">new</span><span style="color: #000000;"> SortTask(array));
</span><span style="color: #008080;">57</span>         pool.awaitTermination(5<span style="color: #000000;">, TimeUnit.SECONDS);
</span><span style="color: #008080;">58</span> <span style="color: #000000;">        pool.shutdown();
</span><span style="color: #008080;">59</span> 
<span style="color: #008080;">60</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">61</span> 
<span style="color: #008080;">62</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.cjs.boot.demo;
</span><span style="color: #008080;"> 2</span> 
<span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span> java.util.concurrent.*<span style="color: #000000;">;
</span><span style="color: #008080;"> 4</span> 
<span style="color: #008080;"> 5</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> RecursiveTaskDemo {
</span><span style="color: #008080;"> 6</span> 
<span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">class</span> Fibonacci <span style="color: #0000ff;">extends</span> RecursiveTask&lt;Integer&gt;<span style="color: #000000;"> {
</span><span style="color: #008080;"> 8</span> 
<span style="color: #008080;"> 9</span>         <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> n;
</span><span style="color: #008080;">10</span> 
<span style="color: #008080;">11</span>         <span style="color: #0000ff;">public</span> Fibonacci(<span style="color: #0000ff;">int</span><span style="color: #000000;"> n) {
</span><span style="color: #008080;">12</span>             <span style="color: #0000ff;">this</span>.n =<span style="color: #000000;"> n;
</span><span style="color: #008080;">13</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">14</span> 
<span style="color: #008080;">15</span> <span style="color: #000000;">        @Override
</span><span style="color: #008080;">16</span>         <span style="color: #0000ff;">protected</span><span style="color: #000000;"> Integer compute() {
</span><span style="color: #008080;">17</span>             <span style="color: #0000ff;">if</span> (n &lt;= 1<span style="color: #000000;">) {
</span><span style="color: #008080;">18</span>                 <span style="color: #0000ff;">return</span><span style="color: #000000;"> n;
</span><span style="color: #008080;">19</span>             }<span style="color: #0000ff;">else</span><span style="color: #000000;"> {
</span><span style="color: #008080;">20</span>                 Fibonacci f1 = <span style="color: #0000ff;">new</span> Fibonacci(n - 1<span style="color: #000000;">);
</span><span style="color: #008080;">21</span> <span style="color: #000000;">                f1.fork();
</span><span style="color: #008080;">22</span>                 Fibonacci f2 = <span style="color: #0000ff;">new</span> Fibonacci(n - 1<span style="color: #000000;">);
</span><span style="color: #008080;">23</span>                 <span style="color: #0000ff;">return</span> f2.compute() +<span style="color: #000000;"> f1.join();
</span><span style="color: #008080;">24</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">25</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">26</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">27</span> 
<span style="color: #008080;">28</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> main(String[] args) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> InterruptedException, ExecutionException {
</span><span style="color: #008080;">29</span>         ForkJoinPool pool = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ForkJoinPool();
</span><span style="color: #008080;">30</span>         Future&lt;Integer&gt; future = pool.submit(<span style="color: #0000ff;">new</span> Fibonacci(10<span style="color: #000000;">));
</span><span style="color: #008080;">31</span> <span style="color: #000000;">        System.out.println(future.get());
</span><span style="color: #008080;">32</span> <span style="color: #000000;">        pool.shutdown();
</span><span style="color: #008080;">33</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">34</span> 
<span style="color: #008080;">35</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>&nbsp;</p>
<h2>参考</h2>
<p><span style="font-size: 16px;">http://gee.cs.oswego.edu/dl/papers/fj.pdf</span></p>
<p><span style="font-size: 16px;">http://ifeve.com/talk-concurrency-forkjoin/</span></p>
<p><span style="font-size: 16px;">https://www.cnblogs.com/senlinyang/p/7885964.html</span></p>
<p><span style="font-size: 16px;">https://blog.csdn.net/u012403290/article/details/70917810</span></p>
<p>&nbsp;</p><br><div style="display: block; border-top: 2px solid rgb(204, 204, 204); padding-top: 20px;"><div style="border: 1px dashed rgb(45, 161, 45);padding: 10px 15px;background-color: rgb(248, 248, 248);line-height: 1.6;word-spacing: 2px;letter-spacing: 2px;"><label style="font-weight: bold">感谢您的阅读，如果您觉得阅读本文对您有帮助，请点一下<a id="recommend" style="font-weight: bold; color: red; font-size: 15px;">“推荐”</a>按钮，您的<label style="font-weight: bold; color: red; font-size: 15px">“推荐”</label>将是我最大的写作动力！</label><br>欢迎各位转载，但必须在文章页面中给出作者和原文链接！</div></div></div><div id="MySignature"></div>
<div class="clear"></div>
<div id="blog_post_info_block">
<div id="BlogPostCategory">分类: <a href="https://www.cnblogs.com/cjsblog/category/1143248.html" target="_blank">Java</a></div>
<div id="EntryTag">标签: <a href="https://www.cnblogs.com/cjsblog/tag/ForkJoin/">ForkJoin</a></div>
<div id="blog_post_info"><div id="green_channel">
        <a href="javascript:void(0);" id="green_channel_digg" onclick="DiggIt(9078341,cb_blogId,1);green_channel_success(this,'谢谢推荐！');">好文要顶</a>
            <a id="green_channel_follow" onclick="follow('bcbc924f-71b4-e511-9fc1-ac853d9f53cc');" href="javascript:void(0);">关注我</a>
    <a id="green_channel_favorite" onclick="AddToWz(cb_entryId);return false;" href="javascript:void(0);">收藏该文</a>
    <a id="green_channel_weibo" href="javascript:void(0);" title="分享至新浪微博" onclick="ShareToTsina()"><img src="//common.cnblogs.com/images/icon_weibo_24.png" alt=""></a>
    <a id="green_channel_wechat" href="javascript:void(0);" title="分享至微信" onclick="shareOnWechat()"><img src="//common.cnblogs.com/images/wechat.png" alt=""></a>
</div>
<div id="author_profile">
    <div id="author_profile_info" class="author_profile_info">
            <a href="https://home.cnblogs.com/u/cjsblog/" target="_blank"><img src="//pic.cnblogs.com/face/874963/20180223192858.png" class="author_avatar" alt=""></a>
        <div id="author_profile_detail" class="author_profile_info">
            <a href="https://home.cnblogs.com/u/cjsblog/">废物大师兄</a><br>
            <a href="https://home.cnblogs.com/u/cjsblog/followees">关注 - 6</a><br>
            <a href="https://home.cnblogs.com/u/cjsblog/followers">粉丝 - 435</a>
        </div>
    </div>
    <div class="clear"></div>
    <div id="author_profile_honor"></div>
    <div id="author_profile_follow">
                <a href="javascript:void(0);" onclick="follow('bcbc924f-71b4-e511-9fc1-ac853d9f53cc');return false;">+加关注</a>
    </div>
</div>
<div id="div_digg">
    <div class="diggit" onclick="votePost(9078341,'Digg')">
        <span class="diggnum" id="digg_count">12</span>
    </div>
    <div class="buryit" onclick="votePost(9078341,'Bury')">
        <span class="burynum" id="bury_count">0</span>
    </div>
    <div class="clear"></div>
    <div class="diggword" id="digg_tips">
    </div>
</div>
<script type="text/javascript">
    currentDiggType = 0;
</script></div>
<div class="clear"></div>
<div id="post_next_prev"><a href="https://www.cnblogs.com/cjsblog/p/9068886.html" class="p_n_p_prefix">« </a> 上一篇：<a href="https://www.cnblogs.com/cjsblog/p/9068886.html" title="发布于2018-05-21 23:02">如何合理地估算线程池大小？（转载）</a><br><a href="https://www.cnblogs.com/cjsblog/p/9103485.html" class="p_n_p_prefix">» </a> 下一篇：<a href="https://www.cnblogs.com/cjsblog/p/9103485.html" title="发布于2018-05-29 17:17">面向切面编程 ( Aspect Oriented Programming with Spring )</a><br></div>
</div>


</div>
<div class="postDesc">posted @ <span id="post-date">2018-05-23 18:22</span> <a href="https://www.cnblogs.com/cjsblog/">废物大师兄</a> 阅读(<span id="post_view_count">7941</span>) 评论(<span id="post_comment_count">0</span>)  <a href="https://i.cnblogs.com/EditPosts.aspx?postid=9078341" rel="nofollow">编辑</a> <a href="#" onclick="AddToWz(9078341);return false;">收藏</a></div>
</div>